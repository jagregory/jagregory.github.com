
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>James Gregory</title>
    <meta name="author" content="James Gregory">

    
    <meta name="description" content="Rails Production 500 Error Page Showing in Dev We&#8217;re sorry, but something went wrong! I&#8217;ve been seeing some strange behaviour on the &hellip;">
    
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

    <link href="/atom.xml" rel="alternate" title="James Gregory" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.png" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3186192-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<header class="inner"><h1 class="left"><a href="/">James Gregory</a></h1>
<nav class="menu left"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<div class="right">
	<form class="search right" action="http://google.com/search" method="get">
		<input class="left" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:www.jagregory.com">
	</form>
	<div class="social right">
		
		
		
		
		<a class="github" href="https://github.com/jagregory" title="GitHub">GitHub</a>
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</div>

</header>
	
	<div id="content" class="inner">


    <article class="post">
    <h1 class="title"><a href="/writings/rails-500-error-showing-in-dev/">Rails Production 500 Error Page Showing in Dev</a></h1>
    <div class="entry">
        <blockquote><p>We&#8217;re sorry, but something went wrong!</p></blockquote>

<p>I&#8217;ve been seeing some strange behaviour on the development environment for <a href="http://www.getonthegame.com.au">On the Game</a> recently. I&#8217;ve just spent an hour combing through every line of code that varies from a standard Rails app, and I&#8217;ve finally found the issue. I&#8217;m putting it here for posterity.</p>

<p>Regardless of my configuration, Rails was always displaying the production page for 500 errors (<code>public/500.html</code>) even in development mode.</p>

<p>I poked around for a while and eventually found it to be this:</p>

<p>I&#8217;d redefined <code>Enumerable#sum</code> somewhere (don&#8217;t ask!), and my implementation didn&#8217;t handle arrays of strings. That&#8217;s it, that&#8217;s why the detailed error page wasn&#8217;t being shown in development.</p>

<p>Ends up, <code>Enumerable#sum</code> is used by the development error page, and when something on that error page itself raises an error Rails will just fall back and show the 500.html and not log anything.</p>

<p>Moral of the story: If you&#8217;re seeing this behaviour, check you haven&#8217;t (badly) monkey patched something that the error page is using.</p>

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2012-07-05T00:00:00+10:00" pubdate data-updated="true">Jul 5<span>th</span>, 2012</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/learning-it-aint-hard">Learning. It Ain&#8217;t Hard.</a></h1>
    <div class="entry">
        <p>&#8220;I don&#8217;t have enough free time to learn a new language!&#8221;, or tool, or framework, etc. I hear this often. I appreciate we all handle things differently, but here&#8217;s my take on it.</p>

<p>I remember years ago, some friends and I were talking about money and our savings accounts. They were flabbergasted at how I, a 19 year old at the time, were able to have nearly £10,000 saved (sadly which I&#8217;ve since spent!). I explained that it&#8217;s easy to save money if you do it slowly and consistently. £50 a week over the course of three years adds up. Obvious, right?</p>

<p>You don&#8217;t sit down and decide &#8220;I&#8217;m going to save £10,000&#8221; and then promptly spend one month working yourself to death to put away the whole amount in one go. It&#8217;d be nice to have the option to do that occasionally, but that&#8217;s not how most of us work. The same applies to learning.</p>

<p>You don&#8217;t need to read a 300 page book to learn something. Read a blog post (or an article, mailing list thread, commit discussion). One. Pick a subject and read a single article on it. Do this once a week, every week. That&#8217;s it, that&#8217;s my secret to learning.</p>

<p>Knowledge isn&#8217;t a substitute for experience, but it&#8217;ll certainly get you a lot further down the road, faster, than you would get without it.</p>

<p>Take Ruby as the typical example. Ruby on Rails has been around for 6 years now (and Ruby for nearly 15, but not visibly), if you&#8217;d have read one article on Ruby a week, you&#8217;d have read 312 by now. Three hundred and twelve. Combine that with the occasional Sunday afternoon playing around and I&#8217;m confident you&#8217;d be pretty proficient by now.</p>

<ul>
<li>Javascript is around 15 years old.</li>
<li>Haskell, 20 years.</li>
<li>Erlang, 25 years.</li>
<li>Python, 20 years.</li>
<li>Clojure, 4 years. Scheme? 36 years.</li>
</ul>

<p>Of course, we&#8217;ve not all been trying to learn those languages for as long as they&#8217;ve existed. Consider this though, in one year you could be proficient in a new language if you commit to just 15 minutes a week, or you could be in exactly the same place you are now still unable to find time to learn anything.</p>

<p>How do you eat an elephant? <em>One bite at a time.</em></p>

<h2 id="addendum_but_everything_moves_so_fast">Addendum: but everything moves so fast!</h2>

<p>No, it doesn&#8217;t. It just feels like that from the inside.</p>

<p>Learn something fundamental and your knowledge will transcend trends. Learning a new language is a great way to do that whilst also feeling cool and trendy. Ruby or Python will help you understand dynamic languages, Scala will make you appreciate how powerful and unobtrusive static languages can be, and Clojure will introduce the code-as-data mindset. All those things will be useful beyond the scope of the language you&#8217;re learning.</p>

<p><em>Stealth edit: Fixed my amazing saving ability.</em></p>

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2011-07-06T00:00:00+10:00" pubdate data-updated="true">Jul 6<span>th</span>, 2011</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/rhino-licensing/">Rhino Licensing</a></h1>
    <div class="entry">
        <blockquote><p>As one of the last things on my to-do list for <a href="http://inca-app.com">Inca</a>, licensing has been delayed and delayed; finally, with me making the announcement on Twitter the other day I felt I should probably get it sorted. I was going to write a nice long post about my thoughts on anti-piracy measures, but the <a href="http://blogs.balsamiq.com/product//2008/10/19/my-views-on-software-piracy/">Balsamiq team have already done it nicely</a>.</p>

<p>Instead, here&#8217;s a guide to using <a href="https://github.com/ayende/rhino-licensing">Rhino Licensing</a>. Your mileage may vary.</p></blockquote>

<p><a href="https://github.com/ayende/rhino-licensing">Rhino Licensing</a> is an open-source licensing framework by <a href="http://ayende.com">Ayende Rahien</a>, and it grew out of his frustration with other license providers while creating <a href="http://nhprof.com/">NHibernate Profiler</a>.</p></p>

<p>Rhino Licensing uses asymmetric encryption&#8211;also known as <a href="http://en.wikipedia.org/wiki/Public-key_cryptography">public-key cryptography</a>&#8211;specifically the <a href="http://en.wikipedia.org/wiki/RSA">RSA algorithm</a>. In cryptography, asymmetric means there are two parts to each key, one public and one private. You encrypt a value using the one key, and it can only be decrypted using the other key. In the case of license key generation, we store our private key on the server (and never tell anyone it!), and distribute the public key with our application. When the user receives a license key, the application is able to verify that it came from us by using the public key. If someone tries to use a license key they&#8217;ve generated themselves, it wouldn&#8217;t work unless they had our exact private key.</p>

<blockquote><p>Other systems that use asymmetric encryption include <abbr title="Secure Shell">SSH</abbr>, <abbr title="Secure Sockets Layer">SSL</abbr>, <abbr title="Pretty Good Privacy">PGP</abbr>, and among others, Git uses asymmetric encryption for its security due to it using SSH.</p></blockquote>

<p>The format of the license that Rhino Licensing generates is an XML document, plain and simple. By default, it includes the user&#8217;s name, an expiration date, the type of license (trial, standard, floating, etc&#8230;), and most importantly the cryptographic signature. Below is an example Rhino Licensing generated license.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;license</span> <span class="na">id=</span><span class="s">&quot;ae4c05b5-c188-47f8-852f-b4e5375621f7&quot;</span>
</span><span class='line'>    <span class="na">expiration=</span><span class="s">&quot;2011-01-01T00:00:00.0000000&quot;</span> <span class="na">type=</span><span class="s">&quot;Standard&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;name&gt;</span>Bilbo<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>  <span class="nt">&lt;Signature</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;SignedInfo&gt;</span>
</span><span class='line'>      <span class="nt">&lt;CanonicalizationMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/TR/2001/REC-xml-c14n-20010315&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;SignatureMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&lt;Reference</span> <span class="na">URI=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Transforms&gt;</span>
</span><span class='line'>          <span class="nt">&lt;Transform</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Transforms&gt;</span>
</span><span class='line'>        <span class="nt">&lt;DigestMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;DigestValue&gt;</span>sKDT7gzgedzmh1AMxxLbfcF1Hsw=<span class="nt">&lt;/DigestValue&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/Reference&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/SignedInfo&gt;</span>
</span><span class='line'>    <span class="nt">&lt;SignatureValue&gt;</span>
</span><span class='line'>        SfkvCGv1+EdLTvaROv27ymDumS0y02fPANTVhr0Yxd/
</span><span class='line'>        AxxVH0q0BQ6w8Ou5L7gyLYLvnSckgjhrGnGpiifdvbg==
</span><span class='line'>    <span class="nt">&lt;/SignatureValue&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/Signature&gt;</span>
</span><span class='line'><span class="nt">&lt;/license&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><h2>What&#8217;s a signature?</h2>

<p>A cryptographic signature is a string of bytes used to aid in verification of the source of a document. In most cases&#8211;and in the case of Rhino Licensing&#8211;the signature is generated by hashing the content of the file using SHA1 (or another suitable hashing algorithm), and encrypting that hash using the private key. The resulting string of bytes is the signature.</p>

<p>When the client receives a file with a signature, it creates a hash of the file (sans-signature) and compares that hash to the decrypted value of the signature. Baring in mind that the signature is an encrypted hash of the file, if either of the public or private keys were invalid or the file had been tampered with, then the decrypted string would not match the hash of the file. When the client generated hash and the decrypted signature match, you can be confident the sender of the message is who you think it is.</p></blockquote>

<p>The great part about using the hash of the document as the signature is that if the user tampers with the license&#8211;such as changing the expiration date or the licensee name&#8211;the signature will no longer match the hash the client generates, and BAM, instant invalid license.</p>

<blockquote><p>One particular aspect I like with this approach is that the licensee name is clearly visible in the license. This simple act can be quite dissuasive when it comes to piracy; after all, who would want their name visible on all the torrent websites out there?</p></blockquote>

<p>Enough with the waffle, let&#8217;s start using Rhino Licensing.</p>

<h2>Create your key</h2>

<p>The first thing we need to do is generate a public/private key pair for us to use in our license generation. Rhino Licensing uses the RSACryptoServiceProvider for it&#8217;s keys, so we can use that ourselves to generate our keys. One of the simplest ways to do that is to knock up a really quick console application.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">class</span> <span class="nc">Program</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">rsa</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RSACryptoServiceProvider</span><span class="p">(</span><span class="m">1024</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">File</span><span class="p">.</span><span class="n">WriteAllText</span><span class="p">(</span><span class="s">&quot;publicKey.xml&quot;</span><span class="p">,</span> <span class="n">rsa</span><span class="p">.</span><span class="n">ToXmlString</span><span class="p">(</span><span class="k">false</span><span class="p">));</span>
</span><span class='line'>    <span class="n">File</span><span class="p">.</span><span class="n">WriteAllText</span><span class="p">(</span><span class="s">&quot;privateKey.xml&quot;</span><span class="p">,</span> <span class="n">rsa</span><span class="p">.</span><span class="n">ToXmlString</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Done&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That program will generate a new key for you and write out the public and private parts to two separate XML files (publicKey.xml and privateKey.xml). Keep these two files handy!</p>

<blockquote><p>You will probably want to change the <code>1024</code> value in the <code>RSACryptoServiceProvider</code> constructor to something larger. This is the size of the key that will be generated. The larger the better really, but larger numbers require longer to generate.</p></blockquote>

<h2>Update your application</h2>

<p>Now we&#8217;ll update your application to complain if it doesn&#8217;t have a license. In your entry-point for your application you need to assert the license. Before we do that, make sure you&#8217;ve got your public key handy from the previous step. Rhino Licensing needs the <em>content</em> of this file, so you can either embed it directly into a constant or as a resource. Secondly, it needs to know where to look for a license that the user will have been given.</p>

<p>Assuming a really simple app, here&#8217;s a Program.cs with Rhino Licensing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">class</span> <span class="nc">Program</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">publicKey</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">ReadAllText</span><span class="p">(</span><span class="s">&quot;publicKey.xml&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">new</span> <span class="nf">LicenseValidator</span><span class="p">(</span><span class="n">publicKey</span><span class="p">,</span> <span class="s">&quot;license.xml&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="n">AssertValidLicense</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the license.xml file doesn&#8217;t exist, or if it&#8217;s invalid, Rhino Licensing will throw an exception. Of course, as we haven&#8217;t generated a license yet we&#8217;ll get an exception. That&#8217;s the client done though, so we can move on to our final step now. Once we complete that step, you will be able to just drop a license.xml into the same directory as your application and everything will work as expected.</p>

<h2>Create the license generator</h2>

<p>We need something to actually generate a license for your users. If you were being all fancy you could do this as a web-service that gets integrated with your payment provider; however, for simplicity&#8217;s sake we&#8217;ll just create another console application that spits out a license.</p>

<p>Rhino Licensing has a few prerequisites for a license: A name, an id of the license, an expiration date, and a license type. You can also supply a dictionary of custom values, but we wont be using that in this example.</p>

<p>For a really simple license generator all you need is the above for each license, and the private key. We&#8217;ll wrap that up in a simple console app which&#8217;ll prompt for the required info:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">class</span> <span class="nc">Program</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">privateKey</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">ReadAllText</span><span class="p">(</span><span class="s">&quot;privateKey.xml&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">();</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">generator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LicenseGenerator</span><span class="p">(</span><span class="n">private_key</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;Name: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;Date: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">expirationDate</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;Type: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">LicenseType</span> <span class="n">licenseType</span> <span class="p">=</span> <span class="p">(</span><span class="n">LicenseType</span><span class="p">)</span><span class="n">Enum</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">LicenseType</span><span class="p">),</span> <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// generate the license</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">license</span> <span class="p">=</span> <span class="n">generator</span><span class="p">.</span><span class="n">Generate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">expirationDate</span><span class="p">,</span> <span class="n">licenseType</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">license</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it, you&#8217;ve got a license generator. Remember, this will exist behind your firewall, the users will (and must) never see your private key.</p>

<p>If you take the output of this application and save it in a license.xml file in your client, your application should stop throwing license exceptions and run normally! You&#8217;ve officially just licensed your app.</p>

<h2>What have we just done?</h2>

<ul>
<li>Created a private key generator, purely for convenience than anything else. We should only need to run this once before we start generating our keys. You could run it once per major release to ensure your 1.0 licenses are never compatible with 2.0.</li>
<li>Updated our client application to validate the presence and validity of a license (and to explode if there isn&#8217;t one).</li>
<li>Created a &#8220;server&#8221; to generate licenses for us. This is very primitive but could easily be adapted to a web server. You might want to look at the Rhino Licensing <a href="https://github.com/ayende/rhino-licensing/blob/master/Rhino.Licensing/LicensingService.cs">LicensingService</a> before you continue.</li>
</ul>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2011-01-11T00:00:00+11:00" pubdate data-updated="true">Jan 11<span>th</span>, 2011</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/ndc-2010/">NDC 2010</a></h1>
    <div class="entry">
        <a href="http://www.ndc2010.no">NDC 2010</a> was a huge success, if you ask me. This was largely down to the NDC team, who deserve all the praise they&#8217;re getting (and much more). Unlike conferences I&#8217;ve been to in the past, NDC was truely by the people, for the people. <a href="http://blog.scottbellware.com">Scott Bellware</a> put it much better than I could, with his <a href="http://blog.scottbellware.com/2010/06/praise-for-norwegian-developers.html">praise for Norwegian Developers</a> (and Kjersti Sandberg). Herself and the rest of the team were there because they wanted to be, not because they had to. The whole attitude surrounding this conference was one of learning, not plugging products or motives.

I could go into great detail about the individual aspects of the conference, but it&#8217;s much easier to say that there&#8217;s nothing I&#8217;d change.

If there&#8217;s one conference you should go to next year, make it NDC 2011.

<h2>My part in all this&#8230;</h2>

I presented on two topics at NDC; the first was an introduction to <a href="http://fluentnhibernate.org">Fluent NHibernate</a>, and the second an introduction and demo of <a href="http://git-scm.com">Git</a>. Fluent NHibernate was on the Thursday, and Git the Friday. It was a great experience speaking at an event of this size, and the number of people who seemed genuinely interested in what I had to say (by either turning up to my talks, or approaching me afterwards) was quite humbling. If you&#8217;re interested in seeing what I presented, the talks will be on the NDC website before too long.

<blockquote>The videos are becoming available at <a href="http://streaming.ndc2010.no">streaming.ndc2010.no</a>, but they&#8217;re suffering from bandwidth issues. If you do want to watch the videos, please stream them until the issues are resolved.</blockquote>

Due to me speaking, and also being woefully unprepared, I didn&#8217;t get to see as many talks as I would&#8217;ve liked &mdash; regardless of how well rehearsed and prepared my talks are, it seems I always end up rewriting them an hour before I go on &mdash; I did end up catching Lisa Crispin, Steve Strong, Eric Evans, Greg Young, Jon Skeet, Roy Osherove, Michael Feathers, Sebastian Lambla, and Mark Nijhof. I recommend you catch their talks online when they&#8217;re published. The quality of the talks at NDC have been significantly higher than I&#8217;ve seen elsewhere, and (more importantly) the technical level seems to be higher too; there was very few basic talks (a few introductions, mine included, but no pandering), but the majority were pretty in-depth. This is quite a contrast to the all-too-often &#8220;Microsoft technology of the week&#8221; presentations you can get at conferences.

Of course, a big part of any conference is what happens between (and after) the talks. Meeting other developers is a big part of why I go to these things, after all I don&#8217;t get out much normally. The socialising aspect of NDC was excellent, good drinks and food was had by all (I have a good idea they did anyway, at least one place we ate refused to serve us as a group anything other than the same meal for everyone!). I can&#8217;t possibly list everyone who I met while I was out there, but it was really good to meet up with some people who I&#8217;ve known on Twitter for a long time; specifically Hadi Hariri, Steve Strong, Greg Young, Ben Hall, Seb Lambla, Mark Nijhof, and Rob Conery are ones that stand out to me right now.

NDC 2011 will be next year, and it&#8217;s looking like it&#8217;ll be in May this time. If there&#8217;s anyone that&#8217;s on the fence about going, I would whole heartedly recommend you do. Even more so, I&#8217;d recommend you submit a talk of your own. It&#8217;s a great way to test yourself, if nothing else. I&#8217;ll definitely be going next year; hopefully I&#8217;ll speak again, but if not I&#8217;ll still be there. Hope to see you there!

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2010-06-22T00:00:00+10:00" pubdate data-updated="true">Jun 22<span>nd</span>, 2010</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/speaking-engagements-2010/">Speaking Engagements in 2010</a></h1>
    <div class="entry">
        In an attempt to get out of my shell more this year, I&#8217;ve taken up speaking (at conferences, not just in general). First came my <a href="http://jagregory.com/writings/git-e-van-recording/">Git E-VAN</a>, then came <a href="http://fiesta.lostechies.com/">Pablo&#8217;s Fiesta</a>, so what else have I got lined up this year?

<strong>24<sup>th</sup> April</strong>: <a href="http://codingday.org/">Irish Open Spaces Coding Day II</a> in Dublin, where I&#8217;ll be speaking about <a href="http://fluentnhibernate.org">Fluent NHibernate</a>.

<strong>16<sup>th</sup>-18<sup>th</sup> June</strong>: <a href="http://ndc2010.no" title="Norwegian Developers Conference 2010">NDC 2010</a> in Oslo, speaking about <a href="http://fluentnhibernate.org">Fluent NHibernate</a> and DVCS with Git.

The abstracts for my talks can be found below. If you&#8217;re interested in hearing me speak, or know of any opportunities that you think I might be interested in, please drop me an email (<a href="mailto:james@jagregory.com">james@jagregory.com</a>). You can see my availability on my <a href="http://www.google.com/calendar/embed?src=mtbk7g2u13e2j7s1u8p0flitho@group.calendar.google.com&ctz=Europe/London&gsessionid=GBDJzqgaRWqAze87fNda9Q">speaking calendar</a>.

<h3>Fluent NHibernate</h3>

An introduction and overview to object⁄relational mapping using Fluent NHibernate. See how Fluent NHibernate can help you map your domain with the least amount of effort, how you can remain flexible with your database, and how to drive your design through convention–over–configuration; all without writing a single line of XML.

The talk is an introduction to Fluent NHibernate for those that aren&#8217;t familiar with it, and assumes some NHibernate experience and is for .Net developers primarily. The goal is to show people how low–impact NHibernate can be with Fluent NHibernate, and how it can actually speed up development in rapid–change environments.

I&#8217;ll cover an overview of what Fluent NHibernate is, the various parts of it (the fluent interface, the conventions, and the auto–mappings, and the configuration aspect), then expand on how these features can be utilised to improve your NHibernate experience and simplify your development process.

<h3>Introduction to Git</h3>

An introduction to distributed version control using Git, and how your VCS should work with you and not against you. How DVCS can completely alter your development process, streamline it, and help you produce better software, faster. Covering how local repositories speed up your development, multiple authoritative sources, distributed teams, multiple workflows, and some of the more distinct features of Git. With experiences from an OSS team on how the migration from SVN to Git has helped the project and changed how the team works (Fluent NHibernate).

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2010-03-31T00:00:00+11:00" pubdate data-updated="true">Mar 31<span>st</span>, 2010</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/git-e-van-recording/">Git E-VAN Recording</a></h1>
    <div class="entry">
        <p>Last monday (8th of Feb) I did an <a href="http://jagregory.com/writings/git-e-van/">E-VAN on Git</a>; an introductory talk on Git and DVCS, covering pretty much everything you need to know for day-to-day Git life. I think it went down well, certainly didn&#8217;t <em>hear</em> anyone complaining.</p>

<p>The talk was recorded, so if you haven&#8217;t already seen it then you can do so at your own leisure.</p>

<p>The video is up on the <a href="http://vimeo.com/user1286822">E-VAN&#8217;s Vimeo account</a>, specifically <a href="http://vimeo.com/9324683" title="Git E-VAN recording">here</a>.</p>

<object width="600" height="450"><param name="allowfullscreen" value="true" /><param name="allowscriptaccess" value="always" /><param name="movie" value="http://vimeo.com/moogaloop.swf?clip_id=9324683&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=0&amp;show_portrait=0&amp;color=00ADEF&amp;fullscreen=1" /><embed src="http://vimeo.com/moogaloop.swf?clip_id=9324683&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=0&amp;show_portrait=0&amp;color=00ADEF&amp;fullscreen=1" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="600" height="450"></embed></object>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2010-02-17T00:00:00+11:00" pubdate data-updated="true">Feb 17<span>th</span>, 2010</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/git-e-van/">Git E-VAN</a></h1>
    <div class="entry">
        <p>Just a reminder that tonight I&#8217;ll be doing an <a href="http://europevan.blogspot.com/2010/01/next-european-van-on-08-february-2010.html">E-VAN on Git</a> tonight at 7pm GMT.</p>

<p>It&#8217;s going to be a pretty basic talk on what Git is (and indirectly what DVCS is), and a demo on how to use most of the features you&#8217;ll need daily. There might be some advanced talk at the end, depending on how well I time things.</p>

<p>If you&#8217;ve already used Git (successfully), then this talk won&#8217;t really be for you; unless you just want to listen to me ramble for an hour and an half.</p>

<p>Looking forward to &#8220;seeing&#8221; you there. Now, I best finish reading that &#8220;Getting started with Git&#8221; book I&#8217;ve had lying around for months.</p>

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2010-02-08T00:00:00+11:00" pubdate data-updated="true">Feb 8<span>th</span>, 2010</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/git-remotes-contributions-and-the-letter-n/">Git: Remotes, Contributions, and the Letter N</a></h1>
    <div class="entry">
        <p>Here&#8217;s a few ways to think about Git and it&#8217;s distributed nature.</p>

<ul>
<li>You deal with multiples of repositories, not a single central repository</li>
<li>Updates come from a remote repository, and changes are pushed to a remote; none of these repositories have to be the same</li>
<li><em>Origin</em> is the canonical name for the repository you cloned from</li>
<li><em>Upstream</em> is the canonical name for the original project repository you forked from</li>
</ul>




<h2>General pushing and pulling</h2>


<p><img src="/images/remote-1.png" alt="Figure 1" /></p>

<p>Pushing your changes to a remote: <code>git push remote_name</code></p>

<p><img src="/images/remote-2.png" alt="Figure 2" /></p>

<p>Pulling changes from a remote: <code>git pull remote_name</code></p>

<p>Or if you want to rebase:</p>

<pre>git fetch remote_name
git rebase remote_name/branch</pre>




<blockquote>You can change your <code>branch.autosetuprebase</code> to <code>always</code>, to make this the default <code>git pull</code> behaviour.</blockquote>


<p>That&#8217;s all there is to moving commits around in Git repositories. Any other operations you perform are all combinations of the above.</p>

<h2>Github &mdash; personal repositories</h2>


<p>When you&#8217;re dealing directly with Github, on a personal project or as the project owner, your repositories will look like this:</p>

<p><img src="/images/remote-3.png" alt="Figure 3" /></p>

<p>To push and pull changes between your local and your github repositories, just issue the push and pull commands with the origin remote:</p>

<pre>git push origin
git pull origin</pre>


<p>You can set the defaults for these commands too, so the origin isn&#8217;t even necessary in a lot of cases.</p>

<h2>Github &mdash; receiving contributions</h2>


<p>As a project owner, you&#8217;ll sometimes have to deal with contributions from other people. Each contributor will have their own github repository, and they&#8217;ll issue you with a pull request.</p>

<p><img src="/images/remote-4.png" alt="Figure 4" /></p>

<p>There&#8217;s no direct link to push between these two repositories; they&#8217;re unmanned. To manage changes from contributors, you need to involve your local repository.</p>

<p>You can think of this as taking the shape of a V.</p>

<p><img src="/images/remote-5.png" alt="Figure 5" /></p>

<p>You need to register their github repository as a remote on your local, pull in their changes, merge them, and push them up to your github. This can be done as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git remote add contributor contributor_repository.git
</span><span class='line'>git pull contributor branch
</span><span class='line'>git push</span></code></pre></td></tr></table></div></figure>




<h2>Github &mdash; providing contributions</h2>


<p>Do exactly as you would your own personal project. Local changes, pushed up to your github fork; then issue a pull request. That&#8217;s all there is to it.</p>

<h2>Github &mdash; the big picture</h2>


<p>Here&#8217;s how to imagine the whole process, think of it as an N shape.</p>

<p><img src="/images/remote-6.png" alt="Figure 6" /></p>

<p>On the left is the contributor, and the right is the project. Flow goes from bottom left, along the lines to the top right.</p>

<ol>
<li>Contributor makes a commit in their local repository</li>
<li>Contributor pushes that commit to their github</li>
<li>Contributor issues a pull request to the project</il>
<li>Project lead pulls the contributor&#8217;s change into their local repository</li>
<li>Project lead pushes the change up to the project github</li>
</ol>


<p>That&#8217;s as complicated as it gets.</p>

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2010-02-07T00:00:00+11:00" pubdate data-updated="true">Feb 7<span>th</span>, 2010</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/behaviours-in-mspec/">Behaviours in MSpec</a></h1>
    <div class="entry">
        <blockquote>Cross posted to <a href="http://www.lostechies.com/blogs/jagregory/archive/2010/01/18/behaviours-in-mspec.aspx">Los Techies</a></blockquote>




<p><a href="http://github.com/machine/machine.specifications">MSpec</a> is awesome, I think it&#8217;s praised by myself and others enough for that particular point to not need any expansion; however, there is a particular feature I would like to highlight that hasn&#8217;t really got a lot of press: behaviours.</p>




<p>Behaviours define reusable specs that encapsulate a particular set of, you guessed it, behaviours; you&#8217;re then able to include these specs in any context that exhibits a particular behaviour.</p>




<p>Lets go with the cliche&#8217;d Vehicle example. Given an <code>IVehicle</code> interface, with <code>Car</code> and <code>Motorbike</code> implementations; these all expose a <code>StartEngine</code> method and some properties reflecting the state of the vehicle. We&#8217;ll start the engine and verify that it is actually started, whether it&#8217;s got anything on the rev counter, and whether it&#8217;s killing our planet in the process (zing!).</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IVehicle</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">StartEngine</span><span class="p">();</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">IsEngineRunning</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">IsPolluting</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">RevCount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Car</span> <span class="p">:</span> <span class="n">IVehicle</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsEngineRunning</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">StartEngine</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// use your imagination...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Motorbike</span> <span class="p">:</span> <span class="n">IVehicle</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsEngineRunning</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">StartEngine</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// use your imagination...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Those are our classes, if rather contrived, but they&#8217;ll do. Now what we need to do is write some specs for them.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">when_a_car_is_started</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Establish</span> <span class="n">context</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Car</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Because</span> <span class="n">of</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">StartEngine</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_have_a_running_engine</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">IsEngineRunning</span><span class="p">.</span><span class="n">ShouldBeTrue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_be_polluting_the_atmosphere</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">IsPolluting</span><span class="p">.</span><span class="n">ShouldBeTrue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_be_idling</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">RevCount</span><span class="p">.</span><span class="n">ShouldBeBetween</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">static</span> <span class="n">Car</span> <span class="n">vehicle</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">when_a_motorbike_is_started</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Establish</span> <span class="n">context</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Motorbike</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Because</span> <span class="n">of</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">StartEngine</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_have_a_running_engine</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">IsEngineRunning</span><span class="p">.</span><span class="n">ShouldBeTrue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_have_a_running_engine</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">IsEngineRunning</span><span class="p">.</span><span class="n">ShouldBeTrue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_be_polluting_the_atmosphere</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">IsPolluting</span><span class="p">.</span><span class="n">ShouldBeTrue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_be_idling</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">RevCount</span><span class="p">.</span><span class="n">ShouldBeBetween</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">static</span> <span class="n">Motorbike</span> <span class="n">vehicle</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Those are our specs, there&#8217;s not much in there but already you can see that we&#8217;ve got duplication. Our two contexts contain identical specs, they&#8217;re the same in what they&#8217;re verifying, the only difference is the vehicle instance. This is where behaviours can come in handy.</p>




<p>With behaviours we can extract the specs and make them reusable. Lets do that.</p>




<p>Create a class for your behaviour and adorn it with the <code>Behaviors</code> attribute &mdash; this ensures MSpec recognises your class as a behaviour definition and not just any old class &mdash; then move your specs into it.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Behaviors]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">VehicleThatHasBeenStartedBehaviors</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">protected</span> <span class="k">static</span> <span class="n">IVehicle</span> <span class="n">vehicle</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_have_a_running_engine</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">IsEngineRunning</span><span class="p">.</span><span class="n">ShouldBeTrue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_have_a_running_engine</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">IsEngineRunning</span><span class="p">.</span><span class="n">ShouldBeTrue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_be_polluting_the_atmosphere</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">IsPolluting</span><span class="p">.</span><span class="n">ShouldBeTrue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">It</span> <span class="n">should_be_idling</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">RevCount</span><span class="p">.</span><span class="n">ShouldBeBetween</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>We&#8217;ve now got our specs in the behaviour, and have defined a field for the vehicle instance itself (it won&#8217;t compile otherwise). This is our behaviour complete, it defines a set of specifications that verify that a particular behaviour.</p>




<p>Lets hook that behaviour into our contexts from before:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">when_a_car_is_started</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Establish</span> <span class="n">context</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Car</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Because</span> <span class="n">of</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">StartEngine</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Behaves_like</span><span class="p">&lt;</span><span class="n">VehicleThatHasBeenStartedBehaviors</span><span class="p">&gt;</span> <span class="n">a_started_vehicle</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">protected</span> <span class="k">static</span> <span class="n">Car</span> <span class="n">vehicle</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">when_a_motorbike_is_started</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Establish</span> <span class="n">context</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Motorbike</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Because</span> <span class="n">of</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">vehicle</span><span class="p">.</span><span class="n">StartEngine</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Behaves_like</span><span class="p">&lt;</span><span class="n">VehicleThatHasBeenStartedBehaviors</span><span class="p">&gt;</span> <span class="n">a_started_vehicle</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">protected</span> <span class="k">static</span> <span class="n">Motorbike</span> <span class="n">vehicle</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>We&#8217;ve now put to use the <code>Behaves_like</code> feature, which references our behaviour class and imports the specs into the current context. Now when you run your specs, the specs from our behaviour are imported and run in each context. We don&#8217;t need to assign anything to that field, just defining it is enough; the name you choose for the field is what&#8217;s used by MSpec as the description for what your class is behaving like. In our case this is translated roughly to <em>&#8220;when a motorbike is started it behaves like a started vehicle&#8221;</em>.</p>




<p>There are a couple of things you need to be aware of to get this to work: your fields must be <code>protected</code>, both in the behaviour and the contexts; and the fields must have identical names. If you don&#8217;t get these two correct your behaviour won&#8217;t be hooked up properly. It&#8217;s also good to know that the fields <strong>do not</strong> need to have the same type, as long as the value from your context is assignable to the field in the behaviour then you&#8217;re good; this is key to defining reusable specs for classes that share a sub-set of functionality.</p>




<p>In short, behaviours are an excellent way of creating reusable specs for shared functionality, without the need to create complex inheritance structures. It&#8217;s not a feature you should use lightly, as it can greatly reduce the readability of your specs, but it is a good feature if you&#8217;ve got a budding spec explosion nightmare on your hands.</p>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2010-01-22T00:00:00+11:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2010</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/gits-guts-merging-and-rebasing/">Git&#8217;s Guts: Merging and Rebasing</a></h1>
    <div class="entry">
        <blockquote>Cross posted to <a href="http://www.lostechies.com/blogs/jagregory/archive/2009/11/27/git-guts-merging-and-rebasing.aspx">Los Techies</a></blockquote>




<p>Here we go again, explaining the internals of Git with the intention of helping you understand what you&#8217;re doing day-to-day. Last time I covered <a href="/writings/gits-guts-branches-head-and-fast-forwards">branches, HEAD, and fast-forwarding</a>. Today we&#8217;ll dive into the guts of merging and rebasing.</p>




<h3>Merging branches</h3>




<p>You&#8217;ve probably merged before. You do it when you want the changes from one branch in another. The principal is the same in Git as it is most other source control systems, but the implementation differs.</p>




<p>Given the following commit structure, consisting of two branches created from the same commit, each with two commits after the branching occurred.</p>


<p><img src="/images/GitGuts2_Figure1.png" alt="Figure 1" /></p>

<p>When these two branches are merged together, this is the structure that results:</p>


<p><img src="/images/GitGuts2_Figure2.png" alt="Figure 1" /></p>

<p>The top-most commit, the red one, is a new commit made by the merge; the merge commit is what reminds Git that a merge occurred next time it&#8217;s showing the history. This commit is special, as it contains multiple parent&#8217;s in it&#8217;s meta-data; these multiple parent&#8217;s allow Git to follow the two trees of commits that constituted the branches that were merged.</p>




<p>One difference in how Git handles merges compared to many other SCMs is that it preserves the commits that were made in both branches. In other systems merges are often represented as a single commit containing the squashed contents of all the commits that were made in the branch being merged in. Git doesn&#8217;t do this (by default, you can tell it to if you want), and therefore preserves all the commits just as they were made; this is quite nice, as it proves incredibly useful to be able to track the origin of changes beyond the point of a merge.</p>




<p>When you merge two branches, it&#8217;s interesting to know that none of the commits are altered in the process. Just bare this in mind for now, I&#8217;ll explain why this is good to know later.</p>




<p>After a merge, if you were to view the history, you&#8217;d see it shown like the previous example, commits in chronological order; the feature branch commits are interspersed between the master commits.</p>


<p><img src="/images/GitGuts2_Figure2.png" alt="Figure 1" /></p>

<p>Yet no commits have been altered in the merge, so how are the commits in a different order? Well, they&#8217;re not, Git&#8217;s just showing you it in the order you expect it to be in. Internally the structure is still as below:</p>


<p><img src="/images/GitGuts2_Figure3.png" alt="Figure 1" /></p>

<p>The merge commit instructs Git to walk the two trees while building the history, and it just displays the results in chronological order. This makes more sense if you recall that Git commits don&#8217;t hold differences like other SCM systems, instead they each contain a snapshot of the complete repository; while in another SCM the ordering of commits is vital &mdash; otherwise the diffs wouldn&#8217;t build a valid file &mdash; Git is able to infer order without affecting the repository contents.</p>




<p>Looking at it in commit order, you can quite easily see how Git flattens the history to be perceived as linear without ever having to touch any of the original commits.</p>




<h4>What happens if there&#8217;s a merge conflict?</h4>




<p>We&#8217;ve all dealt with conflicts in merging before. They typically happen when changes are made to the same file in two branches, in a way that cannot be easily merged (two people edit the same line, for example).</p>




<p>Git&#8217;s commit&#8217;s are immutable though, so how are the changes that you need to make to resolve these conflicts saved? Simple. The merge commit is a regular commit with some extra meta-data, and so it capable of containing changes itself; merge conflict changes are stored in the merge commit. Again, no changes necessary to the original commits.</p>




<h3>Git objects, immutability, and rewriting history</h3>




<p>A Git repository is comprised of objects. A file is a blob object with a name attached to it; if you have two files with the same content, that&#8217;s just two names to a single blob. A directory is a tree object, which is comprised of other trees and blobs. A commit is an object that references a tree object, which is the state of the repository at the time of committing.</p>




<blockquote>To read more about git objects, I&#8217;d definitely recommend you read the <a href="http://book.git-scm.com">Git community book</a>.</blockquote>




<p>Git objects are immutable. To change an object after it&#8217;s been created is impossible, you have to recreate the object with any changes made. Even operations that seem to modify objects actually don&#8217;t; <code>commit --amend</code> is a typical example, that deletes and re-creates the commit rather than actually amending it.</p>




<p>I mentioned that merges don&#8217;t rewrite history, and that it&#8217;s a good thing. Now I&#8217;ll explain why. When you rewrite history, you do so by making changes to commits that ripple up the commit tree; when this happens, it can cause complications when others merge from you. Given a series of commits, like so:</p>


<p><img src="/images/GitGuts2_Figure4.png" alt="Figure 1" /></p>

<p>You then share these commits with another user.</p>


<p><img src="/images/GitGuts2_Figure5.png" alt="Figure 1" /></p>

<p>John now has Michael&#8217;s commits in his repository; however, Michael notices he&#8217;s made a typo in the first commit message, so he amends the commit message. The change in the message requires the commit be recreated. With that first commit recreated, the second commit now has an invalid parent reference, so that commit has to be recreated with the new reference; this recreation ripples it&#8217;s way up the tree, recreating each commit with a new parent. Michael has completely rewritten his tree&#8217;s history.</p>


<p><img src="/images/GitGuts2_Figure6.png" alt="Figure 1" /></p>

<p>Notice all the commit hashes have changed in Michael&#8217;s repository, and John&#8217;s now don&#8217;t match. If Michael was then to make a new commit to his repository, and John tried to merge that change into his repository, Git would get very upset because the new commit would reference a commit that doesn&#8217;t exist in John&#8217;s repository.</p>




<p><strong>The golden rule is:</strong> rewriting history is fine as long as the commits that will be affected haven&#8217;t been made public.</p>




<h3>Rebasing</h3>




<p>The purpose of a rebase is the same as a merge, to bring two tree&#8217;s of commits together. It differs in it&#8217;s approach. Rebasing is a seriously sharp tool. Very powerful, but pretty easy to cut yourself with it.</p>




<p>When you rebase one branch onto another, Git undoes any changes you&#8217;ve made in the target branch, brings it up to date with the changes made in the source branch, then replays your commits on top. This sounds quite strange, so I&#8217;ll go over it step-by-step.</p>




<p>You start with your diverged branches:</p>


<p><img src="/images/GitGuts2_Figure7.png" alt="Figure 1" /></p>

<p>If you then rebase feature onto master, Git undoes the changes in master.</p>


<p><img src="/images/GitGuts2_Figure8.png" alt="Figure 1" /></p>

<p>The history of both branches is now the same, master has been updated to reflect feature; the new commits that were made in master are now detached, floating in the repository without anything referencing them.</p>




<p>The next step is to replay the master commits onto the new structure. This is done one-by-one, and can sometimes result in conflicts that will need to be handled like any merge.</p>




<p>After replaying the repository will look like this:</p>


<p><img src="/images/GitGuts2_Figure9.png" alt="Figure 1" /></p>

<p>The master branch commits are now on the top of the stack, after the commits from the feature branch.</p>




<p>You should recall that commits are immutable, and for changes to be made commits need to be recreated. A rebase is a destructive operation, as it has to rewrite commits to be able to work. In this case, the commits from feature have been unaffected, but the master commits have been assigned new parents (and thus rewritten). What&#8217;s also noticeable is there&#8217;s a lack of a merge commit, which isn&#8217;t needed because the commits have been integrated into the tree; any conflicts are stored in the amended commits, rather than in a merge commit.</p>




<p>The rewriting of commits in a rebase is what makes it a dangerous operation to perform on any branch that has already been pushed to the public (or specifically, that the changes affected by the rebase have already been pushed to the public). A rebase can cause problems upstream, like mentioned in the previous section.</p>




<p>Rebase has it&#8217;s place though. If you&#8217;re working locally and haven&#8217;t yet pushed your changes public, it can be a useful tool. Rebase can be used to pull in changes from upstream in the order that the upstream repository has them, and your local changes (that can be rewritten because you&#8217;re the only one with them) can be replayed on-top; this is a really easy way to keep your repository up-to-date with an authoritative source. You can also use Rebase to manage local branches that you don&#8217;t necessarily want polluting the history with merge markers.</p>




<h3>When to rebase and when to merge?</h3>




<p>Merge when you&#8217;ve already made changes public, and when you want to indicate that two tree&#8217;s have converged. Rebase pretty much any other time.</p>




<p>That&#8217;s it for this time. Same deal as last time, if you have anything you&#8217;d like me to cover I&#8217;ll nail it in the next one.</p>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-11-27T00:00:00+11:00" pubdate data-updated="true">Nov 27<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <a href="/blog/archives" class="center">Blog Archives</a>
</nav></div>
	<footer class="inner">Copyright &copy; 2012 James Gregory</footer>
	<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'jagregory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>