
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>Brace Matching and your Language Service - James Gregory</title>
    <meta name="author" content="James Gregory">

    
    <meta name="description" content="Brace Matching and Your Language Service I&#8217;ve been meaning to write up some of my experiences developing for Visual Studio while I&#8217;ve &hellip;">
    
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

    <link href="/atom.xml" rel="alternate" title="James Gregory" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.png" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3186192-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<header class="inner"><h1 class="left"><a href="/">James Gregory</a></h1>
<nav class="menu left"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<div class="right">
	<form class="search right" action="http://google.com/search" method="get">
		<input class="left" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:www.jagregory.com">
	</form>
	<div class="social right">
		
		
		
		
		<a class="github" href="https://github.com/jagregory" title="GitHub">GitHub</a>
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</div>

</header>
	
	<div id="content" class="inner"><article class="post">
    <h1 class="title">Brace Matching and Your Language Service</h1>
    <div class="entry"><p>I&#8217;ve been meaning to write up some of my experiences developing for Visual Studio while I&#8217;ve been working on <a href="http://www.codeplex.com/BooLangStudio">BooLangStudio</a>, but I can never seem to find the time; either that, or when I can I&#8217;m not confident enough in what I&#8217;m doing to put it out here as a valid resource.</p>

<p>I&#8217;ll start small, here&#8217;s a quick guide to how I&#8217;ve implemented brace matching using the managed Visual Studio extensibility SDK.</p>

<p><strong>What exactly is brace matching?</strong> Brace matching is where paired characters are highlighted when one or the other is selected in the editor.</p>

<p><img src="/images/bracematching-1.png" alt="Brace matching" /></p>

<p>There are a couple of things you need to consider when you implement brace matching.</p>

<p>Firstly, there are different types of braces that can be matched (depending on your language). Taking C# as an example, the brace matching works with parentheses (<code>()</code>), box brackets (<code>[]</code>), braces (<code>{}</code>), and chevrons (<code>&lt;&gt;</code>). These all need to be paired independently, as to avoid matching an open parenthesis with a closing brace.</p>

<p>Secondly, the matching has to work bi-directionally. The user can place their caret at either side of the bracket pair, and the highlighting should know where both sides are regardless.</p>

<h2>LanguageService implementation</h2>

<p>A lot of the legwork of implementing a language in Visual Studio is done in the LanguageService, and brace matching is no exception. You should already have a <code>ParseSource</code> method in your LanguageService; this is where we&#8217;re going to work.</p>

<p>The <code>ParseSource</code> method has a <code>ParseRequest</code> parameter, which exposes a <code>Reason</code> property. When this property is set to <code>MatchBraces</code>, that&#8217;s when we need to do our processing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">override</span> <span class="n">AuthoringScope</span> <span class="nf">ParseSource</span><span class="p">(</span><span class="n">ParseRequest</span> <span class="n">request</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Reason</span> <span class="p">==</span> <span class="n">ParseReason</span><span class="p">.</span><span class="n">MatchBraces</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// match braces here</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What needs to be done is pretty simple: Parse the open document and find the partner to the brace that the caret is on.</p>

<p>In BooLangStudio I&#8217;ve implemented this in the following fashion:</p>

<ul>
<li>Run the document through a <code>BracketPairFinder</code>, which creates a list of bracket pairs in the document</li>
<li>Get the index of the caret (baring in mind you have to translate between the Request&#8217;s Line and Column, and an actual string index)</li>
<li>Find the pair that the caret is positioned at</li>
<li>Get the opposite bracket from the pair</li>
<li>Get the Line and Column of the opposite bracket</li>
</ul>


<p>It&#8217;s up to you how you implement the above steps, as long as you end up with the opposite bracket to the one you started with. I&#8217;ll illustrate using the BooLangStudio source.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">override</span> <span class="n">AuthoringScope</span> <span class="nf">ParseSource</span><span class="p">(</span><span class="n">ParseRequest</span> <span class="n">request</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Reason</span> <span class="p">==</span> <span class="n">ParseReason</span><span class="p">.</span><span class="n">MatchBraces</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// find all pairs</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">bracketFinder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BracketPairFinder</span><span class="p">();</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">bracketPairs</span> <span class="p">=</span> <span class="n">bracketFinder</span><span class="p">.</span><span class="n">FindPairs</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// get index of caret from source text</span>
</span><span class='line'>    <span class="n">Source</span> <span class="n">source</span> <span class="p">=</span> <span class="n">languageService</span><span class="p">.</span><span class="n">GetSource</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">View</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">indexOfCaret</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">GetPositionOfLineIndex</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Line</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Col</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// find the partner to the bracket at the caret</span>
</span><span class='line'>    <span class="kt">int?</span> <span class="n">partner</span> <span class="p">=</span> <span class="n">bracketPairs</span><span class="p">.</span><span class="n">FindPartnerIndex</span><span class="p">(</span><span class="n">indexOfCaret</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">partner</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="c1">// tell Visual Studio about the pair</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>The <code>Source</code> class has a helpful <code>GetPositionOfLineIndex</code> method, which translates between a Line and Column to a single string index. Very handy!</p></blockquote>

<p>Once you&#8217;ve got your indices, we need to inform Visual Studio of our findings. You do that by setting the <code>request.Sink.FoundMatchingBrace</code> to <code>true</code>, then calling the <code>MatchPair</code> method on the Sink. You need to pass two <code>TextSpan</code> instances to the <code>MatchPair</code> method; the first is the left brace, and the second the right.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">override</span> <span class="n">AuthoringScope</span> <span class="nf">ParseSource</span><span class="p">(</span><span class="n">ParseRequest</span> <span class="n">request</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Reason</span> <span class="p">==</span> <span class="n">ParseReason</span><span class="p">.</span><span class="n">MatchBraces</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">partner</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="c1">// tell Visual Studio about the pair</span>
</span><span class='line'>      <span class="n">request</span><span class="p">.</span><span class="n">Sink</span><span class="p">.</span><span class="n">FoundMatchingBrace</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">int</span> <span class="n">nextLine</span><span class="p">,</span> <span class="n">nextCol</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">source</span><span class="p">.</span><span class="n">GetLineIndexOfPosition</span><span class="p">(</span><span class="n">partner</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">out</span> <span class="n">nextLine</span><span class="p">,</span> <span class="k">out</span> <span class="n">nextCol</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">request</span><span class="p">.</span><span class="n">Sink</span><span class="p">.</span><span class="n">MatchPair</span><span class="p">(</span>
</span><span class='line'>        <span class="k">new</span> <span class="n">TextSpan</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="n">iStartLine</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Line</span><span class="p">,</span>
</span><span class='line'>          <span class="n">iEndLine</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Line</span><span class="p">,</span>
</span><span class='line'>          <span class="n">iStartIndex</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Col</span><span class="p">,</span>
</span><span class='line'>          <span class="n">iEndIndex</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Col</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="k">new</span> <span class="n">TextSpan</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="n">iStartLine</span> <span class="p">=</span> <span class="n">nextLine</span><span class="p">,</span>
</span><span class='line'>          <span class="n">iEndLine</span> <span class="p">=</span> <span class="n">nextLine</span><span class="p">,</span>
</span><span class='line'>          <span class="n">iStartIndex</span> <span class="p">=</span> <span class="n">nextCol</span><span class="p">,</span>
</span><span class='line'>          <span class="n">iEndIndex</span> <span class="p">=</span> <span class="n">nextCol</span> <span class="p">+</span> <span class="m">1</span>
</span><span class='line'>        <span class="p">},</span> <span class="m">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">AuthoringScope</span><span class="p">();</span> <span class="c1">// replace with your implementation</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>The <code>Source</code> class has another helpful method: <code>GetLineIndexOfPosition</code> method, which translates back to Line and Column from a single string index.</p></blockquote>

<p>Finally, just return an empty AuthoringScope, as it isn&#8217;t used as part of this parse request.</p>

<p>That&#8217;s it! You should have now successfully implemented brace matching. You may need to tweak the TextSpan indexes depending on your parser implementation, but it shouldn&#8217;t be far wrong.</p>

<h2>BooLangStudio implementation</h2>

<p>If you&#8217;re interested in seeing how I handle the brace parsing, I may cover that in a future post. However, you can find all the source in my <a href="http://github.com/jagregory/boolangstudio/tree/master">github BooLangStudio fork</a>. Some interesting one&#8217;s in particular are:</p>

<ul>
<li><a href="http://github.com/jagregory/boolangstudio/tree/54d4bcef79d4dbd2ff6cf1fbd9b0a15f325f5c41/Source/BooLangService/ParseRequestProcessor.cs#L133">ParseRequestProcessor.HighlightBraces</a> - Delegated to from the LanguageService.ParseSource method.</li>
<li><a href="http://github.com/jagregory/boolangstudio/tree/54d4bcef79d4dbd2ff6cf1fbd9b0a15f325f5c41/Source/BooLangService/StringParsing/BracketPairFinder.cs">BracketPairFinder</a> - Class which parses a document to get all the bracket pairs. Uses <a href="http://github.com/jagregory/boolangstudio/tree/54d4bcef79d4dbd2ff6cf1fbd9b0a15f325f5c41/Source/BooLangService/StringParsing/ExcludingStringLiteralsStringWalker.cs">ExcludingStringLiteralsStringWalker</a>.</li>
<li><a href="http://github.com/jagregory/boolangstudio/tree/54d4bcef79d4dbd2ff6cf1fbd9b0a15f325f5c41/Source/BooLangService/StringParsing/StringWalker.cs">StringWalker</a> - A simple string parser used by the <code>BracketPairFinder</code>, which walks over a string maintaining a code-aware state. Basically, it lets you know whether it&#8217;s currently inside a bracket or string literal. Handy for not matching characters inside strings.</li>
</ul>

</div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-09-02T00:00:00+10:00" pubdate data-updated="true">Sep 2<span>nd</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>
<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
	<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=xa-4eb4a0c47196e907"></script>
</div>
</div>
	<footer class="inner">Copyright &copy; 2012 James Gregory</footer>
	<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'jagregory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>