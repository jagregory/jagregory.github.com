
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>NHibernate and the SqlTypeException - James Gregory</title>
    <meta name="author" content="James Gregory">

    
    <meta name="description" content="NHibernate and the SqlTypeException NHibernate is a wonderful piece of technology, I love it probably more than is reasonable for code. It does &hellip;">
    
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

    <link href="/atom.xml" rel="alternate" title="James Gregory" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.png" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3186192-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<header class="inner"><h1 class="left"><a href="/">James Gregory</a></h1>
<nav class="menu left"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<div class="right">
	<form class="search right" action="http://google.com/search" method="get">
		<input class="left" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:www.jagregory.com">
	</form>
	<div class="social right">
		
		
		
		
		<a class="github" href="https://github.com/jagregory" title="GitHub">GitHub</a>
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</div>

</header>
	
	<div id="content" class="inner"><article class="post">
    <h1 class="title">NHibernate and the SqlTypeException</h1>
    <div class="entry"><p><a href="http://www.nhibernate.org">NHibernate</a> is a wonderful piece of technology, I love it probably more than is reasonable for code. It does however, occasionally scare you with some seemingly odd behavior. I say seemingly, because every time I&#8217;ve had trouble it&#8217;s actually ended up being my own fault. <em>This is one of those times.</em></p>

<p>Picture a simple page, with a <a href="/writings/delegrid/">DeleGrid</a> control, being bound using NHiberate. Baring in mind how the DeleGrid works, two queries were being executed, one to return the first page of data and another to get the total row-count for the grid. <em>These queries were identical apart from the paging in one, and the projection in the other.</em></p>

<p>Upon execution of the second query, NHibernate was throwing a <code>SqlTypeException</code> for a <code>SqlDateTime</code> overflow. <code>SqlDateTime overflow. Must be between 1/1/1753 12:00:00 AM and 12/31/9999 11:59:59 PM</code>. This was pretty bizarre. Why on earth would the first query succeed (and bring back records, fully populated), but the same query again would die.</p>

<p>A good place to start for NHibernate debugging is always the logs, so I delved in. I discovered NHibernate was attempting to execute an update statement just before it tried the second query. It just kept getting stranger, why would a straightforward query cause an update?</p>

<p>I thought i&#8217;d investigate why the update statement was failing first, then I&#8217;d tackle the problem of why it was even updating at all. Looking at the query I identified the column that was causing the exception, it was (as expected) a <code>DateTime</code> column that was trying to be set to <code>DateTime.MinValue</code>. This exception is thrown because .Net and SQL Server have different ideas over what the minimum value for a <code>DateTime</code> should be.</p>

<p>Now, why would this column be being set at all? Well, it ends up that the column in the database was nullable, but the property in the object wasn&#8217;t. So because <code>DateTime</code> is a value type and cannot be set to <code>null</code>, NHibernate was populating it with the closest value to <code>null</code> as it could manage.</p>

<p>That was the key, as soon as I had that realisation, it was obvious what the problem was.</p>

<p>NHibernate knew that the database had a nullable column, but it had to manage with the non-nullable field on the object. When it came to run the second query, it noticed that the property wasn&#8217;t null as the mapping file said it should be, so it determined the value must have changed. It then attempted to persist those changes before executing the query!</p>

<h2>To break it down</h2>

<ol>
  <li>Nullable column pulled into a non-nullable field forces NHibernate to create the smallest value it can.</li>
  <li>NHibernate then checks for any changes, expecting a <code>null</code> on that field but finding a value.</li>
  <li>Object now considered dirty because value has allegedly changed.</li>
  <li>NHibernate performs an update before it pulls back the data agian.</li>
</ol>


<p>So the fix was simply to make the <code>DateTime</code> in the object a <code>DateTime?</code>, a nullable <code>DateTime</code>. That got rid of the false update, and fixed my queries. Simple when you know what the problem is.</p>

<p><strong>So the moral of the story is:</strong> Make sure everything is in sync - schema, mappings and POCOs.</p>
</div>
    <div class="meta">
        <div class="date">








  


<time datetime="2007-12-18T00:00:00+11:00" pubdate data-updated="true">Dec 18<span>th</span>, 2007</time></div>
        <div class="tags">

</div>
        
    </div>
</article>
<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
	<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=xa-4eb4a0c47196e907"></script>
</div>
</div>
	<footer class="inner">Copyright &copy; 2012 James Gregory</footer>
	<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'jagregory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>