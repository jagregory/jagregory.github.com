
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Introduction to Static Reflection - James Gregory</title>
  <meta name="author" content="James Gregory">

  
  <meta name="description" content="This post could&#8217;ve also been called &#8220;Fluent NHibernate secrets exposed!&#8221; but it sounded a bit sensationalist. You may have heard &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.jagregory.com/writings/introduction-to-static-reflection">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="James Gregory" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Cardo:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3186192-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<logo>

<img src="/logo.png" alt="Website Logo. Upload to /source/logo.png ; disable in /source/_includes/logo.html" height="32px" width="32px">
</logo>



<body >
  <header role="banner"><hgroup>
  <h1><a href="/">James Gregory</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

<br>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.jagregory.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<!--
<ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
-->

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Introduction to Static Reflection</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-26T00:00:00+11:00" pubdate data-updated="true">Jan 26<span>th</span>, 2009</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote>This post could&#8217;ve also been called &#8220;Fluent NHibernate secrets exposed!&#8221; but it sounded a bit sensationalist.</blockquote>




<p>You may have heard people mention static reflection recently, quite possibly because it&#8217;s used extensively in <a href='http://www.fluentnhibernate.org'>Fluent NHibernate</a>, <a href='http://ayende.com/projects/rhino-mocks.aspx'>Rhino Mocks</a>, and I believe <a href='http://www.lostechies.com/blogs/jimmy_bogard/'>Jimmy Bogard&#8217;s</a> new <a href='http://www.codeplex.com/AutoMapper'>AutoMapper</a> also uses it; pretty much any of the new &#8220;fluent&#8221; interfaces use some kind of static reflection.</p>




<p><strong>So what actually is static reflection?</strong> Well, it&#8217;s a statically compiled way of utilising the Reflection API.</p>




<p>Traditionally, if you wanted to use the Reflection API to interrogate your classes, you&#8217;d need to utilise strings to refer to properties and methods; this can make your design quite brittle, because you have to make sure these strings are kept up-to-date whenever you rename anything. What&#8217;s worse is that because reflection is late-bound, you aren&#8217;t aware of the problems until the code is actually executed, so this renaming could introduce hidden bugs that don&#8217;t appear until runtime. With the growing popularity of refactoring techniques, it&#8217;s becoming more important that we can use reflection without having to worry about this problem.</p>




<blockquote>
<p>It&#8217;s very true that tools like Resharper can certainly help with refactoring reflection-based code, but none of them are perfect and they only help the people that use them.</p>
</blockquote>




<p><p>In C# 3 we were introduced to lambda expressions and Linq, and with them came the <code>Func&lt;></code> and <code>Expression&lt;></code> classes; these are the key to static reflection. The <code>Func&lt;></code> set of classes allow you to use lambda expressions that return a value, while an <code>Expression&lt;></code> can be used to programatically access the contents of a delegate.</p></p>

<p><p>Combining <code>Func&lt;></code> and <code>Expression&lt;></code> can give us a very powerful way to statically retrieve <code>PropertyInfo</code> (and similar) instances from a lambda expression. For example <code>Expression&lt;Func&lt;Customer, object>></code> represents an expression that contains a delegate that returns a value (of type object), with a <code>Customer</code> parameter; I&#8217;ll illustrate:</p></p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// method to receive an expression</span>
</span><span class='line'><span class="k">public</span> <span class="n">PropertyInfo</span> <span class="n">GetProperty</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// usage</span>
</span><span class='line'><span class="n">GetProperty</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;(</span><span class="n">customer</span> <span class="p">=&gt;</span> <span class="n">customer</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><p>What this is actually doing is creating a lambda that returns a value, the value of <code>customer.Name</code> in this case. Here&#8217;s the trick, we don&#8217;t actually care about the value that&#8217;s returned! In-fact, we don&#8217;t even evaluate this expression at all.</p></p>

<p><blockquote>
<p>The reason we use <code>object</code> in the <code>Func</code> signature, rather than a more specific type, is because we want to allow <em>any</em> property to be used; however, if you were only interested in <code>string</code> properties, then you could restrict it by replacing this parameter.</p>
</blockquote></p>

<p><p>The <code>Expression</code> API itself is very in-depth, so I won&#8217;t go into the intricacies of it but here&#8217;s a very simple implementation of static reflection.</p></p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">PropertyInfo</span> <span class="n">GetProperty</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">memberExpression</span> <span class="p">=</span> <span class="n">expression</span><span class="p">.</span><span class="n">Body</span> <span class="k">as</span> <span class="n">MemberExpression</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">memberExpression</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">&quot;Not a member access.&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">memberExpression</span><span class="p">.</span><span class="n">Member</span> <span class="k">as</span> <span class="n">PropertyInfo</span><span class="p">;</span> <span class="c1">// Should account for FieldInfo too</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><p>Stepping through this code, we start by getting the body of the expression which we cast to a <code>MemberExpression</code>; this is us grabbing the <code>customer.Name</code> part of our expression. Now we can get the member itself and cast it to a <code>PropertyInfo</code>, this is the <code>Name</code> part of the expression body. That&#8217;s it! We&#8217;ve not evaluated the expression, but we&#8217;ve inspected it and retrieved the property.</p></p>

<p><blockquote>
<p>This example is for illustrative purposes, there are many different types of expressions which would be excluded by this. If you are to implement your own static reflection parser, you should cater for these other types of expressions.</p>
</blockquote></p>

<p><p>As this example shows, we&#8217;re able to use reflection without having to resort to strings. The great thing about this is that if you change the name of a member inside a lambda, you&#8217;ll get a compile error if you haven&#8217;t updated all the references! No more hidden bugs.</p></p>

<p><p>So that&#8217;s how the magic behind Fluent NHibernate (and others) works, simple when you know how!</p></p>
</div>


  <footer>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
  

<span class="byline author vcard">Text authored by <span class="fn">James Gregory</span></span>


      


    </p>
    <p class="meta">
      
        <a class="basic-alignment left" href="/writings/fluent-nhibernate-auto-mapping-and-base-classes/" title="Previous Post: Fluent NHibernate: Auto mapping and base-classes">&laquo; Fluent NHibernate: Auto mapping and base-classes</a>
      
      
        <a class="basic-alignment right" href="/writings/i-think-you-mean-a-many-to-one-sir/" title="Next Post: I think you mean a many-to-one, sir">I think you mean a many-to-one, sir &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Website copyright &copy; 2014 - James Gregory |
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/TheChymera/Koenigspress">Königspress</a></span>.
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jagregory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
