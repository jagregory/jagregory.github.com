
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>Fluent NHibernate: Auto Mapping Conventions - James Gregory</title>
    <meta name="author" content="James Gregory">

    
    <meta name="description" content="Fluent NHibernate: Auto Mapping Conventions Notice: The content in this post is out of date, please refer to the Auto Mapping page in the Fluent &hellip;">
    
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

    <link href="/atom.xml" rel="alternate" title="James Gregory" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.png" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3186192-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<header class="inner"><h1 class="left"><a href="/">James Gregory</a></h1>
<nav class="menu left"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<div class="right">
	<form class="search right" action="http://google.com/search" method="get">
		<input class="left" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:www.jagregory.com">
	</form>
	<div class="social right">
		
		
		
		
		<a class="github" href="https://github.com/jagregory" title="GitHub">GitHub</a>
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</div>

</header>
	
	<div id="content" class="inner"><article class="post">
    <h1 class="title">Fluent NHibernate: Auto Mapping Conventions</h1>
    <div class="entry"><blockquote><p><strong>Notice:</strong> The content in this post is out of date, please refer to the <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Auto-mapping">Auto Mapping</a> page in the <a href="https://github.com/jagregory/fluent-nhibernate/wiki">Fluent NHibernate Wiki</a> for the latest version.</p>

<p>This is a continuation of my previous <a href="/writings/fluent-nhibernate-auto-mapping-introduction/">Auto Mapping Introduction</a> post, and is based on the same revision of <a href="http://www.fluentnhibernate.org">Fluent NHibernate</a>.</p></blockquote>

<p>Auto mappings are generated based on a set of conventions, assumptions about your environment, that mean you can map your entire domain with a miniscule amount of code. Sometimes however, the conventions we supply are not to your liking, perhaps you&#8217;re a control freak and want 100% control, or more likely you&#8217;re working against an existing database that has it&#8217;s own set of standards. You&#8217;d still like to use the auto mapper, but can&#8217;t because it maps your entities all wrong.</p>




<p>Luckily for you we&#8217;ve thought about that, you can customise the conventions that the auto mapper uses.</p>




<blockquote>
<p><strong>What exactly is mapped using conventions?</strong> As of <a href='http://code.google.com/p/fluent-nhibernate/source/detail?r=190'>r190</a>: Default lazy load, cacheability, string length, ids, key names, foreign key column names, table names, many-to-many table names, version column names, and a wealth of specific property, one-to-one, one-to-many, and many-to-many overrides.</p>

<p>Although we do allow you to customise a lot of things, not everything is covered yet. If you do encounter a scenario you can&#8217;t handle, drop us a message on the <a href='http://groups.google.com/group/fluent-nhibernate'>mailing list</a>, or even better: supply us a patch.</p>
</blockquote>




<p>We&#8217;ll continue with our store example from before, which comprised of a <code>Product</code> and a <code>Shelf</code>.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">decimal</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Shelf</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">Products</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Using the standard auto mapping conventions, this assumes a database schema like so:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">table</span> <span class="n">Product</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">Id</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Price</span> <span class="nb">decimal</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Shelf_id</span> <span class="nb">int</span> <span class="k">foreign</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">table</span> <span class="n">Shelf</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">Id</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<p>Nothing too complicated there. The auto mapper has correctly assumed that our Ids are identity&#8217;s and are primary keys, it&#8217;s also assumed their names, the name of our foreign key to the <code>Shelf</code> table (<code>ShelfId</code>), and the length of our <code>Name</code> column.</p>




<p>Lets assume for the sake of this post that you&#8217;re not happy with that schema. You&#8217;re one of those people that prefers to name their primary key after the table it&#8217;s in, so our <code>Product</code> identity should be called <code>ProductId</code>; also, you like your foreign key&#8217;s to be explicitly named _FK, and your strings are always a bit longer than <code>100</code>.</p>




<p>Remember this fellow?</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>
</span><span class='line'>  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Storefront</span><span class="p">.</span><span class="n">Entities</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;);</span>
</span></code></pre></td></tr></table></div></figure>




<p>Lets update it to include some convention overrides. We&#8217;ll start with the Id name.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>
</span><span class='line'>  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Storefront</span><span class="p">.</span><span class="n">Entities</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">WithConvention</span><span class="p">(</span><span class="n">convention</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">convention</span><span class="p">.</span><span class="n">GetPrimaryKeyNameFromType</span> <span class="p">=</span>
</span><span class='line'>      <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Id</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;;</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<p>What we did there was use the <code>WithConvention</code> method to customise the <code>Convention</code> instance that the auto mapper uses. In this case we overwrote the <code>GetPrimaryKeyNameFromType</code> function with our own lambda expression; as per our function, our primary key&#8217;s will now be generated as <code>TypeNameId</code>; which means our schema now looks like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">table</span> <span class="n">Product</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">ProductId</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Price</span> <span class="nb">decimal</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Shelf_id</span> <span class="nb">int</span> <span class="k">foreign</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">table</span> <span class="n">Shelf</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">ShelfId</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<blockquote>
<p>The convention functions are called against their respective mapping part for every generated entity, and the result of their execution is used to generate the mappings. The part that they work against is usually discernible from their name, or their parameters. <code>GetTableName</code> for example works against an entity <code>Type</code>, while <code>GetVersionColumnName</code> is called against every <code>PropertyInfo</code> gleaned from your entities. <em>As there is no API documentation (as of writing), it&#8217;s a matter of intellisense poking to find which conventions are applicable to what you want to override.</em></p>
</blockquote>




<p>As you can see, our primary key&#8217;s now have our desired naming convention. Lets do the other two together, as they&#8217;re so simple; we&#8217;ll override the foreign key naming, and change the default length for strings.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">autoMappings</span>
</span><span class='line'>  <span class="p">.</span><span class="n">WithConvention</span><span class="p">(</span><span class="n">convention</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">convention</span><span class="p">.</span><span class="n">GetPrimaryKeyNameFromType</span> <span class="p">=</span>
</span><span class='line'>      <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Id</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;;</span>
</span><span class='line'>    <span class="n">convention</span><span class="p">.</span><span class="n">GetForeignKeyNameOfParent</span> <span class="p">=</span>
</span><span class='line'>      <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">_FK</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;;</span>
</span><span class='line'>    <span class="n">convention</span><span class="p">.</span><span class="n">DefaultStringLength</span> <span class="p">=</span> <span class="m">250</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<p>That&#8217;s all there is to it, when combined with the other conventions you can customise the mappings quite heavily while only adding a few lines to your auto mapping.</p>




<p>This is our final schema:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">table</span> <span class="n">Product</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">ProductId</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Price</span> <span class="nb">decimal</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Shelf_FK</span> <span class="nb">int</span> <span class="k">foreign</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">table</span> <span class="n">Shelf</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">ShelfId</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<p>Next time: how to apply your own type conventions that apply to all properties of a specific type in your domain, and how to utilise NHibernate&#8217;s <code>IUserType</code>s.</p>

</div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-01-11T00:00:00+11:00" pubdate data-updated="true">Jan 11<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>

</div>
	<footer class="inner">Copyright &copy; 2013 James Gregory</footer>
	<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'jagregory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>