<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>James Gregory</title>
    <meta name="description" content="Code monkey. ThoughtWorks. Chief Agitator.
" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/css/main.css" />

</head>
<body class="post-template">

    <header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="/">Home</a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Sinopia: a private NPM registry in Vagrant</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2015-05-14">14 May 2015</time>
                
            </section>
        </header>

        <section class="post-content">
            <p>Not all of our packages can be pushed to the public NPM repository. Proprietary code and uninteresting code we want to keep internal, but until recently the package distribution story for this code has been worse than open-sourcing it. You either modularise it and publish to the world, or you have a bad time.</p>

<!-- more -->

<blockquote>
  <p>Or you modularise and share via git dependencies, which isn’t a great solution. You lose versioning, all the pre-publish hook loveliness, and become quite limited by where our package is being used (no preprocessors for you!).</p>
</blockquote>

<p>In the early days NPM wasn’t designed with multiple registries in mind, so hosting your own internal one meant either proxying/mirroring the public registry or manually adding public packages to your private registry and using it for everything. Thanks to improvements in NPM and several open-source efforts, it’s now much easier than that to host your own internal NPM registry.</p>

<p>NPM have recently <a href="https://www.npmjs.com/private-modules">started offering private modules</a>, which looks very interesting. There’s also a pay-for <a href="http://npmjs.com/enterprise#pricing">Enterprise option</a> from NPM which is worth thinking about once you scale.</p>

<p>If private cloud hosting isn’t your thing, the host-your-own options are worth exploring. <a href="https://www.npmjs.com/package/sinopia">Sinopia</a> is what we’ll setup.</p>

<h2 id="running-sinopia-in-vagrant">Running Sinopia in Vagrant</h2>

<p>To get a Sinopia Virtual Machine running locally there’s a few tools you need to have installed. Install <a href="https://www.vagrantup.com">Vagrant</a> and <a href="https://www.virtualbox.org">VirtualBox</a>, and we’ll later be using <a href="http://www.ansible.com/">Ansible</a> to configure our machine so you should get that installed too.</p>

<p>Vagrant uses a Vagrantfile to define how your Virtual Machine (or machines) will be configured. You can run <code class="highlighter-rouge">vagrant init</code> to create a Vagrantfile. Once you have that file, we’ll make some changes inside the config block.</p>

<p>To follow along, you can <a href="/downloads/sinopia/Vagrantfile">download the complete Vagrantfile</a>.</p>

<section class="side-by-side">
  <div>

    <p>The Ubuntu boxes provided by the Phusion team are a good set of boxes to start from. We’re using their 14.04 TLS box.</p>

  </div>

  <div class="highlighter-rouge"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"ubuntu-14.04-amd64-vbox"</span>
<span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_url</span> <span class="o">=</span> <span class="s2">"https://oss-binaries.phusionpassenger.com/vagrant/boxes/latest/ubuntu-14.04-amd64-vbox.box"</span>
</code></pre>
  </div>

</section>

<section class="side-by-side">
  <div>

    <p>When Sinopia starts it will listen on port <code class="highlighter-rouge">4873</code> in the guest machine, but we need to forward that port to a port on our host. For convinience, we’ll just use the same port on both.</p>

  </div>

  <div class="highlighter-rouge"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">80</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">4873</span>
</code></pre>
  </div>

</section>

<section class="side-by-side">
  <div>

    <p>We also want to sync the Sinopia data directory (<code class="highlighter-rouge">/var/sinopia</code>) to our host, so we can destroy the Virtual Machine without losing all of our registry content.</p>

  </div>

  <div class="highlighter-rouge"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"sinopia_data/"</span><span class="p">,</span> <span class="s2">"/var/sinopia"</span><span class="p">,</span> <span class="ss">mount_options: </span><span class="sx">%W{dmode=777 fmode=666}</span>
</code></pre>
  </div>

</section>

<section class="side-by-side">
  <div>

    <p>Finally, Vagrant will run Ansible on the Virtual Machine. Ansible will download and configure Sinopia using the <a href="https://github.com/jagregory/sinopia-ansible">sinopia-ansible</a> role.</p>

  </div>

  <div class="highlighter-rouge"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"ansible"</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
  <span class="n">ansible</span><span class="p">.</span><span class="nf">playbook</span> <span class="o">=</span> <span class="s2">"site.yml"</span>
<span class="k">end</span>
</code></pre>
  </div>

</section>

<p>Once you’ve saved the changes to your Vagrant file, you can run: <code class="highlighter-rouge">vagrant up</code></p>

<p>You’ll see the Ansible output fly by and eventually it will complete. At this point you can point your browser at <a href="http://localhost:4873">http://localhost:4873</a> to be greeted by Sinopia.</p>

        </section>

        

        <footer class="post-footer">
            <!-- If we want to display author's name and bio -->
            

            
        </footer>
    </article>
</main>

    <footer class="site-footer clearfix">
      <section class="copyright">
        <a href="mailto:james@jagregory.com">James Gregory</a> &copy;
               &bull; All content licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">cc by-nc-sa 4.0</a>.
      </section>
    </footer>

    <script type="text/javascript" src="/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/js/index.js"></script>
</body>
</html>
