
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>Futility: Transforming entities into DTOs - James Gregory</title>
    <meta name="author" content="James Gregory">

    
    <meta name="description" content="Futility: Transforming Entities Into DTOs Future James: This is pretty much describing AutoMapper, just take a look at that instead. I quite dislike &hellip;">
    
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

    <link href="/atom.xml" rel="alternate" title="James Gregory" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.png" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3186192-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<header class="inner"><h1 class="left"><a href="/">James Gregory</a></h1>
<nav class="menu left"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<div class="right">
	<form class="search right" action="http://google.com/search" method="get">
		<input class="left" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:www.jagregory.com">
	</form>
	<div class="social right">
		
		
		
		
		<a class="github" href="https://github.com/jagregory" title="GitHub">GitHub</a>
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</div>

</header>
	
	<div id="content" class="inner"><article class="post">
    <h1 class="title">Futility: Transforming Entities Into DTOs</h1>
    <div class="entry"><blockquote><p>Future James: This is pretty much describing <a href="http://automapper.codeplex.com/">AutoMapper</a>, just take a look at that instead.</p></blockquote>

<p>I quite dislike mapping DTOs to entities, it&#8217;s a pain, but mostly tedious and tiresome rather than difficult. I decided to try to ease things by creating a library that would resolve entity instances to their DTO counterparts.</p>

<p>My requirements were few but I was determined not to violate any of them.</p>

<ol>
  <li>Refactoring friendly. No strings for property names, changing names should give compiler errors.</li>
  <li>Must simplify code.</li>
  <li>Must improve maintainability.</li>
</ol>


<h2>First attempt: Explicit mapping</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">mapper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DtoMapper</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">,</span> <span class="n">CustomerDto</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="n">mapper</span><span class="p">.</span><span class="n">Pair</span><span class="p">(</span><span class="n">mapper</span><span class="p">.</span><span class="n">Entity</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">mapper</span><span class="p">.</span><span class="n">Dto</span><span class="p">.</span><span class="n">CustomerName</span><span class="p">);</span>
</span><span class='line'><span class="n">mapper</span><span class="p">.</span><span class="n">Pair</span><span class="p">(</span><span class="n">mapper</span><span class="p">.</span><span class="n">Entity</span><span class="p">.</span><span class="n">Address</span><span class="p">,</span> <span class="n">mapper</span><span class="p">.</span><span class="n">Dto</span><span class="p">.</span><span class="n">CustomerAddress</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ... elsewhere ...</span>
</span><span class='line'>
</span><span class='line'><span class="n">CustomerDto</span> <span class="n">dto</span> <span class="p">=</span> <span class="n">mapper</span><span class="p">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">customer</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>With a clever bit of DynamicProxy usage, this implementation successfully mapped properties on an entity to a DTO. I believed it was reasonably clear, but having to use mapper.Entity was a bit obtuse. Dealing with properties on instances without an instance is tricky, especially if you want to avoid using strings.</p>

<p>The explicit mapping is very refactoring friendly. I could rename a property without breaking the mapping, so requirement 1 was satisfied.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">dto</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CustomerDto</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">dto</span><span class="p">.</span><span class="n">CustomerName</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span><span class='line'><span class="n">dto</span><span class="p">.</span><span class="n">CustomerAddress</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Address</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">dto</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As the above code demonstrates, this implementation isn&#8217;t actually any simpler than just doing simple assignments, it&#8217;s in-fact more complicated because of the overhead of understanding what the mapper is. This simple assignment method is also refactoring friendly.</p>

<p>So with requirement 2 failed, and requirement 3 no different to doing it manually, it was time to move on.</p>

<h2>Second attempt: Implicit mapping</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">mapper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DtoMapper</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">mapper</span><span class="p">.</span><span class="n">CreateImplicitMap</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">,</span> <span class="n">CustomerDto</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ... elsewhere ...</span>
</span><span class='line'>
</span><span class='line'><span class="n">CustomerDto</span> <span class="n">dto</span> <span class="p">=</span> <span class="n">mapper</span><span class="p">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">customer</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is my favourite implementation, it&#8217;s clean and smart; however, it&#8217;s also useless.</p>

<p>It did the same as the first example, but implicitly mapped any properties that have the same name together. This is fine, but it would ignore anything that don&#8217;t have the same names. I could&#8217;ve implemented some logic for guessing names, but that would just be asking for trouble.</p>

<p>Tragically this implementation wasn&#8217;t that refactoring friendly; you can rename properties, but it would silently stop mapping them unless you renamed it&#8217;s partner too. That&#8217;s pretty dangerous stuff. Requirement 1 failed.</p>

<p>It does produce less code than the first implementation, and the simple assignment method, so 2 and 3 are covered.</p>

<h2>Third attempt: Attributes</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomerDto</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">  [DtoPartner(typeof(Customer), &quot;Name&quot;)]</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">string</span> <span class="n">CustomerName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="na">  </span>
</span><span class='line'><span class="na">  [DtoPartner(typeof(Customer), &quot;Address&quot;)]</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">string</span> <span class="n">CustomerAddress</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I could live with this implementation, it&#8217;s not as clean as the implicit method, but it is still quite clear.</p>

<p>Unfortunately, it fails in the refactoring test. You can&#8217;t rename a property on Customer without it breaking the mapping, because the property names are strings. Requirement 1 failed.</p>

<p>You could smooth over this with an inspection unit test, which checks the strings against their types to see if the property exists, but that smells, it&#8217;s not a very good library if you have to verify it even works. I could&#8217;ve also created a static class to represent the Customer instance properties, but that&#8217;s more noise (you&#8217;d need 3 classes, instead of just 2); a pre-build step (ala SubSonic) came to mind, but that&#8217;s entering into the realm of diminished returns.</p>

<h2>Conclusion?</h2>

<p>Sometimes the obvious way is the best way. Old fashioned may be old, but that doesn&#8217;t make it wrong. Sometimes a cigar is just a cigar.</p>
</div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-05-06T00:00:00+10:00" pubdate data-updated="true">May 6<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>

</div>
	<footer class="inner">Copyright &copy; 2013 James Gregory</footer>
	<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'jagregory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>