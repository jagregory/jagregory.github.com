<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>James Gregory</title>
    <meta name="description" content="Code monkey. ThoughtWorks. Chief Agitator.
" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/css/main.css" />

</head>
<body class="home-template">

    <header class="main-header no-cover">
    <div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title"><a href="/">James Gregory</a></h1>
            <h2 class="page-description">
                 Code monkey. ThoughtWorks. Chief Agitator.
 
            </h2>
        </div>
    </div>
    <a class="scroll-down icon-arrow-left" href="#content" data-offset="-45"><span class="hidden">Scroll Down</span></a>
</header>

<main id="content" class="content" role="main">
    <div class="extra-pagination inner">
        <nav class="pagination" role="pagination">
    
        
            <a class="newer-posts" href="/page6/" title="Previous Page">&laquo; Newer Posts</a>
      
    
    <span class="page-number"> Page 7 of 23 </span>
     
        <a class="older-posts" href="/page8/" title="Next Page">Older Posts &raquo;</a>
     
</nav>
    </div>

    

    <article class="post">
        <header class="post-header">
            <h2 class="post-title"><a href="/writings/i-think-you-mean-a-many-to-one-sir">I think you mean a many-to-one, sir</a></h2>
        </header>
        <section class="post-excerpt">
            <blockquote>
  <p>This is a question that crops up <strong>a lot</strong>, in various forms, on the <a href="http://www.fluentnhibernate.org">Fluent NHibernate</a> and <a href="http://groups.google.com/group/nhusers">NHibernate Users</a> mailing lists. <em>My one-to-one mapping isn’t working, what’s wrong?</em> aka Incorrectly using a one-to-one relationship when you actually need a many-to-one.</p>
</blockquote>

<p>There’s a common misunderstanding where people try to use a one-to-one relationship where a many-to-one is appropriate. I believe this is because people tend to get tunnel vision when designing their entities, which leads them to make incorrect assumptions. They focus on one entity at a time, and when that has a single entity related to it, they jump to the conclusion it’s a one-to-one they need; after all, there’s their current entity (one) and the related entity (to-one). They’re actually forgetting that there can be multiple instances of their <em>current entity</em>.</p>

<p>There’s also a big distinction between what’s possible in the domain, and what’s possible by design in the database; for example, two businesses may <strong>never</strong> share an address in your application, but in the database there’s nothing stopping two rows in the Business table from referencing the same address row in the database. This is logic that can be applied on-top of a database design, but there’s nothing in the underlying pattern to disallow it.</p>

<h2 id="manytoone">Many-to-one</h2>

<p>Lets have a look at what actually is a many-to-one. Here’s a small database schema and the related entity.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">table</span> <span class="n">Customer</span> <span class="p">(</span>
  <span class="n">Id</span> <span class="n">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">Name</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
  <span class="n">AddressId</span> <span class="n">int</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">Address</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">table</span> <span class="n">Address</span> <span class="p">(</span>
  <span class="n">Id</span> <span class="n">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">Number</span> <span class="n">int</span><span class="p">,</span>
  <span class="n">Street</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">public</span> <span class="k">class</span> <span class="n">Customer</span>
<span class="err">{</span>
  <span class="k">public</span> <span class="n">int</span> <span class="n">Id</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
  <span class="k">public</span> <span class="n">string</span> <span class="n">Name</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
  <span class="k">public</span> <span class="n">Address</span> <span class="n">Address</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
<span class="err">}</span>
</code></pre>
</div>

<p>This is a standard many-to-one relationship, many <code>Customers</code> to one <code>Address</code>; the tables are linked by the <code>AddressId</code> key in the <code>Customer</code> table. You can see how people can misinterpret this as a one-to-one relationship when designing the Customer entity; the customer has one address, so it must be a one-to-one. People forget about this scenario:</p>

<table class="db-table">
  <caption>Customer</caption>
  <thead>
    <tr>
      <th>Id</th>
      <th>Name</th>
      <th>AddressId</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Plumbers</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Joiners</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Roofers</td>
      <td>1</td>
    </tr>
  </tbody>
</table>

<table class="db-table">
  <caption>Address</caption>
  <thead>
    <tr>
      <th>Id</th>
      <th>Number</th>
      <th>Street</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>23</td>
      <td>Baker St.</td>
    </tr>
    <tr>
      <td>2</td>
      <td>47</td>
      <td>Jefferson Ave.</td>
    </tr>
  </tbody>
</table>

<p>That is, the first and third customer both reference the first address.</p>

<h2 id="onetoone">One-to-one</h2>

<p><strong>So what actually is a one-to-one relationship then?</strong> A one-to-one is a relationship between two tables that share a mutually exclusive primary key value.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">table</span> <span class="n">Customer</span> <span class="p">(</span>
  <span class="n">Id</span> <span class="n">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">Name</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="p">)</span>

<span class="k">table</span> <span class="n">Address</span> <span class="p">(</span>
  <span class="n">Id</span> <span class="n">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">Number</span> <span class="n">int</span><span class="p">,</span>
  <span class="n">Street</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">public</span> <span class="k">class</span> <span class="n">Customer</span>
<span class="err">{</span>
  <span class="k">public</span> <span class="n">int</span> <span class="n">Id</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
  <span class="k">public</span> <span class="n">string</span> <span class="n">Name</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
  <span class="k">public</span> <span class="n">Address</span> <span class="n">Address</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
<span class="err">}</span>
</code></pre>
</div>

<p>You can see in this design <code>Customer</code> has no direct reference to <code>Address</code>, the two tables share a primary key value; so there would be a record in <code>Customer</code> with a primary key of <code>1</code>, and a record in <code>Address</code> that also has a primary key of <code>1</code>. It’s fairly common to have the primary key on the second table (<code>Address</code> in our case) be manually inserted on creation of a record in the first, so it may only be the first table that has a true auto-incrementing primary key.</p>

<p>It’s also noticeable that both examples have exactly the same class design, this probably contributes to the confusion too, as it’s not immediately clear from the class what kind of relationship it is.</p>

<p>So just remember this: <strong>if you think you’re mapping a one-to-one, you probably aren’t!</strong> It’s pretty uncommon to find a one-to-one relationship in a properly designed schema, 90% of the time it’ll be a many-to-one you need.</p>

 <a class="read-more" href="/writings/i-think-you-mean-a-many-to-one-sir">Read more &raquo;</a>
        </section>
        <footer class="post-meta">
            
            
            <time class="post-date" datetime="2009-01-27">
                27 Jan 2009
            </time>
        </footer>
    </article>

    

    <article class="post">
        <header class="post-header">
            <h2 class="post-title"><a href="/writings/introduction-to-static-reflection">Introduction to static reflection</a></h2>
        </header>
        <section class="post-excerpt">
            <blockquote>
  <p>This post could’ve also been called “Fluent NHibernate secrets exposed!” but it sounded a bit sensationalist.&lt;/blockquote&gt;</p>

  <p>You may have heard people mention static reflection recently, quite possibly because it’s used extensively in <a href="http://www.fluentnhibernate.org">Fluent NHibernate</a>, <a href="http://ayende.com/projects/rhino-mocks.aspx">Rhino Mocks</a>, and I believe <a href="http://www.lostechies.com/blogs/jimmy_bogard/">Jimmy Bogard’s</a> new <a href="http://www.codeplex.com/AutoMapper">AutoMapper</a> also uses it; pretty much any of the new “fluent” interfaces use some kind of static reflection.</p>

  <p><strong>So what actually is static reflection?</strong> Well, it’s a statically compiled way of utilising the Reflection API.</p>

  <p>Traditionally, if you wanted to use the Reflection API to interrogate your classes, you’d need to utilise strings to refer to properties and methods; this can make your design quite brittle, because you have to make sure these strings are kept up-to-date whenever you rename anything. What’s worse is that because reflection is late-bound, you aren’t aware of the problems until the code is actually executed, so this renaming could introduce hidden bugs that don’t appear until runtime. With the growing popularity of refactoring techniques, it’s becoming more important that we can use reflection without having to worry about this problem.</p>

  <blockquote>
    <p>It’s very true that tools like Resharper can certainly help with refactoring reflection-based code, but none of them are perfect and they only help the people that use them.</p>
  </blockquote>

  <p>In C# 3 we were introduced to lambda expressions and Linq, and with them came the <code>Func&lt;&gt;</code> and <code>Expression&lt;&gt;</code> classes; these are the key to static reflection. The <code>Func&lt;&gt;</code> set of classes allow you to use lambda expressions that return a value, while an <code>Expression&lt;&gt;</code> can be used to programatically access the contents of a delegate.</p>

  <p>Combining <code>Func&lt;&gt;</code> and <code>Expression&lt;&gt;</code> can give us a very powerful way to statically retrieve <code>PropertyInfo</code> (and similar) instances from a lambda expression. For example <code>Expression&lt;Func&lt;Customer, object&gt;&gt;</code> represents an expression that contains a delegate that returns a value (of type object), with a <code>Customer</code> parameter; I’ll illustrate:</p>

  <div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// method to receive an expression
</span><span class="k">public</span> <span class="n">PropertyInfo</span> <span class="n">GetProperty</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">)</span>

<span class="c1">// usage
</span><span class="n">GetProperty</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;(</span><span class="n">customer</span> <span class="p">=&gt;</span> <span class="n">customer</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</code></pre>
  </div>

  <p>What this is actually doing is creating a lambda that returns a value, the value of <code>customer.Name</code> in this case. Here’s the trick, we don’t actually care about the value that’s returned! In-fact, we don’t even evaluate this expression at all.</p>

  <blockquote>
    <p>The reason we use <code>object</code> in the <code>Func</code> signature, rather than a more specific type, is because we want to allow <em>any</em> property to be used; however, if you were only interested in <code>string</code> properties, then you could restrict it by replacing this parameter.</p>
  </blockquote>

  <p>The <code>Expression</code> API itself is very in-depth, so I won’t go into the intricacies of it but here’s a very simple implementation of static reflection.</p>

  <div class="highlighter-rouge"><pre class="highlight"><code><span class="k">public</span> <span class="n">PropertyInfo</span> <span class="n">GetProperty</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">var</span> <span class="n">memberExpression</span> <span class="p">=</span> <span class="n">expression</span><span class="p">.</span><span class="n">Body</span> <span class="k">as</span> <span class="n">MemberExpression</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">memberExpression</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"Not a member access."</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">memberExpression</span><span class="p">.</span><span class="n">Member</span> <span class="k">as</span> <span class="n">PropertyInfo</span><span class="p">;</span> <span class="c1">// Should account for FieldInfo too
</span><span class="p">}</span>
</code></pre>
  </div>

  <p>Stepping through this code, we start by getting the body of the expression which we cast to a <code>MemberExpression</code>; this is us grabbing the <code>customer.Name</code> part of our expression. Now we can get the member itself and cast it to a <code>PropertyInfo</code>, this is the <code>Name</code> part of the expression body. That’s it! We’ve not evaluated the expression, but we’ve inspected it and retrieved the property.</p>

  <blockquote>
    <p>This example is for illustrative purposes, there are many different types of expressions which would be excluded by this. If you are to implement your own static reflection parser, you should cater for these other types of expressions.</p>
  </blockquote>

  <p>As this example shows, we’re able to use reflection without having to resort to strings. The great thing about this is that if you change the name of a member inside a lambda, you’ll get a compile error if you haven’t updated all the references! No more hidden bugs.</p>

  <p>So that’s how the magic behind Fluent NHibernate (and others) works, simple when you know how!</p>

</blockquote>
 <a class="read-more" href="/writings/introduction-to-static-reflection">Read more &raquo;</a>
        </section>
        <footer class="post-meta">
            
            
            <time class="post-date" datetime="2009-01-26">
                26 Jan 2009
            </time>
        </footer>
    </article>

    

    <article class="post">
        <header class="post-header">
            <h2 class="post-title"><a href="/writings/fluent-nhibernate-auto-mapping-and-base-classes">Fluent NHibernate: Auto mapping and base-classes</a></h2>
        </header>
        <section class="post-excerpt">
            <p>Carrying on with the <a href="http://www.fluentnhibernate.org">Fluent NHibernate</a> Auto Mapping theme, I’ll now demonstrate how to map inheritance hierarchies.</p>

<p>There are two main things that you’d want to do with inherited classes, either ignore the base class all together, or map them using an inheritance strategy. I’m going to start with the former, then move on to the latter.</p>

<h2 id="ignoring_basetypes">Ignoring base-types</h2>

<p>This scenario is where you may have a base class in your domain that you use to simplify your entities, you’ve moved common properties into it so you don’t have to recreate them on every entity; typically this would be the Id and perhaps some audit information. So lets start with a model that has a base class we’d like to ignore.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Entities</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Entity</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span> <span class="p">:</span> <span class="n">Entity</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">class</span> <span class="nc">Animal</span> <span class="p">:</span> <span class="n">Entity</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Species</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Relatively simple model here, we’ve got an <code>Entity</code> base class that defines the <code>Id</code>, then the <code>Person</code> and <code>Animal</code> entities. We have no desire to have <code>Entity</code> mapped by NHibernate, so we need a way to tell the auto mapper to ignore it.</p>

<p>For those individuals from traditional XML mapping land, this is what we’re going to be recreating:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;class</span> <span class="na">name=</span><span class="s">"Person"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"Id"</span> <span class="na">type=</span><span class="s">"Int32"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;generator</span> <span class="na">class=</span><span class="s">"identity"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/id&gt;</span>
  
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"FirstName"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"LastName"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/class&gt;</span>
    
<span class="nt">&lt;class</span> <span class="na">name=</span><span class="s">"Animal"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"Id"</span> <span class="na">type=</span><span class="s">"Int32"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;generator</span> <span class="na">class=</span><span class="s">"identity"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/id&gt;</span>

  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"Species"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/class&gt;</span>
</code></pre>
</div>

<p>We need to initialise the NHibernate configuration, and supply it with any auto mappings we’re going to create:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>  
  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;()</span>  
  <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="s">"Entities"</span><span class="p">);</span>  

<span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Configuration</span><span class="p">()</span>  
  <span class="p">.</span><span class="nf">AddProperty</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">,</span> <span class="n">ApplicationConnectionString</span><span class="p">)</span>  
  <span class="p">.</span><span class="nf">AddAutoMappings</span><span class="p">(</span><span class="n">autoMappings</span><span class="p">)</span>  
  <span class="p">.</span><span class="nf">BuildSessionFactory</span><span class="p">();</span>
</code></pre>
</div>

<p>The first section is the configuration of Fluent NHibernate, which we’re telling to map anything in the <code>Entities</code> namespace from the assembly that contains our <code>Entity</code> base-class; then we configure NHibernate and inject our auto mappings.</p>

<p>If we were to run this now, we wouldn’t get the mapping we desire. Fluent NHibernate would see <code>Entity</code> as an actual entity and map it with <code>Animal</code> and <code>Person</code> as subclasses; this is not what we desire, so we need to modify our auto mapping configuration to reflect that.</p>

<p>After <code>MapEntitiesFromAssemblyOf<entity>()&lt;/code&gt; we need to alter the conventions that the auto mapper is using so it can identify our base-class.</entity></code></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>  
  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;()</span>
  <span class="p">.</span><span class="nf">WithConventions</span><span class="p">(</span><span class="n">convention</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="n">convention</span><span class="p">.</span><span class="n">IsBaseType</span> <span class="p">=</span>
      <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Entity</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="s">"Entities"</span><span class="p">);</span>
</code></pre>
</div>

<p>We’ve added the <code>WithConventions</code> call in which we replace the <code>IsBaseType</code> convention with our own. This convention is used to identify whether a type is simply a base-type for abstraction purposes, or a legitimate storage requirement. In our case we’ve set it to return <code>true</code> if the type is an <code>Entity</code>.</p>

<p>With this change, we now get our desired mapping. <code>Entity</code> is ignored as far is Fluent NHibernate is concerned, and all the properties (<code>Id</code> in our case) are treated as if they were on the specific subclasses.</p>

<h2 id="basetype_as_an_inheritance_strategy">Base-type as an inheritance strategy</h2>

<p>What we’re going to do is create a simple model that we’ll map as a <a href="http://www.hibernate.org/hib_docs/nhibernate/html/inheritance.html">table-per-subclass</a> inheritance strategy, which is the equivalent of the NHibernate <code>joined-subclass</code> mapping.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Entities</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">class</span> <span class="nc">Employee</span> <span class="p">:</span> <span class="n">Person</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="n">DateTime</span> <span class="n">StartDate</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">class</span> <span class="nc">Guest</span> <span class="p">:</span> <span class="n">Person</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">GuestPassId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Relatively simple model here, we’ve got an <code>Person</code> class that defines the <code>Id</code> and name properties, then the <code>Employee</code> and <code>Guest</code> subclass entities.</p>

<p>The XML equivalent is as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;class</span> <span class="na">name=</span><span class="s">"Person"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">"Id"</span> <span class="na">type=</span><span class="s">"Int32"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;generator</span> <span class="na">class=</span><span class="s">"identity"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/id&gt;</span>
  
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"FirstName"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"LastName"</span> <span class="nt">/&gt;</span>
  
  <span class="nt">&lt;joined-subclass</span> <span class="na">name=</span><span class="s">"Employee"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;key</span> <span class="na">column=</span><span class="s">"PersonId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"StartDate"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joined-subclass&gt;</span>
    
  <span class="nt">&lt;joined-subclass</span> <span class="na">name=</span><span class="s">"Guest"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;key</span> <span class="na">column=</span><span class="s">"PersonId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"GuestPassId"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joined-subclass&gt;</span>
<span class="nt">&lt;/class&gt;</span>
</code></pre>
</div>

<p>Again we configure NHibernate session factory to integrate with the auto mapping:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>  
  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>  
  <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="s">"Entities"</span><span class="p">);</span>  

<span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Configuration</span><span class="p">()</span>  
  <span class="p">.</span><span class="nf">AddProperty</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">,</span> <span class="n">ApplicationConnectionString</span><span class="p">)</span>  
  <span class="p">.</span><span class="nf">AddAutoMappings</span><span class="p">(</span><span class="n">autoMappings</span><span class="p">)</span>  
  <span class="p">.</span><span class="nf">BuildSessionFactory</span><span class="p">();</span>
</code></pre>
</div>

<p>This is the same configuration that I used in the first example, except that if you recall the reason we had to change the last example was because it was mapping it as a joined-subclass - that’s right, we don’t need to do anything now! Our mapping is complete, Fluent NHibernate automatically assumes that any inherited classes (that haven’t had their base-type excluded by the <code>IsBaseType</code> convention) should be mapped as joined-subclasses.</p>

<p>That’s how to deal with base-classes with Fluent NHibernate’s auto mapping.</p>

 <a class="read-more" href="/writings/fluent-nhibernate-auto-mapping-and-base-classes">Read more &raquo;</a>
        </section>
        <footer class="post-meta">
            
            
            <time class="post-date" datetime="2009-01-26">
                26 Jan 2009
            </time>
        </footer>
    </article>

    

    <article class="post">
        <header class="post-header">
            <h2 class="post-title"><a href="/writings/fluent-nhibernate-auto-mapping-components">Fluent NHibernate: Auto Mapping Components</a></h2>
        </header>
        <section class="post-excerpt">
            <blockquote>
  <p><strong>Notice:</strong> The content in this post may be out of date, please refer to the <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Auto-mapping">Auto Mapping</a> page in the <a href="https://github.com/jagregory/fluent-nhibernate/wiki">Fluent NHibernate Wiki</a> for the latest version.&lt;/p&gt;</p>
</blockquote>

<p>I’ve just committed a change that should allow automatic mapping of simple components; by simple, I mean components that just map properties, nothing fancy. I’ll be looking to expand this functionality in the future, but for the time being any kind of relationships aren’t supported within components. With that in mind, I’ll walk through how to automap your components.</p>

<p>Lets imagine this database structure:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">table</span> <span class="n">Person</span> <span class="p">(</span>
  <span class="n">Id</span> <span class="n">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">Name</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
  <span class="n">Address_Number</span> <span class="n">int</span><span class="p">,</span>
  <span class="n">Address_Street</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
  <span class="n">Address_PostCode</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">)</span>
</code></pre>
</div>

<p>We want to map that to the following model:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Domain</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="n">Address</span> <span class="n">Address</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">namespace</span> <span class="nn">Domain.Components</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">class</span> <span class="nc">Address</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Number</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Street</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">PostCode</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>With this design, <code>Address</code> is actually a component, which isn’t a full entity, more of a way of providing a clean model to a normalised database structure. I’ll get started by setting up the auto-mapper.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>
  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
  <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">type</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">Namespace</span><span class="p">.</span><span class="nf">EndsWith</span><span class="p">(</span><span class="s">"Domain"</span><span class="p">));</span>

<span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Configuration</span><span class="p">()</span>  
  <span class="p">.</span><span class="nf">AddProperty</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">,</span> <span class="n">ApplicationConnectionString</span><span class="p">)</span>  
  <span class="p">.</span><span class="nf">AddAutoMappings</span><span class="p">(</span><span class="n">autoMappings</span><span class="p">)</span>  
  <span class="p">.</span><span class="nf">BuildSessionFactory</span><span class="p">();</span>
</code></pre>
</div>

<p>That’s our auto mappings integrated with NHibernate. Next we need to instruct the auto mapper in how to identify components; after the <code>Where</code> call, we can add a call to <code>WithConvention</code> which is where we’ll give it a hand.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">.</span><span class="nf">WithConvention</span><span class="p">(</span><span class="n">convention</span> <span class="p">=&gt;</span>
<span class="p">{</span>
  <span class="n">convention</span><span class="p">.</span><span class="n">IsComponentType</span> <span class="p">=</span>
    <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Namespace</span><span class="p">.</span><span class="nf">EndsWith</span><span class="p">(</span><span class="s">"Domain.Components"</span><span class="p">);</span>
<span class="p">})</span>
</code></pre>
</div>

<p>The <code>IsComponentType</code> convention is what Fluent NHibernate uses to determine whether a type is one that will be mapped as a component, rather than a full entity.</p>

<p>There are two things you need to know about this convention:</p>

<ol>
<li>You can only set this convention once, so you&#8217;ll need to use it in a way that allows you to identify multiple component types with it; there are several options to this, including using the namespace (the above example), or checking a suffix on the type name (anything that ends in &#8220;Component&#8221;, for example).</li>

<li>This is not an exclusive call, so you need to segregate your component types from your standard entity types (so they&#8217;ll be excluded by the <code>Where</code> call), otherwise they&#8217;ll be auto-mapped as full entities as well as components - <em>not good</em>. I've done that in this example by separating components into their own namespace.</li>
</ol>

<p>With that, the <code>Address</code> should now be automatically mapped as a component; the auto mapper will pick up the three properties and map them as properties on the component.</p>

<p>There’s one more thing, for illustrative purposes I’ve deliberately gone against Fluent NHibernate’s inbuilt convention for naming columns. By default any columns mapped in a convention will be prefixed with their property name, so <code>person.HomeAddress.Street</code> would be mapped against a column called <code>HomeAddressStreet</code>; this is my personal preference, but not what our database contains! We can control how our columns are named by altering the <code>GetComponentColumnPrefix</code> convention, like so:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">.</span><span class="nf">WithConvention</span><span class="p">(</span><span class="n">convention</span> <span class="p">=&gt;</span>
<span class="p">{</span>
  <span class="n">convention</span><span class="p">.</span><span class="n">IsComponentType</span> <span class="p">=</span>
    <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Address</span><span class="p">);</span>
  <span class="n">convention</span><span class="p">.</span><span class="n">GetComponentColumnPrefix</span> <span class="p">=</span>
    <span class="n">property</span> <span class="p">=&gt;</span> <span class="n">property</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">"_"</span><span class="p">;</span>
<span class="p">})</span>
</code></pre>
</div>

<p>The convention now specifies that columns should be named ComponentPropertyName_PropertyName, so <code>person.Address.Street</code> is now correctly mapped against <code>Address_Street</code>.</p>

<p>Magic.</p>

<h4>Update:</h4>
<p>I’ve updated this post to reflect some recent changes whereby the <code>GetComponentColumnPrefix</code> convention was updated to use the component property instead of the component type. This is to allow for multiple component properties on an entity that are of the same type. If you still need to use the type you can access it through the <code>PropertyInfo</code> parameter.</p>

 <a class="read-more" href="/writings/fluent-nhibernate-auto-mapping-components">Read more &raquo;</a>
        </section>
        <footer class="post-meta">
            
            
            <time class="post-date" datetime="2009-01-19">
                19 Jan 2009
            </time>
        </footer>
    </article>

    

    <article class="post">
        <header class="post-header">
            <h2 class="post-title"><a href="/writings/fluent-nhibernate-mapping-private-and-protected-properties">Fluent NHibernate: Mapping private and protected properties</a></h2>
        </header>
        <section class="post-excerpt">
            <blockquote>
  <p><strong>Notice:</strong> The content in this post may be out of date, please refer to the <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Fluent-mapping">Fluent Mapping</a> page in the <a href="https://github.com/jagregory/fluent-nhibernate/wiki">Fluent NHibernate Wiki</a> for the latest version.</p>
</blockquote>

<p>There’s been a point of contention for some users of <a href="http://www.fluentnhibernate.org">Fluent NHibernate</a> since the beginning, and that’s the lack of a method of mapping private and protected properties on their domain entities.</p>

<p>The issue stems from our use of lambda expressions for static reflection of your entities, one of the appealing properties of Fluent NHibernate; by utilising expressions we’re able to protect your mappings from refactoring side-effects. However, lambda expressions can only reference properties that are public on an object, so that makes it difficult to use against protected or private properties.</p>

<p>None of the solutions we have are ideal, we’ll be the first to admit that; but considering Fluent NHibernate was never designed to support these situations, and the limitations C# imposes on us, we’ve got some pretty reasonable choices. Each option comes with it’s own compromises, so it’s important you pick the method that has the compromises you’re more willing to accept; I’ll outline the pros and cons of each approach.</p>

<h2 id="nested_expression_exposition_class">Nested expression exposition class</h2>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  
  <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Expressions</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="n">ProductMap</span> <span class="p">:</span> <span class="n">ClassMap</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">ProductMap</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">Id</span><span class="p">(</span><span class="n">Product</span><span class="p">.</span><span class="n">Expressions</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This option takes advantage of an interesting side effect of nested class scope and access modifiers. If you haven’t done something like this before, basically nested classes can access their parent’s private/protected members. We create a nested static class that exposes an <code>Expression</code> for each hidden member. We can then use the expressions declared in this static class to reflect against the hidden members. It’s reasonably clean, made even more so if you separate the <code>Expressions</code> class into a partial class of your entity; so you could have <code>Product.cs</code> and <code>ProductExpressions.cs</code>.</p>

<h3 id="pros">Pros</h3>
<ul><li>Refactoring friendly</li><li>Mappings still readable</li></ul>

<h3 id="cons">Cons</h3>
<ul><li>Modification to entities required</li><li>Need 3 classes to map an entity (entity, expression class, and mapping)</li></ul>

<h2 id="nested_mapping">Nested mapping</h2>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  
  <span class="k">public</span> <span class="n">ProductMap</span> <span class="p">:</span> <span class="n">ClassMap</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="nf">ProductMap</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="nf">Id</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Again using the scope trick, you can wrap your mapping inside your entity. This allows you to use the expressions as normal, without having to do any expression tricks. Like the expression class previously, this can be made neater by using partial classes.</p>

<h3 id="pros">Pros</h3>
<ul><li>Refactoring friendly</li><li>Can use normal expressions</li></ul>

<h3 id="cons">Cons</h3>
<ul><li>Modification to entities required</li><li>Mapping nested in entity, so can&#8217;t be separated across assemblies/namespaces</li></ul>

<h2 id="reveal_and_string_names">Reveal static class and string-based names</h2>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="n">ProductMap</span> <span class="p">:</span> <span class="n">ClassMap</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">ProductMap</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">Id</span><span class="p">(</span><span class="n">Reveal</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="s">"Id"</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Our final option is different to the previous two, in that it utilises an expression generator to create an expression for a private or protected member. This is essentially what the first two are doing, just with strings instead of nesting tricks.</p>

<h3 id="pros">Pros</h3>
<ul><li>No modifications to entities needed</li><li>Mappings and entity remain separate</li></ul>

<h3 id="cons">Cons</h3>
<ul><li>Potential renaming issues</li></ul>

<h2 id="conclusion">Conclusion</h2>

<p>You have the power, now pick the one that suits you best. Compile time safety, or entity purity? You’re now free to make the decision, instead of us.</p>

<p>I don’t think anyone on the Fluent NHibernate team is particularly happy with that we have to write these hacks, but we’re doing the best with what we’ve got. We all have different preferences, but at least there’s something for everyone now.</p>

 <a class="read-more" href="/writings/fluent-nhibernate-mapping-private-and-protected-properties">Read more &raquo;</a>
        </section>
        <footer class="post-meta">
            
            
            <time class="post-date" datetime="2009-01-13">
                13 Jan 2009
            </time>
        </footer>
    </article>

    

    <nav class="pagination" role="pagination">
    
        
            <a class="newer-posts" href="/page6/" title="Previous Page">&laquo; Newer Posts</a>
      
    
    <span class="page-number"> Page 7 of 23 </span>
     
        <a class="older-posts" href="/page8/" title="Next Page">Older Posts &raquo;</a>
     
</nav>

</main>

    <footer class="site-footer clearfix">
      <section class="copyright">
        <a href="mailto:james@jagregory.com">James Gregory</a> &copy;
               &bull; All content licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">cc by-nc-sa 4.0</a>.
      </section>
    </footer>

    <script type="text/javascript" src="/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/js/index.js"></script>
</body>
</html>
