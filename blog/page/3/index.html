
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>James Gregory</title>
  <meta name="author" content="James Gregory">

  
  <meta name="description" content="Just been totting up some figures on how Fluent NHibernate is doing, thought I&#8217;d share them with anyone that&#8217;s interested. These are very &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.jagregory.com/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="James Gregory" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Cardo:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3186192-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<logo>

<img src="/logo.png" alt="Website Logo. Upload to /source/logo.png ; disable in /source/_includes/logo.html" height="32px" width="32px">
</logo>



<body >
  <header role="banner"><hgroup>
  <h1><a href="/">James Gregory</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

<br>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.jagregory.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<!--
<ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
-->

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/fluent-nhibernate-usage-stats/">Fluent NHibernate Usage Stats</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-03-21T00:00:00+11:00" pubdate data-updated="true">Mar 21<span>st</span>, 2009</time>
        
           | <a href="/writings/fluent-nhibernate-usage-stats/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/fluent-nhibernate-usage-stats/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content">Just been totting up some figures on how <a href="http://fluentnhibernate.org">Fluent NHibernate</a> is doing, thought I&#8217;d share them with anyone that&#8217;s interested.

<blockquote>These are very rough figures, generated with no scientific consistency, some are cumulative and others are based just on the last full month. They&#8217;re more just to satisfy my curiosity than to be rigorously accurate.</blockquote>

<table>
  <tr>
    <td>Downloads</td>
    <td>1,800 per month</td>
  </tr>
  <tr>
    <td>Unique visitors</td>
    <td>5,500 per month</td>
  </tr>
  <tr>
    <td>Page views</td>
    <td>13,000 per month</td>
  </tr>
  <tr>
    <td>Mailing list messages</td>
    <td>450 per month</td>
  <tr>
    <td>Commits</td>
    <td>45 per month</td>
  </tr>
</table>

Something else that&#8217;s interesting is of those 5,500 visitors/13,000 page views, 66% are coming directly from google, 4% directly, then the other 30% from referrers. Those referrers are broken down into (from highest to lowest): <a href="http://stackoverflow.com">Stack Overflow</a>, <a href="http://blog.jagregory.com">my blog</a>, <a href="http://pnpguidance.net">pnpguidance.net</a>, <a href="http://nhforge.org">nhforge</a>, then quite a few other sites forming the lower percentages. I&#8217;m surprised at how high Stack Overflow is, I guess it pays that I pay attention to questions asked about Fluent on there.

Those download numbers are probably not representative either as they&#8217;re only of the zip files, while I believe the vast majority of people run off the trunk through Subversion, so it&#8217;s hard to count them.
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/docu-2-days/">Docu + 2 Days</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-03-21T00:00:00+11:00" pubdate data-updated="true">Mar 21<span>st</span>, 2009</time>
        
           | <a href="/writings/docu-2-days/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/docu-2-days/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&#8217;s been two days since I <a href="/writings/introducing-docu-simple-doc-gen-for-net/">announced</a> <a href="http://docu.jagregory.com">docu</a>, my simple documentation generator for .Net apps.</p>

<p>The reception it&#8217;s received has been positive, I never expected it to have a surge of popularity because it&#8217;s not that kind of tool, so it hasn&#8217;t come as much of a surprise that people haven&#8217;t been jumping all over it. Having said that though, I have had some good feedback and already someone has contributed a patch. Additionally, there hasn&#8217;t been one question as to why I&#8217;ve created it; now this has come as a surprise, I guess I&#8217;m <strong>not</strong> the only one that feels Sandcastle is bloated and overcomplicated. Yay!</p>

<p>I&#8217;ve just pushed out some changes to the <a href="http://github.com/jagregory/docu">github repos</a> and released an updated alpha (v0.1.0.2) on the <a href="http://docu.jagregory.com/downloads">downloads page</a>. The biggest changes so far are the inclusion of events and fields in the parsing, which now means docu has <code>&lt;summary /&gt;</code> support for all documentable members. The rest of the changes are mainly refactorings and some battle-hardening.</p>

<p>I&#8217;ve got some more changes and several issues lined up, so keep an eye out.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/introducing-docu-simple-doc-gen-for-net/">Introducing Docu - Simple Doc Gen for .Net</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-03-19T00:00:00+11:00" pubdate data-updated="true">Mar 19<span>th</span>, 2009</time>
        
           | <a href="/writings/introducing-docu-simple-doc-gen-for-net/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/introducing-docu-simple-doc-gen-for-net/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Lets look at a recent Twitter conversation of mine:</p>

<ul>
<li>Anyone have any tips on generating html docs from XML comments? Used to do it years ago with NDoc <a href='http://twitter.com/jagregory/status/1312895270'>?</a></li>

<li>Man, sandcastle is so overly complex <a href='http://twitter.com/jagregory/status/1313079815'>?</a></li>

<li>Sandcastle examples don&#8217;t even work. This is shit. <a href='http://twitter.com/jagregory/status/1313167377'>?</a></li>

<li>Why isn&#8217;t sandcastle just a console app that takes a list of dlls and spits out html/chm? What&#8217;s with all the batch files and XslTransforms? <a href='http://twitter.com/jagregory/status/1313112789'>?</a></li>

<li>@AndrewNStewart Well Sandcastle requires chaining together several calls to 3+ applications before you get anything. <a href='http://twitter.com/jagregory/status/1315443964'>?</a></li>

<li>Are these Sandcastle generated MSDN-style API docs actually useful to anyone? <a href='http://twitter.com/jagregory/status/1315364767'>?</a></li>

<li>@pollingj It&#8217;s a dilemma. I don&#8217;t care about API docs, but people seem to want it, but I&#8217;m reluctant to generate msdn-like shit. Dilemma. <a href='http://twitter.com/jagregory/status/1315455082'>?</a></li>
</ul>

<p>So as you can see, dilemma. People want API documentation (for <a href='http://fluentnhibernate.org'>Fluent NHibernate</a> specifically), but I don&#8217;t want to associate myself with the awful MSDN-style documentation that&#8217;s produced by Sandcastle.</p>

<blockquote>
<p>Before you get all hot under the collar, if you like Sandcastle, or you like MSDN-style documentation, leave now. Use what works for you, it doesn&#8217;t work for me so I&#8217;m not using it, but I don&#8217;t want to stop you using it.</p>

<p>I realise the market for this tool is probably pretty small, but it&#8217;s useful to me so it might be useful to you.</p>
</blockquote>

<p>Introducing <a href='http://docu.jagregory.com'>docu</a>, the simple documentation generator for .Net!</p>

<p>Docu is a tool that produces an html site (or rather, a collection of html pages) from the doc-comments you include in your code. Given an assembly and the Visual Studio produced XML of the comments, docu will produce a completely static collection of pages that you can publish anywhere you like. You run it through one command-line tool, with one parameter. That&#8217;s it, nothing complicated.</p>

<p><code style="background: #CCC;color: #000;padding: 2px;">docu your-assembly.dll</code></p>

<p>You can see an example of the default style that&#8217;s provided in the Fluent NHibernate <a href='http://fluentnhibernate.org/api/index.htm'>API docs</a> (the colour scheme has been modified, but everything else is default).</p>

<p>Docu is completely stand alone, no GAC deployed assemblies, no hard-coded paths, no nothing. This makes it trivial to use docu in your CI process for building up-to-the-second API docs for publishing or downloading.</p>

<p>The templates that docu uses are created with the <a href='http://sparkviewengine.com'>Spark view engine</a> which means you have all the power of C# and it&#8217;s templating language at your finger-tips. If you&#8217;re particularly picky about appearance (like I am) then you can completely rewrite the templates to your heart&#8217;s content. There&#8217;s no imposed structure or style, it&#8217;s all customisable through the templates. You can read more about customising templates on the site: <a href='http://docu.jagregory.com/customising-templates'>customising templates</a>.</p>

<p>An interesting little feature of the templating system is <em>special names</em> for directories and files, for example if you name a template <code>!namespace.spark</code>, a html page will be produced for a each namespace in your assembly using that template. This allows you to do things like create a directory for each namespace, with a page for each type in that namespace inside. Pretty powerful!</p>

<p>The codebase is reasonably well structured, but the code itself is a bit untidy. Luckily it&#8217;s covered by nearly 200 unit tests (so far) and i&#8217;ll be leveraging them to improve the code quality over time. You can checkout the code from the <a href="http://github.com/jagregory/docu">docu github repo</a>.</p>

<p>It&#8217;s early days yet, there&#8217;s very little customisation of the documentation process (the part that actually finds the types and members to document), and not all comment types are supported yet; however, it&#8217;s used for Fluent NHibernate and works pretty well. It&#8217;s only Alpha right now, so you shouldn&#8217;t expect the world.</p>

<p>So if this kind-of thing interests you, go have a read of the <a href='http://docu.jagregory.com'>docu website</a> and let me know how it works out for you.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/fluent-nhibernate-conventions-rewrite/">Fluent NHibernate: Conventions Rewrite</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-03-11T00:00:00+11:00" pubdate data-updated="true">Mar 11<span>th</span>, 2009</time>
        
           | <a href="/writings/fluent-nhibernate-conventions-rewrite/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/fluent-nhibernate-conventions-rewrite/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve just committed a rather large update to the Fluent NHibernate conventions code. This post explains why I&#8217;ve done this, and gives you some starting points to update your code. Anything else you need can be found on the <a href="https://github.com/jagregory/fluent-nhibernate/wiki">wiki</a> under <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Conventions">conventions</a> and <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Converting-to-new-style-conventions">converting to new-style conventions</a>.</p>




<p><strong>So why have I rewritten conventions?</strong> Our original implementation was simple, but not really maintainable into the future. It was a single class that was a major violation of separation of concerns, and it just kept growing and growing. It didn&#8217;t gracefully degrade either; if we didn&#8217;t have the exact convention you needed it was tough luck, there was very little you could do short of modifying the code yourself.</p>




<p>Our original design worked something like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">WithConventions</span><span class="p">(</span><span class="n">conventions</span> <span class="p">=&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">conventions</span><span class="p">.</span><span class="n">TableName</span> <span class="p">=</span> <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&quot;Table&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">conventions</span><span class="p">.</span><span class="n">DefaultLazy</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>




<p>As you can see, it&#8217;s a fairly simple design. Lambda functions were set that got called in various places throughout the mapping generation cycle. It was a good design for simple scenarios; however, when you start overriding more conventions, and introducing logic into them, it can quickly become a massive ball of mud. So while there was an initial simplicity to it, that simplicity was quickly lost if you were trying to do anything clever with it. This is another thing that the rewrite aims to solve.</p>




<p><strong>So how have things changed?</strong> The ability to define conventions inline is gone, for starters. Instead what you have is a series of interfaces of varying degrees of granularity; any classes implementing any of the interfaces will be automagically hooked into the mapping generation cycle. What this equates to is you&#8217;ll have a folder/namespace in your projects dedicated to conventions, each class making an alteration to the conventions when it&#8217;s called. As each convention is an interface, it means you can implement multiples of them in a single class, which allows you to group common conventions into a single class if you desire.</p>




<h2 id="example_customising_the_table_name">Example: Customising the table name</h2>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">TableNameConvention</span> <span class="p">:</span> <span class="n">IClassConvention</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Accept</span><span class="p">(</span><span class="n">IClassMap</span> <span class="n">classMap</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="c1">// apply to all mappings</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">IClassMap</span> <span class="n">classMap</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// will produce table names like: tbl_Customer, tbl_Product</span>
</span><span class='line'>    <span class="n">classMap</span><span class="p">.</span><span class="n">WithTable</span><span class="p">(</span><span class="s">&quot;tbl_&quot;</span> <span class="p">+</span> <span class="n">classMap</span><span class="p">.</span><span class="n">EntityType</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>This is a simple implementation of the <code>IClassConvention</code> interface, which is applied to all class mappings (hence the <code>return true</code> in <code>Accept</code>) and simply prefixes the table name with <code>tbl_</code>.</p>




<h2 id="example_adding_your_conventions">Example: Adding your conventions</h2>




<p>There&#8217;s one thing you need to do to get Fluent NHibernate to use your conventions, and that&#8217;s to inform the convention discovery mechanism of where it&#8217;s to search for conventions. You do this using the <code>PersistenceModel</code>s <code>CovnentionFinder</code> property, or through the <code>ConventionDiscovery</code> property through <a href="http://wiki.fluentnhibernate.org/show/FluentConfiguration">Fluent Configuration</a>.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Fluently</span><span class="p">.</span><span class="n">Configure</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">FluentMappings</span>
</span><span class='line'>      <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;()</span>
</span><span class='line'>      <span class="p">.</span><span class="n">ConventionDiscovery</span><span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">MyConvention</span><span class="p">&gt;())</span>
</span><span class='line'>  <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>




<p>That&#8217;s all there is to it really, certainly from a users perspective anyway. The architecture is designed in such a way that you have a much greater control of the granularity of your conventions; if you need a convention we haven&#8217;t explicitly supplied, you can use the convention &#8220;above&#8221; the one you want, and implement it yourself. If you need a convention for just Bag collections (which we don&#8217;t have one for), you just need to create an implementation of <code>IHasManyConvention</code> and limit it to bags. Easy.</p>




<h2 id="some_shortcuts">Some shortcuts</h2>




<p>I realise that the new design is more verbose than it was originally, and if your scenario really is one that only uses one or two conventions, then the new design might be too much for you. To cater for you people, I&#8217;ve created some basic inline support. I really don&#8217;t recommend you use these unless you&#8217;re doing something <em>really</em> simple. Separation is always preferred.</p>




<p>There&#8217;s the <code>ConventionBuilder</code> class which has several static properties (<code>Class</code> for example, there&#8217;s one for each convention) which allow you to create an inline convention.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ConventionBuilder</span><span class="p">.</span><span class="n">Class</span><span class="p">.</span><span class="n">Always</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;something&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">))</span>
</span><span class='line'><span class="n">ConventionBuilder</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">Always</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">(</span><span class="s">&quot;ID&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">ConventionBuilder</span><span class="p">.</span><span class="n">Property</span><span class="p">.</span><span class="n">When</span><span class="p">(</span>
</span><span class='line'>  <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Property</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
</span><span class='line'>  <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">Property</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&quot;Num&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<p>These can be used directly in the <code>ConventionDiscovery</code> property mentioned above; it has an <code>Add</code> method that can take a params array of conventions, there&#8217;s also a <code>Setup</code> method which can be used for multiple additions.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">ConventionDiscovery</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span>
</span><span class='line'>  <span class="n">ConventionBuilder</span><span class="p">.</span><span class="n">Class</span><span class="p">.</span><span class="n">Always</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;something&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">)),</span>
</span><span class='line'>  <span class="n">ConventionBuilder</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">Always</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">(</span><span class="s">&quot;ID&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">.</span><span class="n">ConventionDiscovery</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">c</span><span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">MyConvention</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="n">c</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ConventionBuilder</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">Always</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">(</span><span class="s">&quot;ID&quot;</span><span class="p">)));</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>




<p>In addition to that, there&#8217;s a limited selection of very common conventions which can be used inline. Again, I don&#8217;t advocate using these for anything complicated. If you start having logic in your conventions, or even if the lambdas end up being multi-line, I&#8217;d suggest using the full conventions. These helpers live in the <code>FluentNHibernate.Conventions.Helpers</code> namespace.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Table</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="s">&quot;tbl_&quot;</span> <span class="p">+</span> <span class="n">x</span><span class="p">.</span><span class="n">EntityType</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'><span class="n">PrimaryKey</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="s">&quot;ID&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">DynamicUpdate</span><span class="p">.</span><span class="n">AlwaysTrue</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<p>These can be used in the same way as the <code>ConventionBuilder</code> above.</p>




<h2 id="regarding_auto_mapping">Regarding auto mapping</h2>




<p>The auto mapper uses a small subset of conventions to discover various parts of your mappings. It was originally the case that these special conventions were lumped in with the rest of the conventions, even though you couldn&#8217;t use them outside of the automapper. As the old style conventions have gone, the automapper now has a separate set of conventions (they&#8217;re the same ones, just moved) that it uses. So in addition to the <code>ConventionDiscovery</code> property, the auto mapper has a <code>WithSetup</code> method that you can use to configure the auto mapping specific ones (<code>IsBaseType</code> primarily).</p>




<h2 id="further_reading">Further reading</h2>




<p>So this post should have given you a basic introduction to the changes I&#8217;ve made. To go further, you&#8217;re going to have to know what <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Available-conventions">interfaces are available</a> to implement. You should probably also read the <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Convertings">general conventions</a> wiki, how to <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Converting-to-new-style-conventions">convert your existing conventions</a> to the new style, and the <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Convention-shortcut">convention shortcuts</a> if it interests you. For maintainers, or just curious people, there&#8217;s also the wiki on how the <a href="http://wiki.fluentnhibernate.org/show/Conventions">conventions work behind-the-scenes</a>.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/fluent-nhibernate-auto-mapping-overrides-and-alterations/">Fluent NHibernate: Auto Mapping, Overrides and Alterations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-10T00:00:00+11:00" pubdate data-updated="true">Feb 10<span>th</span>, 2009</time>
        
           | <a href="/writings/fluent-nhibernate-auto-mapping-overrides-and-alterations/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/fluent-nhibernate-auto-mapping-overrides-and-alterations/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p><strong>Notice:</strong> This is an excerpt from the <a href='https://github.com/jagregory/fluent-nhibernate/wiki/Auto-mapping'>Auto Mapping</a> wiki page. It is recommended you refer to those pages for the latest version of this content, as this blog post will not be maintained for correctness.</p></blockquote>

<p>When using the Auto Mapping facilities of <a href="http://www.fluentnhibernate.org">Fluent NHibernate</a> you can use the <code>ForMappingsThatDeriveFrom</code> method described in <a href='https://github.com/jagregory/fluent-nhibernate/wiki/Auto-mapping'>Altering Entities</a> to override the mappings for specific entities, but that can quickly become cluttered if you&#8217;re having to alter many entities.</p>




<p>An alternative is to use an <code>IAutoMappingOverride<T></code>, which is an interface you can implement to override the mappings of a particular auto-mapped class.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">PersonMappingOverride</span> <span class="p">:</span> <span class="n">IAutoMappingOverride</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Override</span><span class="p">(</span><span class="n">AutoMap</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">mapping</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>This example overrides the auto-mapping of a <code>Person</code> entity. Within the <code>Override</code> method you can perform any actions on the mapping that you can in the <a href='https://github.com/jagregory/fluent-nhibernate/wiki/Fluent-mapping'>Fluent Mappings</a>.</p>




<p>To use overrides, you need to instruct your <code>AutoPersistenceModel</code> instance to use them. Typically this would be done in the context of a <a href='https://github.com/jagregory/fluent-nhibernate/wiki/Fluent-configuration'>Fluent Configuration</a> setup, but I&#8217;ll just illustrate with the <code>AutoPersistenceModel</code> on it&#8217;s own.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">AutoPersistenceModel</span><span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="s">&quot;Entities&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">UseOverridesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">PersonMappingOverride</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>




<p>It&#8217;s the <code>UserOverridesFromAssemblyOf<T></code> call that instructs the <code>AutoPersistenceModel</code> to read any overrides that reside the assembly that contains <code>T</code>.</p>




<p>These overrides are made possible with use of the configuration alteration capabilities of the <code>AutoPersistenceModel</code>. You can use these features yourself to create your own customisations, or simply to separate your configuration into logical sections.</p>




<p>An alteration is an implementation of the <code>IAutoMappingAlteration</code> interface, and is a self contained piece of configuration logic that can be applied with others to an <code>AutoPersistenceModel</code> prior to any mappings being generated. These are simple to use, but very powerful.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">WhereAlteration</span> <span class="p">:</span> <span class="n">IAutoMappingAlteration</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Alter</span><span class="p">(</span><span class="n">AutoPersistenceModel</span> <span class="n">model</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">model</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">type</span> <span class="p">=&gt;</span> <span class="n">IsMappable</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="kt">bool</span> <span class="nf">IsMappable</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// some logic</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>The <code>Alter(AutoPersistenceModel model)</code> method is where you place your logic for altering the model, you can do anything in here you like. The overrides functionality, for example, inspects an assembly looking for any <code>IMappingOverride<T></code> instances and executes each one against the model.</p>




<p>You need to instruct your <code>AutoPersistenceModel</code> to use any alterations you may have, and you do that using the <code>WithAlterations</code> method. Typically this would be done in the context of a FluentConfiguration setup, but I&#8217;ll just illustrate with the <code>AutoPersistenceModel</code> on it&#8217;s own.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">AutoPersistenceModel</span><span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">WithAlterations</span><span class="p">(</span><span class="n">alterations</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">alterations</span><span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">WhereAlteration</span><span class="p">&gt;());</span>
</span></code></pre></td></tr></table></div></figure>




<p>The <code>WithAlterations</code> method takes a lambda action that allows you to set multiple alterations on your model; you can add single alterations with <code>Add</code>, and everything from an assembly like the above example.</p>




<p>Before your mappings are generated, the alterations are all run against the <code>AutoPersistenceModel</code>. There&#8217;s currently no ordering of alterations, so you cannot rely on the ability to stack alterations.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/fluent-nhibernate-the-official-website/">Fluent NHibernate - the Official Website</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-04T00:00:00+11:00" pubdate data-updated="true">Feb 4<span>th</span>, 2009</time>
        
           | <a href="/writings/fluent-nhibernate-the-official-website/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/fluent-nhibernate-the-official-website/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>&#8220;Documentation? What documentation!&#8221; I hear you say. Yes, Fluent NHibernate is not best known for it&#8217;s abundance of documentation. I know.</p>




<p>I&#8217;ve realised that over the past couple of months Fluent NHibernate has been growing in popularity, stupidly so. We&#8217;ve got new features out the bjingo, an active mailing list, and a flow of people moaning on twitter. Well I figure enough is enough, we need a proper website; googlecode is great for hosting, but it&#8217;s wiki is poor, we needed something better.</p>




<p style="text-align:left"><strong>Announcing the official Fluent NHibernate website:</strong> <a href='http://www.fluentnhibernate.org'>http://fluentnhibernate.org</a> and it&#8217;s <a href='https://github.com/jagregory/fluent-nhibernate/wiki'>wiki</a>.</p>




<p>As always, comments are welcome on the <a href='http://groups.google.com/group/fluent-nhibernate'>mailing list</a>. Please, no porn on the wiki just yet.</p>




<p>I will be updating all my recent blog posts to point to the appropriate content on the wiki, and I would prefer if people would direct-link to the website rather than the googlecode project from now on. We&#8217;ll still be using googlecode for hosting and issue tracking, but the wiki will be cleared out.</p>




<p>As with any wiki, the content is not final, and not exhaustive. I&#8217;m working on it.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/fluent-green-and-brown/">Fluent Green and Brown</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-04T00:00:00+11:00" pubdate data-updated="true">Feb 4<span>th</span>, 2009</time>
        
           | <a href="/writings/fluent-green-and-brown/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/fluent-green-and-brown/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To paint a very black-and-white picture, there are two camps of applications: greenfield and brownfield. Greenfield are generally nice, they have good separation of concerns, probably an IoC container, they may even be covered by unit tests. Brownfield apps are not. They generally don&#8217;t have great separation of concerns (they&#8217;re usually pretty concerned about everything), they definitely don&#8217;t have great unit test coverage (but you&#8217;re working on it!), and they don&#8217;t have IoC containers.</p>

<p>If you&#8217;re designing a framework you need to cater for both these markets. Unfortunately, they&#8217;re both at odds with each other. A design that caters for inversion of control can sometimes be too verbose or &#8220;bitty&#8221; to use easily without a container. Similarly, if designed without a container in mind it will fall short for use with one; it&#8217;ll be too tightly nit, too hard to break apart.</p>

<p>Although when Fluent NHibernate was started it was heading towards a design for greenfield, when I took over I steered it in the direction I thought was most important - brownfield. Fluent NHibernate has been aimed at being a drop-in replacement for your traditional NHibernate setup, simply replace your <code>CreateSessionFactory</code> method with ours and you&#8217;re away. The problem is, by focussing so hard on brownfield, I&#8217;ve neglected the green.</p>

<p>I&#8217;m not apologising, because nobody has complained, but considerations need to be made for the other half. I still very much believe that Fluent NHibernate is heading in the right direction, we want to make life easier for those people who&#8217;s lives are pretty damn hard (those greenfield guys have it easy anyway); however, I do believe considerations need to be made to allow Fluent NHibernate to be more accessible for those of us who have the pleasure of working in a well designed system.</p>

<p><strong>What does the future hold for Fluent NHibernate?</strong> Supporting all of NHibernate&#8217;s mapping options, making the automapper a lot more powerful, improving testability even more, and finally&#8230; giving some love to the PersistenceModel and SessionSource that the greenfield guys need.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/fluent-nhibernate-configuring-your-application/">Fluent NHibernate: Configuring Your Application</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-03T00:00:00+11:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2009</time>
        
           | <a href="/writings/fluent-nhibernate-configuring-your-application/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/fluent-nhibernate-configuring-your-application/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p><strong>Notice:</strong> The content in this post may be out of date, please refer to the <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Fluent-configuration">Fluent Configuration</a> page in the <a href="https://github.com/jagregory/fluent-nhibernate/wiki">Fluent NHibernate Wiki</a> for the latest version.</p></blockquote>

<p>There&#8217;s been a grey area of how to actually configure your application to use <a href='http://www.fluentnhibernate.org'>Fluent NHibernate</a>, and also how to configure some more complicated situations (such as mixing fluent and non-fluent mappings). After some thought I&#8217;ve committed a change that should make things clearer. What follows is a few examples of how this new API can be used.</p>




<blockquote>
<p>I&#8217;m going to assume that you&#8217;ve got an application already set up, or you know how to structure a standard NHibernate application. If you don&#8217;t, I suggest you read up on that first.</p>
</blockquote>




<p>All the examples that follow are tailored to directly replace your <code>SessionFactory</code> instantiation code.</p>




<h2 id='introducing_the_configuration_api'>Introducing the configuration API</h2>




<p>You can now <code>Fluently.Configure</code> your application. The API is broken down into five main methods, three of which are required.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Fluently</span><span class="p">.</span><span class="n">Configure</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Database</span><span class="p">(</span><span class="cm">/* your database settings */</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="cm">/* your mappings */</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">ExposeConfiguration</span><span class="p">(</span><span class="cm">/* alter Configuration */</span><span class="p">)</span> <span class="c1">// optional</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<p>You can combine these methods in various ways to setup your application.</p>




<ol><li><code>Fluently.Configure</code> starts the configuration process</li><li><code>Database</code> is where you specify your database configuration</li><li><code>Mappings</code> is where you supply which mappings you&#8217;re using</li><li><code>ExposeConfiguration</code> is optional, but allows you to alter the raw Configuration object</li><li><code>BuildSessionFactory</code> is the final call, and it creates the NHibernate SessionFactory instance from your configuration.</li></ol>




<h2 id='exclusively_fluent'>Exclusively fluent</h2>




<p>If you&#8217;re in the situation where your application is exclusively using fluent mappings, then this is the configuration for you.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="n">Fluently</span><span class="p">.</span><span class="n">Configure</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Database</span><span class="p">(</span><span class="n">SQLiteConfiguration</span><span class="p">.</span><span class="n">Standard</span><span class="p">.</span><span class="n">InMemory</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">FluentMappings</span>
</span><span class='line'>      <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;())</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<p>This setup uses the SQLite database configuration, but you can substitute that with your own; it then adds any fluent mappings from the assebly that contains <code>YourEntity</code>.</p>




<h2 id='automappings'>Automappings</h2>




<p>If you&#8217;re using only auto mappings, then this config is for you.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="n">Fluently</span><span class="p">.</span><span class="n">Configure</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Database</span><span class="p">(</span><span class="n">SQLiteConfiguration</span><span class="p">.</span><span class="n">Standard</span><span class="p">.</span><span class="n">InMemory</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">AutoMappings</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span>
</span><span class='line'>      <span class="c1">// your automapping setup here</span>
</span><span class='line'>      <span class="n">AutoPersistenceModel</span><span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Namspace</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&quot;Entities&quot;</span><span class="p">))))</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<p>Replace the code inside <code>AutoMappings.Add</code> with your auto mapping configuration. You can see more about auto mappings in my <a href='http://blog.jagregory.com/tag/automapping/'>automapping tag</a>.</p>




<h2 id='mixed_fluent_mappings_and_auto_mappings'>Mixed fluent mappings and auto mappings</h2>




<p>If you&#8217;re using a combination of standard fluent mappings and auto mappings, then this example should show you how to get started.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="n">Fluently</span><span class="p">.</span><span class="n">Configure</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Database</span><span class="p">(</span><span class="n">SQLiteConfiguration</span><span class="p">.</span><span class="n">Standard</span><span class="p">.</span><span class="n">InMemory</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">FluentMappings</span>
</span><span class='line'>      <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">AutoMappings</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span>
</span><span class='line'>      <span class="c1">// your automapping setup here</span>
</span><span class='line'>      <span class="n">AutoPersistenceModel</span><span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Namspace</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&quot;Entities&quot;</span><span class="p">)));</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<p>You can see that this is a combination of the two previous examples, the <code>Mappings</code> method can accept multiple kinds of mappings.</p>




<h2 id='hbm_mappings'>HBM mappings</h2>




<p>You&#8217;ve not yet got around to using Fluent NHibernate fully, but you are configuring your database with it; this configuration will let you configure your database and add your traditional hbm mappings.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="n">Fluently</span><span class="p">.</span><span class="n">Configure</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Database</span><span class="p">(</span><span class="n">SQLiteConfiguration</span><span class="p">.</span><span class="n">Standard</span><span class="p">.</span><span class="n">InMemory</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">HbmMappings</span>
</span><span class='line'>      <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;())</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<p>The <code>HbmMappings</code> property allows you to add HBM XML mappings in a few different ways, this example adds everything from an assembly which defines <code>YourEntity</code>; however, you can add from an assembly instance, or just add single types.</p>




<h2 id='mixed_hbm_and_fluent_mappings'>Mixed HBM and fluent mappings</h2>




<p>You&#8217;re migrating your entities to Fluent NHibernate but haven&#8217;t quite got them all across yet - this is for you.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="n">Fluently</span><span class="p">.</span><span class="n">Configure</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Database</span><span class="p">(</span><span class="n">SQLiteConfiguration</span><span class="p">.</span><span class="n">Standard</span><span class="p">.</span><span class="n">InMemory</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">HbmMappings</span>
</span><span class='line'>      <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">FluentMappings</span>
</span><span class='line'>      <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<h2 id='the_whole_shebang_fluent_auto_and_hbm_mappings'>The whole shebang: fluent, auto, and hbm mappings</h2>




<p>You&#8217;re a crazy fool and map a bit of everything, then this is how you&#8217;d configure it.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="n">Fluently</span><span class="p">.</span><span class="n">Configure</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Database</span><span class="p">(</span><span class="n">SQLiteConfiguration</span><span class="p">.</span><span class="n">Standard</span><span class="p">.</span><span class="n">InMemory</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">HbmMappings</span>
</span><span class='line'>      <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">FluentMappings</span>
</span><span class='line'>      <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">AutoMappings</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span>
</span><span class='line'>      <span class="c1">// your automapping setup here</span>
</span><span class='line'>      <span class="n">AutoPersistenceModel</span><span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Namspace</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&quot;Entities&quot;</span><span class="p">)));</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<h3 id='exporting_hbmxml_mappings'>Exporting hbm.xml mappings</h3>




<p>In the <code>Mappings</code> call, you can do the following:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">m</span><span class="p">.</span><span class="n">FluentMappings</span>
</span><span class='line'>    <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">ExportTo</span><span class="p">(</span><span class="s">@&quot;C:\your\export\path&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">m</span><span class="p">.</span><span class="n">AutoMappings</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Add</span><span class="p">(...)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">ExportTo</span><span class="p">(</span><span class="s">@&quot;C:\your\export\path&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>




<p>That will export all of your fluent and automapped mappings in hbm.xml format to whatever location you specify.</p>




<h3 id='altering_nonautomapped_conventions'>Altering non-automapped conventions</h3>




<p>If you want to override conventions that are used by your non-automapped classes, then you can use the <code>AlterConventions</code> method on <code>FluentMappings</code>.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">Mappings</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="n">m</span><span class="p">.</span><span class="n">FluentMappings</span>
</span><span class='line'>    <span class="p">.</span><span class="n">AddFromAssemblyOf</span><span class="p">&lt;</span><span class="n">YourEntity</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">AlterConventions</span><span class="p">(</span><span class="n">conventions</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">conventions</span><span class="p">.</span><span class="n">IsBaseType</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">BaseType</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}))</span>
</span></code></pre></td></tr></table></div></figure>




<h3 id='validation'>Validation</h3>




<p>If you forget to setup your database, or don&#8217;t add any mappings, instead of pulling out your hair over obscure NHibernate exceptions, the <code>BuildSessionFactory</code> method will throw a more helpful exception to try to point you in the right direction. It&#8217;ll tell you whether you&#8217;ve forgot to add any entities, or not setup your database.</p>




<p>That&#8217;s it for now, I hope this helps to make configuring your application a little clearer.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/i-think-you-mean-a-many-to-one-sir/">I Think You Mean a Many-to-one, Sir</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-27T00:00:00+11:00" pubdate data-updated="true">Jan 27<span>th</span>, 2009</time>
        
           | <a href="/writings/i-think-you-mean-a-many-to-one-sir/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/i-think-you-mean-a-many-to-one-sir/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote>
<p>This is a question that crops up <strong>a lot</strong>, in various forms, on the <a href='http://www.fluentnhibernate.org'>Fluent NHibernate</a> and <a href='http://groups.google.com/group/nhusers'>NHibernate Users</a> mailing lists. <em>My one-to-one mapping isn&#8217;t working, what&#8217;s wrong?</em> aka Incorrectly using a one-to-one relationship when you actually need a many-to-one.</p>
</blockquote>




<p>There&#8217;s a common misunderstanding where people try to use a one-to-one relationship where a many-to-one is appropriate. I believe this is because people tend to get tunnel vision when designing their entities, which leads them to make incorrect assumptions. They focus on one entity at a time, and when that has a single entity related to it, they jump to the conclusion it&#8217;s a one-to-one they need; after all, there&#8217;s their current entity (one) and the related entity (to-one). They&#8217;re actually forgetting that there can be multiple instances of their <em>current entity</em>.</p>




<p>There&#8217;s also a big distinction between what&#8217;s possible in the domain, and what&#8217;s possible by design in the database; for example, two businesses may <strong>never</strong> share an address in your application, but in the database there&#8217;s nothing stopping two rows in the Business table from referencing the same address row in the database. This is logic that can be applied on-top of a database design, but there&#8217;s nothing in the underlying pattern to disallow it.</p>




<h2 id='manytoone'>Many-to-one</h2>




<p>Lets have a look at what actually is a many-to-one. Here&#8217;s a small database schema and the related entity.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">table</span> <span class="n">Customer</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">Id</span> <span class="nb">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</span><span class='line'>  <span class="n">AddressId</span> <span class="nb">int</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">Address</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">table</span> <span class="n">Address</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">Id</span> <span class="nb">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">Number</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Street</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="n">Customer</span>
</span><span class='line'><span class="err">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nb">int</span> <span class="n">Id</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="n">string</span> <span class="n">Name</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="n">Address</span> <span class="n">Address</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>This is a standard many-to-one relationship, many <code>Customers</code> to one <code>Address</code>; the tables are linked by the <code>AddressId</code> key in the <code>Customer</code> table. You can see how people can misinterpret this as a one-to-one relationship when designing the Customer entity; the customer has one address, so it must be a one-to-one. People forget about this scenario:</p>




<table class="db-table">
  <caption>Customer</caption>
  <thead>
    <tr>
      <th>Id</th>
      <th>Name</th>
      <th>AddressId</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Plumbers</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Joiners</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Roofers</td>
      <td>1</td>
    </tr>
  </tbody>
</table>




<table class="db-table">
  <caption>Address</caption>
  <thead>
    <tr>
      <th>Id</th>
      <th>Number</th>
      <th>Street</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>23</td>
      <td>Baker St.</td>
    </tr>
    <tr>
      <td>2</td>
      <td>47</td>
      <td>Jefferson Ave.</td>
    </tr>
  </tbody>
</table>




<p>That is, the first and third customer both reference the first address.</p>




<h2 id='onetoone'>One-to-one</h2>




<p><strong>So what actually is a one-to-one relationship then?</strong> A one-to-one is a relationship between two tables that share a mutually exclusive primary key value.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">table</span> <span class="n">Customer</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">Id</span> <span class="nb">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">table</span> <span class="n">Address</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">Id</span> <span class="nb">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">Number</span> <span class="nb">int</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Street</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="n">Customer</span>
</span><span class='line'><span class="err">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nb">int</span> <span class="n">Id</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="n">string</span> <span class="n">Name</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="n">Address</span> <span class="n">Address</span> <span class="err">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="err">}</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>You can see in this design <code>Customer</code> has no direct reference to <code>Address</code>, the two tables share a primary key value; so there would be a record in <code>Customer</code> with a primary key of <code>1</code>, and a record in <code>Address</code> that also has a primary key of <code>1</code>. It&#8217;s fairly common to have the primary key on the second table (<code>Address</code> in our case) be manually inserted on creation of a record in the first, so it may only be the first table that has a true auto-incrementing primary key.</p>




<p>It&#8217;s also noticeable that both examples have exactly the same class design, this probably contributes to the confusion too, as it&#8217;s not immediately clear from the class what kind of relationship it is.</p>




<p>So just remember this: <strong>if you think you&#8217;re mapping a one-to-one, you probably aren&#8217;t!</strong> It&#8217;s pretty uncommon to find a one-to-one relationship in a properly designed schema, 90% of the time it&#8217;ll be a many-to-one you need.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/writings/introduction-to-static-reflection/">Introduction to Static Reflection</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-26T00:00:00+11:00" pubdate data-updated="true">Jan 26<span>th</span>, 2009</time>
        
           | <a href="/writings/introduction-to-static-reflection/#disqus_thread"
             data-disqus-identifier="http://www.jagregory.com/writings/introduction-to-static-reflection/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote>This post could&#8217;ve also been called &#8220;Fluent NHibernate secrets exposed!&#8221; but it sounded a bit sensationalist.</blockquote>




<p>You may have heard people mention static reflection recently, quite possibly because it&#8217;s used extensively in <a href='http://www.fluentnhibernate.org'>Fluent NHibernate</a>, <a href='http://ayende.com/projects/rhino-mocks.aspx'>Rhino Mocks</a>, and I believe <a href='http://www.lostechies.com/blogs/jimmy_bogard/'>Jimmy Bogard&#8217;s</a> new <a href='http://www.codeplex.com/AutoMapper'>AutoMapper</a> also uses it; pretty much any of the new &#8220;fluent&#8221; interfaces use some kind of static reflection.</p>




<p><strong>So what actually is static reflection?</strong> Well, it&#8217;s a statically compiled way of utilising the Reflection API.</p>




<p>Traditionally, if you wanted to use the Reflection API to interrogate your classes, you&#8217;d need to utilise strings to refer to properties and methods; this can make your design quite brittle, because you have to make sure these strings are kept up-to-date whenever you rename anything. What&#8217;s worse is that because reflection is late-bound, you aren&#8217;t aware of the problems until the code is actually executed, so this renaming could introduce hidden bugs that don&#8217;t appear until runtime. With the growing popularity of refactoring techniques, it&#8217;s becoming more important that we can use reflection without having to worry about this problem.</p>




<blockquote>
<p>It&#8217;s very true that tools like Resharper can certainly help with refactoring reflection-based code, but none of them are perfect and they only help the people that use them.</p>
</blockquote>




<p><p>In C# 3 we were introduced to lambda expressions and Linq, and with them came the <code>Func&lt;></code> and <code>Expression&lt;></code> classes; these are the key to static reflection. The <code>Func&lt;></code> set of classes allow you to use lambda expressions that return a value, while an <code>Expression&lt;></code> can be used to programatically access the contents of a delegate.</p></p>

<p><p>Combining <code>Func&lt;></code> and <code>Expression&lt;></code> can give us a very powerful way to statically retrieve <code>PropertyInfo</code> (and similar) instances from a lambda expression. For example <code>Expression&lt;Func&lt;Customer, object>></code> represents an expression that contains a delegate that returns a value (of type object), with a <code>Customer</code> parameter; I&#8217;ll illustrate:</p></p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// method to receive an expression</span>
</span><span class='line'><span class="k">public</span> <span class="n">PropertyInfo</span> <span class="n">GetProperty</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// usage</span>
</span><span class='line'><span class="n">GetProperty</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;(</span><span class="n">customer</span> <span class="p">=&gt;</span> <span class="n">customer</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><p>What this is actually doing is creating a lambda that returns a value, the value of <code>customer.Name</code> in this case. Here&#8217;s the trick, we don&#8217;t actually care about the value that&#8217;s returned! In-fact, we don&#8217;t even evaluate this expression at all.</p></p>

<p><blockquote>
<p>The reason we use <code>object</code> in the <code>Func</code> signature, rather than a more specific type, is because we want to allow <em>any</em> property to be used; however, if you were only interested in <code>string</code> properties, then you could restrict it by replacing this parameter.</p>
</blockquote></p>

<p><p>The <code>Expression</code> API itself is very in-depth, so I won&#8217;t go into the intricacies of it but here&#8217;s a very simple implementation of static reflection.</p></p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">PropertyInfo</span> <span class="n">GetProperty</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">memberExpression</span> <span class="p">=</span> <span class="n">expression</span><span class="p">.</span><span class="n">Body</span> <span class="k">as</span> <span class="n">MemberExpression</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">memberExpression</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">&quot;Not a member access.&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">memberExpression</span><span class="p">.</span><span class="n">Member</span> <span class="k">as</span> <span class="n">PropertyInfo</span><span class="p">;</span> <span class="c1">// Should account for FieldInfo too</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><p>Stepping through this code, we start by getting the body of the expression which we cast to a <code>MemberExpression</code>; this is us grabbing the <code>customer.Name</code> part of our expression. Now we can get the member itself and cast it to a <code>PropertyInfo</code>, this is the <code>Name</code> part of the expression body. That&#8217;s it! We&#8217;ve not evaluated the expression, but we&#8217;ve inspected it and retrieved the property.</p></p>

<p><blockquote>
<p>This example is for illustrative purposes, there are many different types of expressions which would be excluded by this. If you are to implement your own static reflection parser, you should cater for these other types of expressions.</p>
</blockquote></p>

<p><p>As this example shows, we&#8217;re able to use reflection without having to resort to strings. The great thing about this is that if you change the name of a member inside a lambda, you&#8217;ll get a compile error if you haven&#8217;t updated all the references! No more hidden bugs.</p></p>

<p><p>So that&#8217;s how the magic behind Fluent NHibernate (and others) works, simple when you know how!</p></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Website copyright &copy; 2014 - James Gregory |
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/TheChymera/Koenigspress">Königspress</a></span>.
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jagregory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
