
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>James Gregory</title>
    <meta name="author" content="James Gregory">

    
    <meta name="description" content="Fluent NHibernate: Auto Mapping Entity Conventions Notice: The content in this post is out of date, please refer to the Auto Mapping page in the &hellip;">
    
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

    <link href="/atom.xml" rel="alternate" title="James Gregory" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.png" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3186192-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<header class="inner"><h1 class="left"><a href="/">James Gregory</a></h1>
<nav class="menu left"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<div class="right">
	<form class="search right" action="http://google.com/search" method="get">
		<input class="left" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:www.jagregory.com">
	</form>
	<div class="social right">
		
		
		
		
		<a class="github" href="https://github.com/jagregory" title="GitHub">GitHub</a>
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</div>

</header>
	
	<div id="content" class="inner">


    <article class="post">
    <h1 class="title"><a href="/writings/fluent-nhibernate-auto-mapping-entity-conventions/">Fluent NHibernate: Auto Mapping Entity Conventions</a></h1>
    <div class="entry">
        <blockquote><p><strong>Notice:</strong> The content in this post is out of date, please refer to the <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Auto-mapping">Auto Mapping</a> page in the <a href="https://github.com/jagregory/fluent-nhibernate/wiki">Fluent NHibernate Wiki</a> for the latest version.</p></blockquote>

<p>This post should be short and sweet. We want to alter our <strong>has many</strong> relationship from <code>Shelf</code> to <code>Product</code> so that it has a cascade set on it. We don&#8217;t want this to affect all one-to-many&#8217;s in our domain, so we need to do this alteration only on the <code>Shelf</code> entity rather than with an <code>ITypeConvention</code>.</p>




<p>So how exactly do you supply conventions only for a specific entity? Easy! with <code>ForTypesThatDeriveFrom<T>(ClassMap<T>)</code>.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">autoMappings</span>
</span><span class='line'>  <span class="p">.</span><span class="n">WithConvention</span><span class="p">(</span><span class="n">convention</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// our conventions</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="n">ForTypesThatDeriveFrom</span><span class="p">&lt;</span><span class="n">Shelf</span><span class="p">&gt;(</span><span class="n">map</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">map</span><span class="p">.</span><span class="n">HasMany</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>      <span class="p">.</span><span class="n">Cascade</span><span class="p">.</span><span class="n">All</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<p>The <code>ForTypesThatDeriveFrom</code> method takes a generic parameter that&#8217;s the entity you want to customise. The parameter is an expression that allows you to alter the underlying <code>ClassMap<T></code> that is generated by the auto mapper. Anything you can do in the non-auto fluent mapping, you can do in this override. So for our case, we map a <code>HasMany</code> of <code>Product</code>, and specify it&#8217;s cascade; this overrides the <code>HasMany</code> that will have been generated by the auto mapper.</p>




<p>That&#8217;s it. We&#8217;ve overridden the auto mapping explicitly for a specific type, while not affecting the general conventions of the system. You can do this for as many types as you need in your domain; however, baring in mind readability, it may sometimes be more appropriate to map entities explicitly using the standard fluent mapping if you find yourself overriding a lot of conventions.</p>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-01-11T00:00:00+11:00" pubdate data-updated="true">Jan 11<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/fluent-nhibernate-auto-mapping-conventions/">Fluent NHibernate: Auto Mapping Conventions</a></h1>
    <div class="entry">
        <blockquote><p><strong>Notice:</strong> The content in this post is out of date, please refer to the <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Auto-mapping">Auto Mapping</a> page in the <a href="https://github.com/jagregory/fluent-nhibernate/wiki">Fluent NHibernate Wiki</a> for the latest version.</p>

<p>This is a continuation of my previous <a href="/writings/fluent-nhibernate-auto-mapping-introduction/">Auto Mapping Introduction</a> post, and is based on the same revision of <a href="http://www.fluentnhibernate.org">Fluent NHibernate</a>.</p></blockquote>

<p>Auto mappings are generated based on a set of conventions, assumptions about your environment, that mean you can map your entire domain with a miniscule amount of code. Sometimes however, the conventions we supply are not to your liking, perhaps you&#8217;re a control freak and want 100% control, or more likely you&#8217;re working against an existing database that has it&#8217;s own set of standards. You&#8217;d still like to use the auto mapper, but can&#8217;t because it maps your entities all wrong.</p>




<p>Luckily for you we&#8217;ve thought about that, you can customise the conventions that the auto mapper uses.</p>




<blockquote>
<p><strong>What exactly is mapped using conventions?</strong> As of <a href='http://code.google.com/p/fluent-nhibernate/source/detail?r=190'>r190</a>: Default lazy load, cacheability, string length, ids, key names, foreign key column names, table names, many-to-many table names, version column names, and a wealth of specific property, one-to-one, one-to-many, and many-to-many overrides.</p>

<p>Although we do allow you to customise a lot of things, not everything is covered yet. If you do encounter a scenario you can&#8217;t handle, drop us a message on the <a href='http://groups.google.com/group/fluent-nhibernate'>mailing list</a>, or even better: supply us a patch.</p>
</blockquote>




<p>We&#8217;ll continue with our store example from before, which comprised of a <code>Product</code> and a <code>Shelf</code>.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">decimal</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Shelf</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">Products</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Using the standard auto mapping conventions, this assumes a database schema like so:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">table</span> <span class="n">Product</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">Id</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Price</span> <span class="nb">decimal</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Shelf_id</span> <span class="nb">int</span> <span class="k">foreign</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">table</span> <span class="n">Shelf</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">Id</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<p>Nothing too complicated there. The auto mapper has correctly assumed that our Ids are identity&#8217;s and are primary keys, it&#8217;s also assumed their names, the name of our foreign key to the <code>Shelf</code> table (<code>ShelfId</code>), and the length of our <code>Name</code> column.</p>




<p>Lets assume for the sake of this post that you&#8217;re not happy with that schema. You&#8217;re one of those people that prefers to name their primary key after the table it&#8217;s in, so our <code>Product</code> identity should be called <code>ProductId</code>; also, you like your foreign key&#8217;s to be explicitly named _FK, and your strings are always a bit longer than <code>100</code>.</p>




<p>Remember this fellow?</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>
</span><span class='line'>  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Storefront</span><span class="p">.</span><span class="n">Entities</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;);</span>
</span></code></pre></td></tr></table></div></figure>




<p>Lets update it to include some convention overrides. We&#8217;ll start with the Id name.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>
</span><span class='line'>  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Storefront</span><span class="p">.</span><span class="n">Entities</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">WithConvention</span><span class="p">(</span><span class="n">convention</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">convention</span><span class="p">.</span><span class="n">GetPrimaryKeyNameFromType</span> <span class="p">=</span>
</span><span class='line'>      <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Id</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;;</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<p>What we did there was use the <code>WithConvention</code> method to customise the <code>Convention</code> instance that the auto mapper uses. In this case we overwrote the <code>GetPrimaryKeyNameFromType</code> function with our own lambda expression; as per our function, our primary key&#8217;s will now be generated as <code>TypeNameId</code>; which means our schema now looks like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">table</span> <span class="n">Product</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">ProductId</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Price</span> <span class="nb">decimal</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Shelf_id</span> <span class="nb">int</span> <span class="k">foreign</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">table</span> <span class="n">Shelf</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">ShelfId</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<blockquote>
<p>The convention functions are called against their respective mapping part for every generated entity, and the result of their execution is used to generate the mappings. The part that they work against is usually discernible from their name, or their parameters. <code>GetTableName</code> for example works against an entity <code>Type</code>, while <code>GetVersionColumnName</code> is called against every <code>PropertyInfo</code> gleaned from your entities. <em>As there is no API documentation (as of writing), it&#8217;s a matter of intellisense poking to find which conventions are applicable to what you want to override.</em></p>
</blockquote>




<p>As you can see, our primary key&#8217;s now have our desired naming convention. Lets do the other two together, as they&#8217;re so simple; we&#8217;ll override the foreign key naming, and change the default length for strings.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">autoMappings</span>
</span><span class='line'>  <span class="p">.</span><span class="n">WithConvention</span><span class="p">(</span><span class="n">convention</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">convention</span><span class="p">.</span><span class="n">GetPrimaryKeyNameFromType</span> <span class="p">=</span>
</span><span class='line'>      <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Id</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;;</span>
</span><span class='line'>    <span class="n">convention</span><span class="p">.</span><span class="n">GetForeignKeyNameOfParent</span> <span class="p">=</span>
</span><span class='line'>      <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="p">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">_FK</span><span class="p">&amp;</span><span class="n">quot</span><span class="p">;;</span>
</span><span class='line'>    <span class="n">convention</span><span class="p">.</span><span class="n">DefaultStringLength</span> <span class="p">=</span> <span class="m">250</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<p>That&#8217;s all there is to it, when combined with the other conventions you can customise the mappings quite heavily while only adding a few lines to your auto mapping.</p>




<p>This is our final schema:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">table</span> <span class="n">Product</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">ProductId</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Price</span> <span class="nb">decimal</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Shelf_FK</span> <span class="nb">int</span> <span class="k">foreign</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">table</span> <span class="n">Shelf</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">ShelfId</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<p>Next time: how to apply your own type conventions that apply to all properties of a specific type in your domain, and how to utilise NHibernate&#8217;s <code>IUserType</code>s.</p>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-01-11T00:00:00+11:00" pubdate data-updated="true">Jan 11<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/fluent-nhibernate-auto-mapping-introduction/">Fluent NHibernate: Auto Mapping Introduction</a></h1>
    <div class="entry">
        <blockquote><p><strong>Notice:</strong> The content in this post may be out of date, please refer to the <a href="https://github.com/jagregory/fluent-nhibernate/wiki/Auto-mapping">Auto Mapping</a> page in the <a href="https://github.com/jagregory/fluent-nhibernate/wiki">Fluent NHibernate Wiki</a> for the latest version.</p></p>

<p><strong>Note:</strong> this was written against <a href="http://code.google.com/p/fluent-nhibernate/source/detail?r=190">r190</a> of <a href="http://www.fluentnhibernate.org">Fluent NHibernate</a>, so you need to be at least at that revision to follow along.</p></p></blockquote>

<p>Fluent NHibernate has a concept called Auto Mapping, which is a mechanism for automatically mapping all your entities based on a set of conventions.</p>




<p>Auto mapping utilises the principal of <a href="http://en.wikipedia.org/wiki/Convention_over_Configuration">convention over configuration</a>. Using this principal, the auto mapper inspects your entities and makes assumptions of what particular properties should be. Perhaps you have a property with the name of <code>Id</code> and type of <code>int</code>, the auto mapping might (and will by default) decide that this is an auto-incrementing primary key.</p>




<p>By using the auto mappings, you can map your entire domain with very little code, and certainly no XML. There are still scenarios where it may not be suitable to use the auto mapping, at which point it would be more appropriate to use the standard mapping; however, for most greenfield applications (and quite a few brownfield ones too) auto mapping will be more than capable.</p>




<h2>Getting started with a simple example</h2>




<p>Although it isn&#8217;t the purpose of this post give an in-depth walkthrough of Auto Mapping, it&#8217;s not out of scope for a simple example! So I&#8217;ll go through how to map a simple domain using the Fluent NHibernate AutoMapper.</p>




<p>Imagine what the entities might be like for a simple shop; in-fact, let me show you.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">decimal</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Shelf</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">Products</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>You can&#8217;t get much simpler than that. We&#8217;ve got a product, with an auto-incrementing primary key called <code>Id</code>, a <code>Name</code> and a <code>Price</code>. The store has some shelves it fills with products, so there&#8217;s a <code>Shelf</code> entity, which has an <code>Id</code> again, and a list of the <code>Product</code>s on it; the <code>Product</code> collection is a <em>one-to-many</em> or <em>Has Many</em> relationship to the <code>Product</code>.</p>


<blockquote><p>I&#8217;m going to make the assumption here that you have <em>an existing NHibernate infrastructure</em>, if you don&#8217;t then it&#8217;s best you consult a general NHibernate walkthrough before continuing.</p>

<p>Unless otherwise specified, any code samples are assumed to be placed with your NHibernate <code>SessionFactory</code> initialisation code.</p></blockquote>

<p>We&#8217;re going to be using the <code>AutoPersistenceModel</code> to do our mapping. To begin with we should take a look at the static <code>MapEntitiesFromAssemblyOf<T></code> method; this method takes a generic type parameter from which we determine which assembly to look in for mappable entities.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">AutoPersistenceModel</span><span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>




<p>That&#8217;s it, you&#8217;ve mapped your domain&#8230; Ok, there might be a <em>little</em> bit more to do than that. Let me explain.</p>




<p>The <code>MapEntitiesFromAssemblyOf<T></code> method creates an instance of an <code>AutoPersistenceModel</code> that&#8217;s tied to the assembly that <code>Product</code> is declared. No mappings are actually generated until you come to  your entities into NHibernate.</p>




<p>A typical NHibernate setup looks something like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">AddProperty</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">,</span> <span class="n">ApplicationConnectionString</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">AddAssembly</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Product</span><span class="p">).</span><span class="n">Assembly</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<p>What we need to do is get our auto mappings in the middle of that.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>
</span><span class='line'>  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">AddProperty</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">,</span> <span class="n">ApplicationConnectionString</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">AddAutoMappings</span><span class="p">(</span><span class="n">autoMappings</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<p>Notice the substitution of <code>AddAssembly</code> for <code>AddAutoMappings</code>. This allows us to stop NHibernate from looking for <code>hbm.xml</code> files, and use our auto mapped entities instead.</p>


<blockquote><p>If you&#8217;re dealing with an existing system, it might not be feasible to completely replace your existing entities with auto mapped ones; in this scenario, you can leave the <code>AddAssembly</code> call in there, and Fluent NHibernate will quite happily work with existing mappings.</p></blockquote>

<p>We&#8217;re now capable of getting NHibernate to accept our auto mapped entities, there&#8217;s just one more thing we need to deal with. The auto mapper doesn&#8217;t know which classes are your entities, and which ones are your services (and everything else). The setup we&#8217;re using above simply maps every class in your assembly as an entity, which isn&#8217;t going to be very useful; so I&#8217;ll introduce one final method: <code>Where(Func<Type, bool>)</code>.</p>




<p>The <code>Where</code> method takes a lambda expression which is used to limit types based on your own criteria. The most common usage is limiting based on a namespace, but you could also look at the type name, or anything else exposed on the <code>Type</code> object.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>
</span><span class='line'>  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="s">&quot;Storefront.Entities&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<p>Bringing all that together leaves us with this NHibernate setup:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">autoMappings</span> <span class="p">=</span> <span class="n">AutoPersistenceModel</span>
</span><span class='line'>  <span class="p">.</span><span class="n">MapEntitiesFromAssemblyOf</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Namespace</span> <span class="p">==</span> <span class="s">&quot;Storefront.Entities&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">var</span> <span class="n">sessionFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">AddProperty</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">,</span> <span class="n">ApplicationConnectionString</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">AddAutoMappings</span><span class="p">(</span><span class="n">autoMappings</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">BuildSessionFactory</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<p>That&#8217;s all there is to automatically mapping your domain entities. It&#8217;s all a lot easier than writing out mappings, isn&#8217;t it? There&#8217;s much more to the auto mapping that I haven&#8217;t covered here, and I hope to write about those soon. Until then, enjoy!</p>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-01-10T00:00:00+11:00" pubdate data-updated="true">Jan 10<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/the-vb-oss-debarkle/">The VB OSS Debarkle</a></h1>
    <div class="entry">
        Following a discussion last night between myself, several others, and Roy Osherove, which Jeremy Miller <a href="http://codebetter.com/blogs/jeremy.miller/archive/2009/01/07/a-challenge-to-the-vb-net-community-at-large-on-oss.aspx">also commented on</a>.

The problem was incorrectly stated. There isn&#8217;t a lack of OSS projects that VB programmers can use, there&#8217;s a wealth of projects out there. <em>I&#8217;ve personally used IoC containers, ORM tools, unit testing tools, and build automation tools in VB with my most recent employer.</em> The issue is that more recent projects are using some language features of C# that the VB team hasn&#8217;t chose to implement. This has got Roy all up in arms because he feels that should be our problem (as the OSS developers).

<blockquote><p><strong>On a side note</strong>, it was also mentioned that there are few VB OSS developers because they don&#8217;t have anything to cut their teeth on. Chicken and the egg, no VB OSS projects means no VB OSS developers.</p><p>The fact that there are plenty of OSS projects out there that VBers can use kinda makes the argument that VB developers don&#8217;t contribute to OSS because they don&#8217;t have anything to start with redundant; the whole chicken and the egg argument is flawed because OSS is already out there. It has been out there for years and yet there are still precious little contributions from VB developers.</p></blockquote>

I think it all stems from a funny situation we&#8217;ve got ourselves into, one of unfounded expectations. C# and VB have always been pretty much the same language, just with different syntax. Everything you could do in C# you could do in VB. That&#8217;s no longer the case from .Net 3.5 onwards; however, it was only ever the case by coincidence due to their base in the CLI. If the CLI was never involved, they&#8217;d never have travelled the same path. When you take a step back and look at them for what they are, two completely distinct languages, this expectation for crossover appears less reasonable. I wouldn&#8217;t expect a Ruby developer to complain that they can&#8217;t use my C# project, so why should a VBer complain? VB is just as different a language as Ruby is to C#.

<ul>
  <li>If you want a framework for Ruby, you&#8217;d pick a Ruby framework.</li>
  <li>If you want a framework for C#, you&#8217;d pick a C# framework.</li>
  <li>So why if you want a framework for VB, do you pick a C# framework?</li>
</ul>

<blockquote><p>Regarding the conversation&#8230;<p>
<p><strong>To those VB developers who responded with conspiracy:</strong> there is no conspiracy. Nobody is developing with C# out of spite, we do it because it&#8217;s our preferred language; nobody would accuse you of being spiteful if you chose to develop in VB, so don&#8217;t accuse us of doing it.</p>

<p><strong>To those VB developers that think we choose C# because it&#8217;s the &#8220;flavour of the week&#8221; </strong>versus the old workhorse of VB: that just shows how far behind you really are; if you genuinely believe the C# developers think it is en-vogue, then you&#8217;re sorely mistaken. I don&#8217;t think I know any C# developers that actually think C# is really awesome, just that it&#8217;s their preferred of the two .Net languages.</p></blockquote>

I can&#8217;t believe I fell for a C# vs. VB argument.

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-01-08T00:00:00+11:00" pubdate data-updated="true">Jan 8<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/fluent-nhibernate-subclass-syntax-changes/">Fluent NHibernate SubClass Syntax Changes</a></h1>
    <div class="entry">
        <p>I&#8217;ve just committed a breaking change to <a href="http://www.fluentnhibernate.org">Fluent NHibernate</a> (as of <a href="http://code.google.com/p/fluent-nhibernate/source/detail?r=184" title="Revision 184">r184</a>), which I thought I&#8217;d document here for anyone interested; it&#8217;s a reworking of the subclass syntax.</p>




<p>Mapping multiple subclasses with the same parent wasn&#8217;t a very fluent affair, and it was pretty <em>wordy</em> too. You can see a comparison of the old and new syntaxes below.</p>




<h4>Before</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">discriminator</span> <span class="p">=</span> <span class="n">DiscriminateSubClassesOnColumn</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">&quot;Type&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">discriminator</span><span class="p">.</span><span class="n">SubClass</span><span class="p">&lt;</span><span class="n">B</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">IdentifiedBy</span><span class="p">(</span><span class="s">&quot;bID&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">MapSubClassColumns</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">BProperty</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="n">discriminator</span><span class="p">.</span><span class="n">SubClass</span><span class="p">&lt;</span><span class="n">C</span><span class="p">&gt;()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">IdentifiedBy</span><span class="p">(</span><span class="s">&quot;cID&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">MapSubClassColumns</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CProperty</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<h4>After</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">DiscriminateSubClassesOnColumn</span><span class="p">(</span><span class="s">&quot;Type&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">SubClass</span><span class="p">&lt;</span><span class="n">B</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">BProperty</span><span class="p">);</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="n">SubClass</span><span class="p">&lt;</span><span class="n">C</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CProperty</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<p>Much nicer! The changes you can see here are:</p>




<ul>
  <li><code>DiscriminateSubClassesOnColumn</code> now assumes your discriminator is a <code>string</code> if you don&#8217;t specify a type</li>
  <li><code>SubClass</code> defaults to using the subclass type name as a discriminator value</li>
  <li><code>IdentifiedBy</code> and <code>MapSubClassColumns</code> are now merged into <code>SubClass</code> as overloads.</li>
</ul>




<p>Nested subclasses were never really supported in Fluent NHibernate, but they were <em>hackable</em>. You could abuse <code>DiscriminateSubClassesOnColumn</code> to let you trick it into creating nested classes. This worked but it led to some really ugly mapping code (and a nasty hack in the Fluent NHibernate codebase). I&#8217;ve given some loving to this area and have managed to really sweeten-up the syntax.</p>




<h4>Before</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">DiscriminateSubClassesOnColumn</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">&quot;Type&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">SubClass</span><span class="p">&lt;</span><span class="n">B</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">IdentifiedBy</span><span class="p">(</span><span class="s">&quot;bID&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">MapSubClassColumns</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">m</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">BProperty</span><span class="p">);</span>
</span><span class='line'>      <span class="n">m</span><span class="p">.</span><span class="n">DiscriminateSubClassesOnColumn</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">&quot;Type&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SubClass</span><span class="p">&lt;</span><span class="n">C</span><span class="p">&gt;()</span>
</span><span class='line'>          <span class="p">.</span><span class="n">IdentifiedBy</span><span class="p">(</span><span class="s">&quot;cID&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="p">.</span><span class="n">MapSubClassColumns</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="n">m</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CProperty</span><span class="p">);</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<h4>After</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">DiscriminateSubClassesOnColumn</span><span class="p">(</span><span class="s">&quot;Type&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">SubClass</span><span class="p">&lt;</span><span class="n">B</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">BProperty</span><span class="p">);</span>
</span><span class='line'>    <span class="n">m</span><span class="p">.</span><span class="n">SubClass</span><span class="p">&lt;</span><span class="n">C</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">m</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CProperty</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<p>The changes in this one are:</p>


<ul>
  <li><code>SubClass</code> can now be used within subclasses without having to reuse <code>DiscriminateSubClassesOnColumn</code></li>
</ul>




<p>All in all, these changes serve to make mapping subclasses in Fluent NHibernate a little bit neater.</p>




<h2>Update</h2>


<p>As requested, here are the domain entites that the above mappings represent.</p>




<h4>Two subclasses with shared parent</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">A</span>
</span><span class='line'><span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">B</span> <span class="p">:</span> <span class="n">A</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">BProperty</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">C</span> <span class="p">:</span> <span class="n">A</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">CProperty</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<h4>Subclass of a subclass</h4>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">A</span>
</span><span class='line'><span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">B</span> <span class="p">:</span> <span class="n">A</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">BProperty</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">C</span> <span class="p">:</span> <span class="n">B</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">CProperty</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2009-01-05T00:00:00+11:00" pubdate data-updated="true">Jan 5<span>th</span>, 2009</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/waiting-for-change/">Waiting for Change</a></h1>
    <div class="entry">
        <p>We&#8217;ve all been in a job where &#8220;things are going to get better&#8221;, not just yet, but very soon. Perhaps you&#8217;re finally going to get a new product to work on, or that rewrite that&#8217;s well overdue, or a new development machine, or any number of other things.</p>

<p>Assuming you&#8217;re actually bothered by the non-arrival of your desired improvement, it&#8217;s very important that you set a cut-off date for it to occur by. Not only that, you also should define what action you&#8217;re going to take when that date arrives; typically, that&#8217;d be &#8220;leave&#8221;.</p>

<p>Without a cut-off you can meander on, days turning to weeks, weeks to months, and months to years. Before you know it years have passed without any actual changes having occurred, only the constant dangling carrot of hope.</p>

<p>I&#8217;m not advocating that everyone quit their job just because they don&#8217;t get to do everything they want. This is about when you&#8217;ve done everything in your power to improve things, to instigate change, and when that still has no effect.</p>

<p>You have to know when something has become a lost cause, and when it&#8217;s time to move on.</p>

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-11-26T00:00:00+11:00" pubdate data-updated="true">Nov 26<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/a-tribute-to-subversion/">A Tribute to Subversion</a></h1>
    <div class="entry">
        <blockquote><p>Note: This is based on my personal experiences, and is not specifically &#8220;fact&#8221;. If your experiences differ, fine, but these are mine.</p></blockquote>

<p>Subversion has started receiving some more flak in certain circles, it&#8217;s no longer in-vogue, no longer cool. Distributed version control is the big thing now, Git, Mecurial, Bazaar etc. Well I&#8217;m a huge Git fan, and I&#8217;m finding myself slowly transitioning away from Subversion project by project. However, I think I need to address something.</p>

<p>Subversion radically changed how people perceive source control, certainly in the environments that I&#8217;ve introduced it into (primarily SourceSafe based). That&#8217;s no small feat, and I don&#8217;t think it should be forgotten amid all the hype around newer source control systems.</p>

<p>The attitude towards source control prior to Subversion was that of fear; it was a black box that you threw your code into at the end of every day. Nobody really understood what it does, or why it does it, and even in some cases why they&#8217;re actually doing it. This was probably down to poor user interfaces, but nobody really <em>wanted</em> to use it, they just had to. It was never made a proper part of anyone&#8217;s workflow, apart from as a part of shutting down your machine at the end of the day (hopefully you remembered to do that!).</p>

<p>Then along came Subversion (sometimes with a bit of force), with it&#8217;s good tools, it&#8217;s stable repository, and it&#8217;s ease of management. You could host it through a webserver, everybody could access it via a URL. It never corrupts itself randomly, and it doesn&#8217;t require scary maintenance work.</p>

<p>With Subversion people stopped fearing source control, in fact they started enjoying it. People started deleting old code, entire swaths of code, because they were now happy that it was always going to be available. They actually made it a primary part of their workflow; multiple commits a day, regular history lookups, blame, branches, tags, the lot.</p>

<p>Maybe Subversion isn&#8217;t cool any more, but we shouldn&#8217;t forget what it did for many shops that adopted it.</p>

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-11-12T00:00:00+11:00" pubdate data-updated="true">Nov 12<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/yayaml-yet-another-yaml-parser/">YaYAML: Yet Another YAML Parser</a></h1>
    <div class="entry">
        <p>I don&#8217;t want to make much ceremony around this, but I thought I&#8217;d mention it incase anybody else is interested.</p>

<p>As a part of a project I&#8217;m working on I needed a simple file to store some data in, and I didn&#8217;t want it to be XML (for no reason other than the verbosity). I could have used my own format, but instead I&#8217;ve gone for <a href="http://yaml.net">YAML</a>. If you&#8217;ve worked with Ruby on Rails at all, then you&#8217;ll be familiar with YAML. It&#8217;s a human readable (and writable) text format.</p>

<p>Of course, I still needed to be able to parse my YAML document. There was a project announced 2 years ago to create a .Net parser, but like many things, it seems very much abandoned. So, after my <a href="/writings/getting-started-with-ometa/">recent adventure with OMeta#</a>, I thought I&#8217;d hack on this too.</p>

<h2>Introducing YaYAML: Yet another YAML parser.</h2>

<p>Don&#8217;t get your hopes up, I&#8217;ve only implemented exactly what I needed out of the spec, which is very little indeed. However, it&#8217;s something I will carry on with when time permits. So what can you parse with YaYAML? Only documents containing a single flat sequence or mapping. <strong>No nesting, no multiple documents in a file, no variables.</strong></p>

<p>It&#8217;s possible to parse these two example files:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">a list</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">of text</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">strings</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">a</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mapping</span>
</span><span class='line'><span class="l-Scalar-Plain">of</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">various</span>
</span><span class='line'><span class="l-Scalar-Plain">key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">and</span>
</span><span class='line'><span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pairs</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">James</span>
</span><span class='line'>  <span class="l-Scalar-Plain">age</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">23</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Peter</span>
</span><span class='line'>  <span class="l-Scalar-Plain">age</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">34</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it!</p>

<p>You can find the source in my <a href="http://github.com/jagregory/yayaml">YaYAML github repository</a>.</p>

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-10-28T00:00:00+11:00" pubdate data-updated="true">Oct 28<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/getting-started-with-ometa/">Getting Started With OMeta#</a></h1>
    <div class="entry">
        <blockquote><p><strong>Notice:</strong> I&#8217;m a novice at OMeta, and as such, you shouldn&#8217;t take my advice as best-practice. This is based on my exploratory findings.</p></blockquote>

<p>String parsing is hard. I don&#8217;t think anyone will deny that. You can parse it by hand, you can use regular expressions, you can walk it character by character. With <a href="/writings/sharpdiff-diff-parsing-in-net/">SharpDiff</a>, I needed to parse some serious text, it was in an expected format, but there are numerous rules surrounding it. I did not fancy parsing it by hand, or with regular expressions.</p>

<p>I considered writing a parser for it, but dismissed that after my dealings with <a href="http://www.antlr.org">ANTLR</a> in <a href="http://www.codeplex.com/BooLangStudio">BooLangStudio</a>. It&#8217;s not so much that ANTLR is bad, it&#8217;s just long winded; it&#8217;s completely <a href="http://en.wikipedia.org/wiki/Visitor_pattern">visitor</a>tastic.</p>

<p>Anyway, after 10 minutes down the path of parsing it myself, I cracked and decided to look into alternatives to ANTLR. I came across <a href="http://www.codeplex.com/ometasharp">OMeta#</a> and (with a reassuring nudge by Jeffery Olson) I went with it.</p>

<h2>So what is OMeta#?</h2>

<p>At it&#8217;s heart, <a href="http://www.cs.ucla.edu/~awarth/ometa/">OMeta</a> is just a really great string parser, and OMeta# is a .Net implementation of it. Combine that with a fairly decent definition language and codegen&#8217;d parser creation, and you&#8217;re onto a winner.</p>

<p>It allows you to write a syntax grammar and parse content with it, without having to worry about lexing, tokenizing and all that jazz. You only need to learn one language, OMeta.</p>

<p>While working on SharpDiff, I took a detour and implemented another very simple Git diff format. It&#8217;s a stat/metrics diff that just tells you which files have changed, and how many additions and removals have occurred in each. A pretty straight forward diff crying out to be used as an example.</p>

<h2>A basic OMeta-based parser</h2>

<p>Git has a diff format called stat (and it&#8217;s counter-part numstat, that we&#8217;ll be using). It produces output like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1    0    myFile.txt
</span><span class='line'>3    1    anotherFile.txt</span></code></pre></td></tr></table></div></figure>


<blockquote><p>If you&#8217;re following along at home, you&#8217;ll need to create yourself a new git repository. In there place a couple of text files, add some content to them and commit them. Then make some changes to those files, but don&#8217;t commit that. Now you can execute <code>git --numstat</code> to get the above output.</p></blockquote>

<p>The Git documentation is a wonderful thing, and it provides us with a nice outline of the numstat output.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1    2    README
</span><span class='line'>3    1    arch/{i386 =&gt; x86}/Makefile</span></code></pre></td></tr></table></div></figure>


<p>That is, from left to right:</p>

<ul>
<li>the number of added lines;</li>
<li>a tab;</li>
<li>the number of deleted lines;</li>
<li>a tab;</li>
<li>pathname (possibly with rename/copy information);</li>
<li>a newline.</li>
</ul>


<p>Before we get to the meat, there&#8217;s a couple of things we need to do. Firstly, (at the time of writing) there are no binaries available for OMeta#, so you&#8217;ll have to download the source and compile yourself. Once you&#8217;ve done that, you need to reference the <code>OMetaSharp.dll</code> and <code>OMetaSharp.OMetaCS.dll</code>.</p>

<p>Due to OMeta codegening our parser, it really needs to be built separately to our main project. If we don&#8217;t do that, we could get ourselves in a mess when we write an invalid grammar and generate some uncompiling code from it.</p>

<p>I won&#8217;t go over how to do this, but basically wrap the following code in a separate console app, changing the paths to point to where your code actually lives.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">RebuildGitNumstatParser</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">contents</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">ReadAllText</span><span class="p">(</span><span class="s">@&quot;..\..\..\SharpDiff\Parsers\GitNumstatParser.ometacs&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">Grammars</span><span class="p">.</span><span class="n">ParseGrammarThenOptimizeThenTranslate</span>
</span><span class='line'>    <span class="p">&lt;</span><span class="n">OMetaParser</span><span class="p">,</span> <span class="n">OMetaOptimizer</span><span class="p">,</span> <span class="n">OMetaTranslator</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">(</span><span class="n">contents</span><span class="p">,</span>
</span><span class='line'>     <span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Grammar</span><span class="p">,</span>
</span><span class='line'>     <span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">OptimizeGrammar</span><span class="p">,</span>
</span><span class='line'>     <span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Trans</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">File</span><span class="p">.</span><span class="n">WriteAllText</span><span class="p">(</span><span class="s">@&quot;..\..\..\SharpDiff\Parsers\GitNumstatParser.cs&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That just gets OMeta to compile our grammar, then spit out a C# file.</p>

<p>One more thing, then we can get going. For this generation to work, we really need to give it a grammar and parser to begin with. So we&#8217;ll create an empty grammar and parser.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">using</span> <span class="nc">OMetaSharp</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ometa</span> <span class="nc">GitNumstatParser</span> <span class="o">:</span> <span class="nc">Parser</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">GitNumstatParser</span> <span class="p">:</span> <span class="n">Parser</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can begin! One of the wonderful things about OMeta# is that it can be test driven very easily, which really surprised me.</p>

<p>So lets create our first test!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Test]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ParsesNumber</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">Parse</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Number</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this test, we pass the Parse function a generic type parameter (int) which is our expected return type, then a string and an expression. The string is our input content, and the expression is the grammar rule to use for parsing.</p>

<p>I&#8217;m also using a shortcut method for parsing, which you can see below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="n">T</span> <span class="n">Parse</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">text</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">GitNumstatParser</span><span class="p">,</span> <span class="n">Rule</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;&gt;</span> <span class="n">ruleFetcher</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Grammars</span><span class="p">.</span><span class="n">ParseWith</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">ruleFetcher</span><span class="p">).</span><span class="n">As</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you run this test, it should pass. We didn&#8217;t do anything, I hear you say. That&#8217;s because we didn&#8217;t have to in this case. OMeta# comes with a few predefined rules that you can sometimes take advantage of (or override to give different meaning in your grammar). In this case, we&#8217;ve used the Number rule, which parses a string and returns an integer from it.</p>

<p>Onto the next test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Test]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ParsesAdditionsAndSubtractionValues</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">Parse</span><span class="p">&lt;</span><span class="n">FileStats</span><span class="p">&gt;(</span><span class="s">&quot;3\t8\tmyFile.txt\r\n&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Number</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Additions</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">3</span><span class="p">));</span>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Subtractions</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">8</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need a class to represent our file statistics, I&#8217;ve created one called FileStats.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">FileStats</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">FileStats</span><span class="p">(</span><span class="kt">int</span> <span class="n">additions</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subtractions</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">Additions</span> <span class="p">=</span> <span class="n">additions</span><span class="p">;</span>
</span><span class='line'>    <span class="n">Subtractions</span> <span class="p">=</span> <span class="n">subtractions</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">int</span> <span class="n">Additions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">int</span> <span class="n">Subtractions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you run this test, it will fail (and at the time of writing, fail with a nasty unhelpful OMeta exception). This is because we&#8217;re still trying to use the Number rule, so we need to create our FileStats rule.</p>

<p>Open up your ometacs file and follow along.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">using</span> <span class="nn">SharpDiff</span><span class="p">.</span><span class="nn">FileStructure</span><span class="p">.</span><span class="nc">Numstat</span><span class="o">;</span>
</span><span class='line'><span class="n">using</span> <span class="nc">OMetaSharp</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ometa</span> <span class="nc">GitNumstatParser</span> <span class="o">:</span> <span class="nc">Parser</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">FileStats</span> <span class="o">=</span> <span class="nc">Number</span><span class="o">:</span><span class="n">adds</span> <span class="sc">&#39;\t&#39;</span> <span class="nc">Number</span><span class="o">:</span><span class="n">subs</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">{</span> <span class="k">new</span> <span class="nc">FileStats</span><span class="o">(</span><span class="n">adds</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="bp">()</span><span class="o">,</span> <span class="n">subs</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="bp">()</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Right, that&#8217;s a bit of an overload, so lets go through it.</p>

<p>The line is made up from three parts:</p>

<ul>
<li>Rule name</li>
<li>Pattern to match</li>
<li>Code to produce</li>
</ul>


<p>For this line, we&#8217;re creating a rule called <code>FileStats</code>, which matches the <code>Number:adds '\t' Number:subs</code> pattern, and produces the code <code>new FileStats(adds.As<int>(), subs.As<int>())</code>.</p>

<p>Lets examine what the pattern is doing. Firstly, we&#8217;re using the Number rule that we used in our first test. The colon denotes an assignment to a variable, so we&#8217;re getting the match from the Number rule and putting that in an <code>adds</code> variable. We then match a single tab character (&#8216;\t&#8217;), and then another Number. Whitespace is ignored in the OMeta grammar, which means you can structure the file pretty much however you like.</p>

<p>Our pattern gives us two variables, adds and subs, we need to do something with them. The <code>-></code> operator designates the next curly brace surrounded region to be your desired C# code output. For this rule, we&#8217;re creating a new instance of our FileStats class, and passing our two variables into the constructor (converting them to ints at the same time).</p>

<p>At this point, run your side executable that recreates the generated parser. You should now be able to alter your test to use the FileStats rule instead of Number, and have it pass.</p>

<p>So what can we parse now? We&#8217;re able to get the additions and subtractions from a line such as <code>1    4    myFile.txt</code>.</p>

<p>We still need to be able to get the filename back though, so onto our next test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Test]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ParsesFilename</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">Parse</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">&quot;anotherFile.txt&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Filename</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="s">&quot;anotherFile.txt&quot;</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This test won&#8217;t compile until we create our Filename rule, so off to the ometacs with us!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">using</span> <span class="nn">SharpDiff</span><span class="p">.</span><span class="nn">FileStructure</span><span class="p">.</span><span class="nc">Numstat</span><span class="o">;</span>
</span><span class='line'><span class="n">using</span> <span class="nc">OMetaSharp</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ometa</span> <span class="nc">GitNumstatParser</span> <span class="o">:</span> <span class="nc">Parser</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">FileStats</span> <span class="o">=</span> <span class="nc">Number</span><span class="o">:</span><span class="n">adds</span> <span class="sc">&#39;\t&#39;</span> <span class="nc">Number</span><span class="o">:</span><span class="n">subs</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">{</span> <span class="k">new</span> <span class="nc">FileStats</span><span class="o">(</span><span class="n">adds</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="bp">()</span><span class="o">,</span> <span class="n">subs</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="bp">()</span><span class="o">)</span> <span class="o">},</span>
</span><span class='line'>  <span class="nc">Filename</span> <span class="o">=</span> <span class="nc">LetterOrDigit</span><span class="o">+:</span><span class="n">name</span> <span class="sc">&#39;.&#39;</span> <span class="nc">LetterOrDigit</span><span class="o">+:</span><span class="n">ext</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">name</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve now got an extra rule at the end of the file, Filename. I can&#8217;t stress this enough, <strong>watch your commas</strong>; OMeta#s errors are poor, and something like that can trip you up.</p>

<p>Our new rule looks complex, but is pretty simple. It uses the built-in LetterOrDigit rule, which matches a single letter or digit. We suffix that call with a <code>+</code> which (like regex) matches one or more instances; that match is then stored in a <code>name</code> variable. Following that is a single full-stop. Finally, another LetterOrDigit+, which matches our extension. We then concatenate those strings in our C# output.</p>

<p>Again, recompile your parser. Now your test should pass. It simply matches any filename with an extension (room for improvement here!).</p>

<p>Now we can bring the two together, so we can parse a whole line. Next test!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Test]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ParsesFullFileLine</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">Parse</span><span class="p">&lt;</span><span class="n">FileStats</span><span class="p">&gt;(</span><span class="s">&quot;3\t8\tmyFile.txt\r\n&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">FileStats</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Additions</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">3</span><span class="p">));</span>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Subtractions</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">8</span><span class="p">));</span>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Filename</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="s">&quot;myFile.txt&quot;</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need to update our FileStats class so it supports the filename.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">FileStats</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">FileStats</span><span class="p">(</span><span class="kt">int</span> <span class="n">additions</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subtractions</span><span class="p">,</span> <span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">Additions</span> <span class="p">=</span> <span class="n">additions</span><span class="p">;</span>
</span><span class='line'>    <span class="n">Subtractions</span> <span class="p">=</span> <span class="n">subtractions</span><span class="p">;</span>
</span><span class='line'>    <span class="n">Filename</span> <span class="p">=</span> <span class="n">filename</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">int</span> <span class="n">Additions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">int</span> <span class="n">Subtractions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">string</span> <span class="n">Filename</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our grammar file is going to undergo a bit of refactoring too. We&#8217;re covered by tests, so why shouldn&#8217;t we? Our <code>FileStats</code> rule doesn&#8217;t really describe the whole line it should be matching. Really what we should have is a <code>LineStats</code> (that&#8217;s what our FileStats currently is) that just matches the numbers, then a FileStats that matches the numbers <strong>and</strong> the filename.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">ometa</span> <span class="nc">GitNumstatParser</span> <span class="o">:</span> <span class="nc">Parser</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">FileStats</span> <span class="o">=</span> <span class="nc">LineStats</span><span class="o">:</span><span class="n">lines</span> <span class="sc">&#39;\t&#39;</span> <span class="nc">Filename</span><span class="o">:</span><span class="n">name</span> <span class="nc">NewLine</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">{</span> <span class="k">new</span> <span class="nc">FileStats</span><span class="o">(</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="bp">()</span><span class="o">,</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="bp">()</span><span class="o">,</span>
</span><span class='line'>      <span class="n">name</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span><span class="o">)</span> <span class="o">},</span>
</span><span class='line'>  <span class="nc">LineStats</span> <span class="o">=</span> <span class="nc">Number</span><span class="o">:</span><span class="n">adds</span> <span class="sc">&#39;\t&#39;</span> <span class="nc">Number</span><span class="o">:</span><span class="n">subs</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">adds</span><span class="o">,</span> <span class="n">subs</span> <span class="o">},</span>
</span><span class='line'>  <span class="nc">Filename</span> <span class="o">=</span> <span class="nc">LetterOrDigit</span><span class="o">+:</span><span class="n">name</span> <span class="sc">&#39;.&#39;</span> <span class="nc">LetterOrDigit</span><span class="o">+:</span><span class="n">ext</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">name</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span> <span class="o">},</span>
</span><span class='line'>  <span class="nc">NewLine</span> <span class="o">=</span> <span class="sc">&#39;\r&#39;</span> <span class="sc">&#39;\n&#39;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So what we&#8217;ve done here is redo our FileStats rule as LineStats, which instead of creating an instance of the FileStats class, just returns an array of it&#8217;s two matches <code>{ adds, subs }</code>; this encapsulates that particular bit of behavior. Next we&#8217;ve created our new FileStats rule, which calls our LineStats rule and captures the matches. It then matches a single tab, and the filename using our Filename rule, followed by a NewLine; these are then combined and pushed into the constructor for our FileStats class. We&#8217;ve defined NewLine at the end, and it simply matches the \r\n characters.</p>

<p>Rebuilding and running that test should now give success. We&#8217;re now able to completely parse a diff line. Only one thing left to do, parse multiple lines together.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Test]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">CanParseMultipleLines</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">ParseList</span><span class="p">&lt;</span><span class="n">FileStats</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="s">&quot;3\t8\tfile.txt\r\n&quot;</span> <span class="p">+</span>
</span><span class='line'>    <span class="s">&quot;5\t1\tanotherFile.txt\r\n&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">FullFile</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">2</span><span class="p">));</span>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Filename</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="s">&quot;file.txt&quot;</span><span class="p">));</span>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Additions</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">3</span><span class="p">));</span>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Subtractions</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">8</span><span class="p">));</span>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Filename</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="s">&quot;anotherFile.txt&quot;</span><span class="p">));</span>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Additions</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">5</span><span class="p">));</span>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Subtractions</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">EqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our final test is a bit longer than the others, but it&#8217;s simple. We pass in some multiline input, and then assert that we have two FileStat objects, and that they&#8217;re correctly formed.</p>

<p>For this test we&#8217;re using another helper method, which returns a list of rule matches.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ParseList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">text</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">GitNumstatParser</span><span class="p">,</span> <span class="n">Rule</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;&gt;</span> <span class="n">ruleFetcher</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Grammars</span><span class="p">.</span><span class="n">ParseWith</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">ruleFetcher</span><span class="p">).</span><span class="n">ToIEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;());</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, this test will fail because we haven&#8217;t defined the FullFile rule. So again to the ometacs file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="nc">FullFile</span> <span class="o">=</span> <span class="nc">FileStats</span><span class="o">+:</span><span class="n">files</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">files</span> <span class="o">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>All we do this time is add this rule to the top, which uses the <code>+</code> operator to match multiple FileStats rules. They&#8217;re then returned as they are so we can convert them to an enumerable.</p>

<p>That&#8217;s it, recompile and run, you should now be parsing full diff outputs with ease!</p>

<p>As you can see OMeta# is pretty easy, and it&#8217;s very easy to test drive. There are a few quirks to doing it that way (such as having to create the compiled grammar before your test will run), but it&#8217;s a lot smoother than I expected. The grammars are quite simple too, and there are some shortcuts you can take which help make things easier. The SharpDiff grammar currently stands at just 49 lines, and it&#8217;s capable of parsing 90% of the standard git output, not bad!</p>

<p>I&#8217;ll just introduce you to another little bit of syntax that can make things simpler. Our Filename rule matches filenames with extensions, but it doesn&#8217;t match filenames without! That could be a problem; however, instead of creating a new rule for this, you can create multiple patterns for a rule. Each pattern will get evaluated if the one before it fails.</p>

<p>So we can update our Filename rule to the following, which tries to match a filename with an extension, and if it can&#8217;t do that, it then tries without an extension.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="nc">Filename</span> <span class="o">=</span> <span class="nc">LetterOrDigit</span><span class="o">+:</span><span class="n">name</span> <span class="sc">&#39;.&#39;</span> <span class="nc">LetterOrDigit</span><span class="o">+:</span><span class="n">ext</span>
</span><span class='line'>  <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">name</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span> <span class="o">}</span>
</span><span class='line'>         <span class="o">|</span> <span class="nc">LetterOrDigit</span><span class="o">+:</span><span class="n">name</span>
</span><span class='line'>  <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">name</span><span class="o">.</span><span class="nc">As</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span> <span class="o">},</span>
</span></code></pre></td></tr></table></div></figure>


        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-10-22T00:00:00+11:00" pubdate data-updated="true">Oct 22<span>nd</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>


    <article class="post">
    <h1 class="title"><a href="/writings/smart-indentation-for-visual-studio-extensibility-projects/">Smart Indentation for Visual Studio Extensibility Projects</a></h1>
    <div class="entry">
        <p>I said previously in my <a href="/writings/brace-matching-and-your-language-service/">Brace Matching post</a> that I want to try to document some of my findings while working on <a href="http://www.codeplex.com/BooLangStudio">BooLangStudio</a>. Well this is my second post on the subject.</p>

<p>When you&#8217;re implementing a custom language in Visual Studio, there&#8217;s a very good chance that you&#8217;re going to want to handle indentation slightly differently to the defaults. Every language has it&#8217;s own rules, after all.</p>

<p>Most of the resources I found online we&#8217;re pretty poor for how to get this working. Most people we&#8217;re pointing to overriding <code>OnCommand</code> in your derived <code>Source</code> class, or implementing some interop interface (i.e. <code>IVsLanguageLineIndent</code>). I could get none of these working. <code>OnCommand</code> never got raised, and the interfaces we&#8217;re useless.</p>

<p>I tried a few different methods for handling indentation, but none of them worked very well. I tried capturing the enter key press, but that didn&#8217;t work. Then I tried capturing alterations to the document, but those also got fired for navigating the document, so you&#8217;d press the up key and add a new line!</p>

<p>It ended up being pretty simple to implement, once I finally found the correct way to do it. I&#8217;ll cover how I did this for BooLangStudio below.</p>

<p>In your <code>LanguageService</code>, there&#8217;s a method you can override called <code>CreateViewFilter</code> which sets everything in motion.</p>

<p>Create yourself a class that derives from <code>ViewFilter</code>, and then return an instance of it from the overridden <code>CreateViewFilter</code> method in your language service.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">BooViewFilter</span> <span class="p">:</span> <span class="n">ViewFilter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">BooViewFilter</span><span class="p">(</span><span class="n">CodeWindowManager</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">IVsTextView</span> <span class="n">view</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">override</span> <span class="n">ViewFilter</span> <span class="nf">CreateViewFilter</span><span class="p">(</span><span class="n">CodeWindowManager</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">IVsTextView</span> <span class="n">newView</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nf">BooViewFilter</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">newView</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>Note:</strong> You need to make sure your project is configured to use Smart Indentation. If your project is complete enough to allow the user to customise this, then you&#8217;re fine. However, if not you can hard code this value yourself. In your language service there&#8217;s a <code>GetLanguagePreferences</code> method that returns all the preferences for your project. In that method you can set <code>languagePreferences.IndentStyle = IdentingStyle.Smart</code>, which is what I&#8217;ve done in BooLangStudio.</p></blockquote>

<p>You&#8217;ll kick yourself for how easy this is. Now override the <code>HandleSmartIndent</code> method in your derived <code>ViewFilter</code>. That&#8217;s it really, in there you can access the <code>Source</code> object and do as you wish with smart indentation.</p>

<p>Taking BooLangStudio as an example, you can see in our <a href="http://github.com/jagregory/boolangstudio/tree/443929113ca77ae3c4613691f06f043f9d8f8d77/Source/BooLangService/BooViewFilter.cs">BooViewFilter.cs</a> that I delegate the work to a <code>HandleSmartIndentAction</code>. This is to make testing easier by having as little dependencies on Visual Studio as possible.</p>

<p>The <code>Execute</code> method of our <a href="http://github.com/jagregory/boolangstudio/tree/443929113ca77ae3c4613691f06f043f9d8f8d77/Source/BooLangService/HandleSmartIndentAction.cs">HandleSmartIndentAction.cs</a> class gets the caret location and passes it to an instance of a <a href="http://github.com/jagregory/boolangstudio/tree/443929113ca77ae3c4613691f06f043f9d8f8d77/Source/BooLangService/LineIndenter.cs">LineIndenter</a> class, which determines (based on the previous line to the caret) whether the next line should be indented, or outdented.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="kt">bool</span> <span class="nf">Execute</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">view</span><span class="p">.</span><span class="n">GetCaretPos</span><span class="p">(</span><span class="k">out</span> <span class="n">line</span><span class="p">,</span> <span class="k">out</span> <span class="n">col</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">indenter</span><span class="p">.</span><span class="n">SetIndentationForNextLine</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='boo'><span class='line'><span class="k">class</span> <span class="nc">MyClass</span><span class="p">:</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">MethodName</span><span class="p">():</span> <span class="c1"># indent</span>
</span><span class='line'>    <span class="k">return</span> <span class="c1"># outdent</span>
</span></code></pre></td></tr></table></div></figure>


<p>So that&#8217;s how to implement Smart Indentation in your Visual Studio Extensibility project, and a little bit of implementation details of BooLangStudio.</p>

        
        
    </div>
    <div class="meta">
        <div class="date">








  


<time datetime="2008-10-19T00:00:00+11:00" pubdate data-updated="true">Oct 19<span>th</span>, 2008</time></div>
        <div class="tags">

</div>
        
    </div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/3/" class="prev">Prev</a>
    
    
        <a href="/blog/page/5/" class="next">Next</a>
    
    <a href="/blog/archives" class="center">Blog Archives</a>
</nav></div>
	<footer class="inner">Copyright &copy; 2012 James Gregory</footer>
	<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'jagregory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>